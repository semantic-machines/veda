# HAProxy configuration snippet for JasperServer cookie-to-query ticket forwarding
#
# JasperServer expects ticket in URL query parameter, but client sends it only
# in HttpOnly cookie for security. This config extracts ticket from cookie
# and adds it to query string ONLY for JasperServer requests.
#
# Add to /etc/haproxy/haproxy.cfg

# ============================================================================
# ADD TO frontend proxy SECTION (before default_backend):
# ============================================================================
#
#   use_backend jasperserver if { path_beg /jasperserver }
#
# ============================================================================

# ============================================================================
# ADD NEW backend jasperserver SECTION:
# ============================================================================

backend jasperserver
  # Extract ticket from cookie and add to query params
  http-request set-var(req.ticket) req.cook(ticket) if { req.cook(ticket) -m found }
  http-request set-query %[query]&ticket=%[var(req.ticket)] if { var(req.ticket) -m found } { query -m found }
  http-request set-query ticket=%[var(req.ticket)] if { var(req.ticket) -m found } !{ query -m found }

  server jasperserver8080 127.0.0.1:8080

# ============================================================================
# FULL EXAMPLE based on current /etc/haproxy/haproxy.cfg:
# ============================================================================
#
# frontend proxy
#   bind *:80
#   option httpclose
#   use_backend jasperserver if { path_beg /jasperserver }   # <-- ADD THIS
#
# backend jasperserver                                        # <-- ADD THIS SECTION
#   http-request set-var(req.ticket) req.cook(ticket) if { req.cook(ticket) -m found }
#   http-request set-query %[query]&ticket=%[var(req.ticket)] if { var(req.ticket) -m found } { query -m found }
#   http-request set-query ticket=%[var(req.ticket)] if { var(req.ticket) -m found } !{ query -m found }
#   server jasperserver8080 127.0.0.1:8080
#
# ============================================================================
