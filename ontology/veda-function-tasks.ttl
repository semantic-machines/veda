@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix v-s: <http://semantic-machines.com/veda/veda-schema/> .
@prefix v-ui: <http://semantic-machines.com/veda/veda-ui/> .
@prefix v-fs: <http://semantic-machines.com/veda/veda-function-search/> .
@prefix v-fc: <http://semantic-machines.com/veda/veda-function-create/> .
@prefix v-wf: <http://semantic-machines.com/veda/veda-workflow/> .
@prefix vdi: <http://semantic-machines.com/veda/veda-index/> .
@prefix cfg: <http://semantic-machines.com/veda/config/> .

@prefix v-ft: <http://semantic-machines.com/veda/veda-function-tasks/> .
<http://semantic-machines.com/veda/veda-function-tasks>
  rdf:type owl:Ontology ;
  rdfs:label "Veda system function 'Tasks' ontology"@en ;
  rdfs:label "Онтология функции 'Задачи' системы Веда"@ru ;
#  owl:versionInfo "0.1" ;
  v-s:loadPriority 9 ;
.

########## TASKS INDEX ###########

v-ft:UserTaskFormIndex_1
  rdf:type vdi:ClassIndex ;
  vdi:forClass v-wf:DecisionForm ;
  vdi:forProperty v-wf:to ;
  vdi:forProperty v-wf:from ;
  vdi:forProperty v-wf:onDocument ;
  vdi:inherited_index v-ft:UserTaskFormIndex_1_1 ;
.
v-ft:UserTaskFormIndex_1_1
  rdf:type vdi:ClassIndex ;
  vdi:indexed_field rdf:type ;
  vdi:indexed_field rdfs:label ;
  vdi:indexed_field v-s:occupation ;
  vdi:indexed_field v-s:employee ;
.

########## TASKS COUNTERS ###########

v-ft:TaskCounter
  rdf:type owl:Class ;
  rdfs:subClassOf v-s:SystemThing ;
  rdfs:label "Task counter"@en ;
  rdfs:label "Счетчик задач "@ru ;
.
v-ft:inboxCount
  rdf:type owl:DatatypeProperty ;
  rdfs:domain v-ft:TaskCounter ;
  rdfs:range xsd:integer ;
  rdfs:label "количество входящих"@en ;
  rdfs:label "inbox сount"@ru ;
.
v-ft:inboxWeekCount
  rdf:type owl:DatatypeProperty ;
  rdfs:domain v-ft:TaskCounter ;
  rdfs:range xsd:integer ;
  rdfs:label "количество входящих на текущую неделю"@en ;
  rdfs:label "inbox сount for current week"@ru ;
.
v-ft:outboxCount
  rdf:type owl:DatatypeProperty ;
  rdfs:domain v-ft:TaskCounter ;
  rdfs:range xsd:integer ;
  rdfs:label "количество исходящих"@en ;
  rdfs:label "outbox сount"@ru ;
.
v-ft:completedCount
  rdf:type owl:DatatypeProperty ;
  rdfs:domain v-ft:TaskCounter ;
  rdfs:range xsd:integer ;
  rdfs:label "количество выполненных"@en ;
  rdfs:label "completed сount"@ru ;
.

v-ft:Event_UpdateTaskCounter
  rdf:type v-s:Event ;
  v-s:author cfg:VedaSystem ;
  rdfs:label "Скрипт обновления счетчиков задач" ;
  v-s:triggerByType v-wf:DecisionForm ;
  v-s:runAt "V8.LowPriority" ;
  v-s:script """
/* Available variables:
 * ticket = superuser ticket
 * document = captured document
 * user_uri = user whose actions triggered event
 * prev_state = user whose actions triggered event
 * _event_id = id of the event to prevent cycles in triggers. Must be passed to every function that modifies DB.
 * parent_script_id = id of the parent script that triggered this event.
 * parent_document_id = id of the document that triggered this event.
 */
var task = document,
    task_uri = document["@"],
    to_uris = task["v-wf:to"] && task["v-wf:to"].map(function (to) {return to.data}),
    from_uris = task["v-wf:from"] && task["v-wf:from"].map(function (from) {return from.data}),
    isNew = !prev_state,
    isCompleted = !isNew && !hasValue(prev_state, "v-wf:isCompleted", {type: _Boolean, data: true}) && hasValue(task, "v-wf:isCompleted", {type: _Boolean, data: true}),
    isDeleted = !isNew && !hasValue(prev_state, "v-s:deleted", {type: _Boolean, data: true}) && hasValue(task, "v-s:deleted", {type: _Boolean, data: true});

print("************************** START **************************");

if ( !isNew && !isDeleted && !isCompleted ) { return; }

var today = new Date(),
    monday = new Date(),
    sunday = new Date();
monday.setDate(monday.getDate() - monday.getDay() + 1);
sunday.setDate(sunday.getDate() + 7 - sunday.getDay());
monday.setHours(0); monday.setMinutes(0); monday.setSeconds(0); monday.setMilliseconds(0);
sunday.setHours(23); sunday.setMinutes(59); sunday.setSeconds(59); sunday.setMilliseconds(999);
var isThisWeekTask = hasValue(task, "v-wf:dateGiven") && (monday < task["v-wf:dateGiven"][0].data && task["v-wf:dateGiven"][0].data < sunday);

print("task =", task_uri, "| from =", from_uris, "| to =", to_uris, "| isNew =", isNew, "| isDeleted =", isDeleted, "| isCompleted =", isCompleted, "| isThisWeekTask =", isThisWeekTask);

to_uris && to_uris.map(function (to_uri) {
  // get or create task counter
  var toCounter_uri = "d:taskCounter_" + to_uri.split(':').join('_');
  var toCounter = get_individual(ticket, toCounter_uri) || createTaskCounter(to_uri);

  var toInboxCount = toCounter["v-ft:inboxCount"][0],
      toInboxWeekCount = toCounter["v-ft:inboxWeekCount"][0],
      toOutboxCount = toCounter["v-ft:outboxCount"][0],
      toCompletedCount = toCounter["v-ft:completedCount"][0];
  switch (true) {
    case isNew:
      toInboxCount.data++;
      if (isThisWeekTask) {
        toInboxWeekCount.data++;
      }
      break;
    case isCompleted:
      toInboxCount.data--;
      toCompletedCount.data++;
      if (isThisWeekTask) {
        toInboxWeekCount.data--;
      }
      break;
    case isDeleted:
      toInboxCount.data--;
      if (isThisWeekTask) {
        toInboxWeekCount.data--;
      }
      break;
  }
  put_individual(ticket, toCounter, _event_id);
  print("toCounter updated =", JSON.stringify(toCounter));
});

from_uris && from_uris.map(function (from_uri) {
  // get or create task counter
  var fromCounter_uri = "d:taskCounter_" + from_uri.split(':').join('_');
  var fromCounter = get_individual(ticket, fromCounter_uri) || createTaskCounter(from_uri);

  var fromInboxCount = fromCounter["v-ft:inboxCount"][0],
      fromOutboxCount = fromCounter["v-ft:outboxCount"][0],
      fromCompletedCount = fromCounter["v-ft:completedCount"][0];
  switch (true) {
    case isNew:
      fromOutboxCount.data++;
      break;
    case isCompleted:
      fromOutboxCount.data--;
      break;
    case isDeleted:
      fromOutboxCount.data--;
      break;
  }
  put_individual(ticket, fromCounter, _event_id);
  print("fromCounter updated =", JSON.stringify(fromCounter));
});

print("************************** END **************************");

function createTaskCounter(owner) {
  var uri = "d:taskCounter_" + owner.split(':').join('_'),
      inbox = query(ticket, "('rdf:type' == 'v-wf:DecisionForm' && 'v-wf:isCompleted' == false && 'v-wf:to' == '" + owner + "')"),
      inboxCount = inbox[0] ? inbox.length : 0,
      outbox = query(ticket, "('rdf:type' == 'v-wf:DecisionForm' && 'v-wf:isCompleted' == false && 'v-wf:from' == '" + owner + "')"),
      outboxCount = outbox[0] ? outbox.length : 0,
      completed = query(ticket, "('rdf:type' == 'v-wf:DecisionForm' && 'v-wf:isCompleted' == true && 'v-wf:to' == '" + owner + "')"),
      completedCount = completed[0] ? completed.length : 0;

  var today = new Date(),
      monday = new Date(),
      sunday = new Date();

  monday.setDate(monday.getDate() - monday.getDay() + 1);
  sunday.setDate(sunday.getDate() + 7 - sunday.getDay());
  monday.setHours(0); monday.setMinutes(0); monday.setSeconds(0); monday.setMilliseconds(0);
  sunday.setHours(23); sunday.setMinutes(59); sunday.setSeconds(59); sunday.setMilliseconds(999);

  var inboxWeek = query(ticket, "('rdf:type' == 'v-wf:DecisionForm' && 'v-wf:isCompleted' == false && 'v-wf:to' == '" + owner + "' && 'v-wf:dateGiven' == [" + monday.toISOString() +  "," + sunday.toISOString() + "])"),
      inboxWeekCount = inboxWeek[0] ? inboxWeek.length : 0;

  var taskCounter = {
    "@": uri,
    "rdf:type": newUri('v-ft:TaskCounter'),
    "v-s:owner": newUri(owner),
    "v-ft:inboxCount": newInt(inboxCount),
    "v-ft:inboxWeekCount": newInt(inboxWeekCount),
    "v-ft:outboxCount": newInt(outboxCount),
    "v-ft:completedCount": newInt(completedCount),
    "rdfs:label": newStr("создано автоматически в обработчике v-ft:Event_UpdateTaskCounter")
  };
  put_individual(ticket, taskCounter, _event_id);
  if (inboxCount + outboxCount + completedCount + inboxWeekCount) {
    print(
      "Calculated counters:", uri,
      "| inbox =", JSON.stringify(inbox), "| inboxCount =", inboxCount,
      "| outbox =", JSON.stringify(outbox), "| outboxCount =", outboxCount,
      "| completed =", JSON.stringify(completed), "| completedCount =", completedCount,
      "| inboxWeek =", JSON.stringify(inboxWeek), "| inboxWeekCount =", inboxWeekCount
    );
  }
  return taskCounter;
}
  """ ;
.

v-ft:Event_UpdateAllTaskCounters
  rdf:type v-s:Event ;
  v-s:author cfg:VedaSystem ;
  rdfs:label "Еженедельный скрипт обновления счетчиков задач для всех должностей и назначений" ;
  v-s:triggerByUid cfg:weekly ;
  v-s:runAt "V8.LowPriority" ;
  v-s:deleted true ;
  v-s:script """
/* Available variables:
 * ticket = superuser ticket
 * document = captured document
 * user_uri = user whose actions triggered event
 * prev_state = user whose actions triggered event
 * _event_id = id of the event to prevent cycles in triggers. Must be passed to every function that modifies DB.
 * parent_script_id = id of the parent script that triggered this event.
 * parent_document_id = id of the document that triggered this event.
 */
print("************************** START **************************");

var owners = query(ticket, "'rdf:type'==='v-s:Position' || 'rdf:type'==='v-s:Person'");
print("owners count =", owners.length);

owners.forEach(createTaskCounter);

print("************************** END **************************");

function createTaskCounter(owner) {
  var uri = "d:taskCounter_" + owner.split(':').join('_'),
      inbox = query(ticket, "('rdf:type' == 'v-wf:DecisionForm' && 'v-wf:isCompleted' == false && 'v-wf:to' == '" + owner + "')"),
      inboxCount = inbox[0] ? inbox.length : 0,
      outbox = query(ticket, "('rdf:type' == 'v-wf:DecisionForm' && 'v-wf:isCompleted' == false && 'v-wf:from' == '" + owner + "')"),
      outboxCount = outbox[0] ? outbox.length : 0,
      completed = query(ticket, "('rdf:type' == 'v-wf:DecisionForm' && 'v-wf:isCompleted' == true && 'v-wf:to' == '" + owner + "')"),
      completedCount = completed[0] ? completed.length : 0;

  var today = new Date(),
      monday = new Date(),
      sunday = new Date();

  monday.setDate(monday.getDate() - monday.getDay() + 1);
  sunday.setDate(sunday.getDate() + 7 - sunday.getDay());
  monday.setHours(0); monday.setMinutes(0); monday.setSeconds(0); monday.setMilliseconds(0);
  sunday.setHours(23); sunday.setMinutes(59); sunday.setSeconds(59); sunday.setMilliseconds(999);

  var inboxWeek = query(ticket, "('rdf:type' == 'v-wf:DecisionForm' && 'v-wf:isCompleted' == false && 'v-wf:to' == '" + owner + "' && 'v-wf:dateGiven' == [" + monday.toISOString() +  "," + sunday.toISOString() + "])"),
      inboxWeekCount = inboxWeek[0] ? inboxWeek.length : 0;

  var taskCounter = {
    "@": uri,
    "rdf:type": newUri('v-ft:TaskCounter'),
    "v-s:owner": newUri(owner),
    "v-ft:inboxCount": newInt(inboxCount),
    "v-ft:inboxWeekCount": newInt(inboxWeekCount),
    "v-ft:outboxCount": newInt(outboxCount),
    "v-ft:completedCount": newInt(completedCount),
    "rdfs:label": newStr("создано автоматически в обработчике v-ft:Event_UpdateAllTaskCounters")
  };
  put_individual(ticket, taskCounter, _event_id);
  if (inboxCount + outboxCount + completedCount + inboxWeekCount) {
    print(
      "Calculated counters:", uri,
      "| inbox =", JSON.stringify(inbox), "| inboxCount =", inboxCount,
      "| outbox =", JSON.stringify(outbox), "| outboxCount =", outboxCount,
      "| completed =", JSON.stringify(completed), "| completedCount =", completedCount,
      "| inboxWeek =", JSON.stringify(inboxWeek), "| inboxWeekCount =", inboxWeekCount
    );
  }
  return taskCounter;
}
  """ ;
.

########## TASKS FUNCTION ###########

v-ft:FunctionTasks
  rdf:type owl:Class ;
  rdfs:subClassOf v-s:SystemThing ;
  rdfs:label "Function 'Tasks'"@en ;
  rdfs:label "Функция 'Задачи'"@ru ;
  v-ui:hasModel v-ft:FunctionTasksModel ;
  v-ui:hasTemplate v-ft:FunctionTasksTemplate ;
.
v-ft:query
  rdf:type owl:DatatypeProperty ;
  rdfs:domain v-ft:FunctionTasks ;
  rdfs:range xsd:string ;
.
v-ft:sortOrder
  rdf:type owl:DatatypeProperty ;
  rdfs:domain v-ft:FunctionTasks ;
  rdfs:range xsd:string ;
.
v-ft:FunctionTasksModel
  rdf:type v-ui:ClassModel ;
  rdfs:label "V-ft:FunctionTasks class template"@en ;
  rdfs:label "Шаблон для класса v-ft:FunctionTasks"@ru ;
  v-s:script """
  var q = format (
    this["v-ft:query"][0],
    veda.appointment ? veda.appointment.id : veda.user.id,
    veda.appointment ? veda.appointment["v-s:occupation"][0].id : veda.user.id
  );
  this["v-ft:query"] = [q];
  var tasks = new veda.IndividualModel();
  tasks["rdf:type"] = [ new veda.IndividualModel("v-fs:FulltextRequest") ];
  tasks["v-fs:fulltextQuery"] = this["v-ft:query"].slice(0);
  tasks["v-fs:sortOrder"] = this["v-ft:sortOrder"].slice(0);
  this.tasks = tasks;

  function format(str) {
    var args = arguments;
    return str.replace(/{([0-9]+)}/gi, function (match, position) {
      return typeof args[position] !== "undefined" ? args[position] : match ;
    });
  }
  //# sourceURL=v-ft:FunctionTasksModel
  """
.
v-ft:Inbox
  rdf:type v-ft:FunctionTasks ;
  rdfs:label "Inbox"@en ;
  rdfs:label "Входящие"@ru ;
  v-ft:query "('rdf:type' == 'v-wf:DecisionForm' && 'v-wf:isCompleted' == false ) && ('v-wf:to' == '{1}' || 'v-wf:to' == '{2}')" ;
  v-ft:sortOrder "'v-s:created' desc"^^xsd:string ;
.
v-ft:Outbox
  rdf:type v-ft:FunctionTasks ;
  rdfs:label "Outbox"@en ;
  rdfs:label "Исходящие"@ru ;
  v-ft:query "('rdf:type' == 'v-wf:DecisionForm' && 'v-wf:isCompleted' == false ) && ('v-wf:from' == '{1}' || 'v-wf:from' == '{2}')" ;
  v-ft:sortOrder "'v-s:created' desc"^^xsd:string ;
.
v-ft:Completed
  rdf:type v-ft:FunctionTasks ;
  rdfs:label "Completed"@en ;
  rdfs:label "Выполненные"@ru ;
  v-ft:query "('rdf:type' == 'v-wf:DecisionForm' && 'v-wf:isCompleted' == true ) && ('v-wf:to' == '{1}' || 'v-wf:to' == '{2}')" ;
  v-ft:sortOrder "'v-s:created' desc"^^xsd:string ;
.
v-ft:TasksNotFound
  rdf:type v-s:Bundle ;
  rdfs:label "Tasks not found"@en ;
  rdfs:label "Задачи не найдены"@ru ;
.
v-ft:FunctionTasksTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "V-ft:FunctionInbox class template"@en ;
  rdfs:label "Шаблон для класса v-ft:FunctionInbox"@ru ;
  v-ui:forClass v-ft:FunctionTasks ;
  v-ui:template """
<script>
  $("#box-tabs", template)
    .find("a")
    .filter(function () { return this.hash.substr(2) === individual.id; })
    .parent()
    .addClass("active");
  //# sourceURL=v-ft:FunctionTasksTemplate_pre
</script>
<div class="container sheet">
  <br>
  <ul id="box-tabs" class="nav nav-tabs nav-right" role="tablist">
    <li class="pull-left"><h2 class="no-margin" about="@" property="rdfs:label"></h2></li>
    <li role="presentation"><a id="refresh" href="#refresh"><i class="fa fa-refresh fa-lg"></i></a></li>
    <li role="presentation"><a href="#/v-ft:Completed" about="v-ft:Completed" property="rdfs:label"></a></li>
    <li role="presentation"><a href="#/v-ft:Outbox" about="v-ft:Outbox" property="rdfs:label"></a></li>
    <li role="presentation"><a href="#/v-ft:Inbox" about="v-ft:Inbox" property="rdfs:label"></a></li>
  </ul>
  <br>
  <table class="table table-condensed table-bordered table-striped">
    <thead>
      <tr>
        <th width="20px">#</th>
        <th width="20px"><span class="glyphicon glyphicon-search"></span></th>
        <th width="10%">
          <a id="v-wf:from" href="#" class="btn btn-xs btn-link glyphicon glyphicon-sort-by-attributes text-muted"></a>
          <span about="v-wf:from" property="rdfs:label"></span>
        </th>
        <th width="10%">
          <a id="v-wf:to" href="#" class="btn btn-xs btn-link glyphicon glyphicon-sort-by-attributes text-muted"></a>
          <span about="v-wf:to" property="rdfs:label"></span>
        </th>
        <th>
          <a id="rdfs:label" href="#" class="btn btn-xs btn-link glyphicon glyphicon-sort-by-attributes text-muted"></a>
          <span about="v-s:description" property="rdfs:label"></span>
        </th>
        <th width="40%">
          <a id="v-wf:onDocument" href="#" class="btn btn-xs btn-link glyphicon glyphicon-sort-by-attributes text-muted"></a>
          <span about="v-wf:onDocument" property="rdfs:label"></span>
        </th>
        <th width="10%">
          <a id="v-wf:dateGiven" href="#" class="btn btn-xs btn-link glyphicon glyphicon-sort-by-attributes text-muted"></a>
          <span about="v-wf:dateGiven" property="rdfs:label"></span>
        </th>
      </tr>
    </thead>
    <tbody id="tasks"></tbody>
  </table>
  <div style="display:none" class="not-found alert alert-warning" about="v-ft:TasksNotFound" property="rdfs:label"></div>
  <div class="text-center">
    <ul class="pagination" id="pager"></ul>
  </div>
</div>
<script>
  var tasks = individual.tasks;
  tasks.on("afterSearch", renderTasks);
  template.one("remove", function () {
    tasks.off("afterSearch", renderTasks);
  });

  var tmplInd = new veda.IndividualModel("v-ft:TaskTemplate");
  var tmpl = tmplInd["v-ui:template"][0].toString();
  var cnt = $("#tasks", template);
  var notFound = $(".not-found", template);
  var sorts = $("th > a", template);
  var pager = $("#pager", template);
  sorts.on("click", function (e) {
    e.preventDefault();
    var sortOrder = $(this);
    var dir = sortOrder.hasClass("glyphicon-sort-by-attributes-alt") ? " asc" : " desc";
    sortOrder.toggleClass("glyphicon-sort-by-attributes glyphicon-sort-by-attributes-alt");
    if (this.id === "v-s:description") {
      tasks["v-fs:sortOrder"] = ["'" + this.id + "_" + Object.keys(veda.user.language)[0].toLowerCase() + "'" + dir];
    } else {
      tasks["v-fs:sortOrder"] = ["'" + this.id + "'" + dir];
    }
    tasks.search();
    return false;
  });

  tasks.search();

  $("#refresh", template).click(function (e) {
    e.preventDefault();
    tasks.search();
  });

  function renderTasks(result) {
    cnt.empty();
    pager.empty();

    if (result.length) {
      notFound.hide();

      var sortBy = "", dir = "";
      if ( tasks.hasValue("v-fs:sortOrder") ) {
        var t = tasks["v-fs:sortOrder"][0].split(" ");
        sortBy = t[0]; dir = t[1];
      }

      sorts.each(function () {
        var sortOrder = $(this);
        if (sortBy.indexOf(this.id) >= 0) {
          sortOrder.removeClass("text-muted");
          if (dir === "desc") sortOrder.removeClass("glyphicon-sort-by-attributes").addClass("glyphicon-sort-by-attributes-alt");
        } else {
          sortOrder.addClass("text-muted");
        }
      });

      tasks.page = tasks.page || 0;
      if (tasks.count < tasks.page * veda.user.displayedElements) {
        tasks.page = Math.floor(tasks.count / veda.user.displayedElements) + 1 * (tasks.count % veda.user.displayedElements ? 1 : 0) - 1;
      }

      for (var result, _tmpl, i = tasks.page * veda.user.displayedElements; i < (tasks.page + 1) * veda.user.displayedElements && i < tasks.count; i++) {
        result = tasks.result[i] ? new veda.IndividualModel( tasks.result[i] ) : undefined;
        if (result) {
          if (individual.id === "v-ft:Inbox" && result.hasValue("v-wf:takenDecision") && result.isSync()) {
            tasks.result.splice(i--, 1);
            continue;
          } else {
            _tmpl = tmpl.replace("###", i+1);
            result.present(cnt, $(_tmpl));
          }
        }
      }

      // Show pager
      for (var pg = 0; pg < Math.floor(tasks.count / veda.user.displayedElements) + 1 * (tasks.count % veda.user.displayedElements ? 1 : 0); pg++) {
        var $pg = $("<li/>")
          .attr("class", pg === tasks.page ? "active" : "")
          .appendTo(pager);
        var $a = $("<a/>", {
          "text" : pg + 1,
          "click": (function (pg) {
            if (pg === tasks.page) return $.noop;
            return function (event) {
              event.preventDefault();
              tasks.page = pg;
              tasks.trigger("afterSearch", tasks.result);
            }
          })(pg),
          "href" : ""
        }).appendTo($pg);
      }
    } else {
      notFound.show();
    }
  }
  //# sourceURL=v-ft:FunctionTasksTemplate
</script>
  """ ;
.

v-ft:TaskTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Task template for table of tasks"@en ;
  rdfs:label "Шаблон задачи для таблицы задач"@ru ;
  v-ui:template """
<tr>
  <td>###</td>
  <td><a href="#/@" class="glyphicon glyphicon-search"></a></td>
  <td rel="v-wf:from" data-template="v-ui:LabelTemplate"></td>
  <td rel="v-wf:to" data-template="v-ui:LabelTemplate"></td>
  <td>
    <a href="#/@" property="rdfs:label"></a>
    <p><span property="v-s:description"></span></p>
  </td>
  <td rel="v-wf:onDocument" data-template="v-ui:ClassNameLabelTemplate"></td>
  <td property="v-wf:dateGiven"></td>
</tr>
<script>
  if ( !individual.hasValue("v-wf:read", true) ) {
    template.css("font-weight", "bold");
  }
  template.dblclick(function (e) {
    riot.route("#/" + individual.id);
    e.stopPropagation();
  });
  //# sourceURL=v-ft:TaskTemplate
</script>
  """ ;
.

v-ft:FunctionTasksIndicatorTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "V-ft:FunctionInbox indicator template"@en ;
  rdfs:label "Шаблон индикатора для v-ft:FunctionInbox"@ru ;
  v-ui:template """
<script>
  var counter_uri = "d:taskCounter_" + veda.user.id.split(":").join("_");
  $(".label", template).attr("about", counter_uri);
  template.tooltip({
    container: template,
    title: individual["rdfs:label"].join(" ")
  });
  //# sourceURL=v-ft:FunctionTasksIndicatorTemplate_pre
</script>
<a href="#/@" data-toggle="tooltip" data-trigger="hover" data-placement="bottom">
  <span class="fa fa-envelope-o fa-lg"></span> <span id="counter" class="label label-danger" property="v-ft:inboxCount">0</span>
</a>
  """ ;
.

########## STANDARD ATTRIBUTIVE SEARCH IMPELMENTATION ###########

v-ft:PSfrom_to_DecisionForm
  rdf:type v-ui:ObjectPropertySpecification ;
  rdfs:label "Спецификация свойств v-wf:to v-wf:from для класса v-wf:DecisionForm"@ru ;
  rdfs:label "v-wf:to v-wf:from properties specification for v-wf:DecisionForm class"@en ;
  v-ui:forClass v-wf:DecisionForm ;
  v-ui:forProperty v-wf:to ;
  v-ui:forProperty v-wf:from ;
  v-ui:rangeRestriction v-s:Position ;
  v-ui:maxCardinality 1 ;
.

v-ft:Inbox2
  rdf:type v-fs:AttributiveSearch ;
  rdf:type v-ft:FunctionTasks2 ;
  rdfs:label "Inbox tasks"@en ;
  rdfs:label "Входящие задачи"@ru ;
  v-fs:searchBlank v-ft:InboxBlank ;
  v-fs:searchBlankTemplate v-ft:TaskBlankTemplate ;
  v-fs:searchResultTemplate v-ft:TaskResultTemplate ;
  v-fs:sortOrder "'v-wf:dateGiven' desc" ;
  v-fs:searchOnLoad true ;
.
v-ft:InboxBlank
  rdf:type v-fc:Blank ;
  rdfs:label "Бланк входящих задач"@ru ;
  rdfs:label "Blank inbox task"@en ;
  v-fc:targetType v-wf:DecisionForm ;
  v-wf:isCompleted false ;
.

v-ft:Outbox2
  rdf:type v-fs:AttributiveSearch ;
  rdf:type v-ft:FunctionTasks2 ;
  rdfs:label "Outbox tasks"@en ;
  rdfs:label "Исходящие задачи"@ru ;
  v-fs:searchBlank v-ft:OutboxBlank ;
  v-fs:searchBlankTemplate v-ft:TaskBlankTemplate ;
  v-fs:searchResultTemplate v-ft:TaskResultTemplate ;
  v-fs:sortOrder "'v-wf:dateGiven' desc"^^xsd:string ;
  v-fs:searchOnLoad true ;
.
v-ft:OutboxBlank
  rdf:type v-fc:Blank ;
  rdfs:label "Бланк исходящих задач"@ru ;
  rdfs:label "Blank outbox task"@en ;
  v-fc:targetType v-wf:DecisionForm ;
  v-wf:isCompleted false ;
.

v-ft:Completed2
  rdf:type v-fs:AttributiveSearch ;
  rdf:type v-ft:FunctionTasks2 ;
  rdfs:label "Completed tasks"@en ;
  rdfs:label "Выполненные задачи"@ru ;
  v-fs:searchBlank v-ft:CompletedBlank ;
  v-fs:searchBlankTemplate v-ft:TaskBlankTemplate ;
  v-fs:searchResultTemplate v-ft:TaskResultTemplate ;
  v-fs:sortOrder "'v-wf:dateGiven' desc"^^xsd:string ;
  v-fs:searchOnLoad true ;
.
v-ft:CompletedBlank
  rdf:type v-fc:Blank ;
  rdfs:label "Бланк выполненных задач"@ru ;
  rdfs:label "Blank completed task"@en ;
  v-fc:targetType v-wf:DecisionForm ;
  v-wf:isCompleted true ;
.
v-ft:MyBundle
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Мои"@ru ;
  rdfs:label "My"@en ;
.
v-ft:TaskBlankTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Шаблон бланка задачи"@ru ;
  rdfs:label "Task blank template"@en ;
  v-ui:template """
<script>
  var folder = decodeURIComponent(location.hash).substr(2).split("/")[0];
  $("#folder", template).attr("about", folder);
  $("#box-tabs", template)
    .find("a")
    .filter(function () { return this.hash.substr(2) === folder; })
    .parent()
    .addClass("active");
  //# sourceURL=v-ft:TaskBlankTemplate_pre
</script>
<div>
  <br>
  <ul id="box-tabs" class="nav nav-tabs nav-right" role="tablist">
    <li class="pull-left"><h2 id="folder" class="no-margin" property="rdfs:label"></h2></li>
    <li role="presentation"><a href="#/v-ft:Completed2" about="v-ft:Completed2" property="rdfs:label"></a></li>
    <li role="presentation"><a href="#/v-ft:Outbox2" about="v-ft:Outbox2" property="rdfs:label"></a></li>
    <li role="presentation"><a href="#/v-ft:Inbox2" about="v-ft:Inbox2" property="rdfs:label"></a></li>
  </ul>
  <br>
  <div about="@" data-template="v-ft:ActorFilterTemplate"></div>
  <div class="row">
    <div class="col-md-2">
      <em about="v-wf:from" property="rdfs:label"></em>
      <veda-control property="v-wf:from.rdfs:label" data-type="string"></veda-control>
    </div>
    <div class="col-md-2">
      <em about="v-wf:to" property="rdfs:label"></em>
      <veda-control property="v-wf:to.rdfs:label" data-type="string"></veda-control>
    </div>
    <div class="col-md-3">
      <em about="v-s:description" property="rdfs:label"></em>
      <veda-control property="rdfs:label" data-type="string"></veda-control>
    </div>
    <div class="col-md-3">
      <em about="v-wf:onDocument" property="rdfs:label"></em>
      <veda-control property="v-wf:onDocument.rdfs:label" data-type="string"></veda-control>
    </div>
    <div class="col-md-2">
      <em about="v-wf:dateGiven" property="rdfs:label"></em>
      <veda-control property="v-wf:dateGiven" data-type="date"></veda-control>
      <div property="v-wf:dateGiven"></div>
    </div>
  </div>
</div>
  """ ;
.

v-ft:ActorFilterTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Шаблон фильтра актора"@ru ;
  rdfs:label "Actor filter template"@en ;
  v-ui:template """
<script>
  var folder = decodeURIComponent(location.hash).substr(2).split("/")[0];
  var actor_property = folder === "v-ft:Outbox2" ? "v-wf:from" : "v-wf:to";
  var counter_prop = folder === "v-ft:Inbox2" ? "v-ft:inboxCount" :
                     folder === "v-ft:Outbox2" ? "v-ft:outboxCount" :
                     folder === "v-ft:Completed2" ? "v-ft:completedCount" : "";

  if (!individual.hasValue(actor_property)) {
    individual[actor_property] = [veda.user];
  }

  var actors_uris = [ veda.user.id ];
  var appointments_uris = query({
    ticket: veda.ticket,
    query: "('rdf:type'==='v-s:Appointment' && 'v-s:employee'=='" + veda.user.id + "')"
  }).result;

  var appointments = get_individuals(veda.ticket, appointments_uris);
  appointments.map(function (app) { actors_uris.push( app["v-s:occupation"][0].data ); });

  actors_uris.map(function (actor_uri) {
    var counter_uri = "d:taskCounter_" + actor_uri.split(":").join("_");
    var actor_template =
      "<li " + (individual.hasValue(actor_property, actor_uri) ? "class='active'" : "") + ">" +
        "<a href='#'>" +
          "<span id='actor' about='" + actor_uri + "' property='rdfs:label'></span> " +
          "<span id='counter' about='" + counter_uri + "' class='badge' property='" + counter_prop + "'></span>" +
        "</a>" +
      "</li>";
    template.append(actor_template);

    var interval;
    var counter = new veda.IndividualModel(counter_uri);
    var previousCount = counter[counter_prop] && counter[counter_prop][0];
    counter.on(counter_prop, counterUpdateHandler);
    template.one("remove", function () {
      if (interval) {
        interval = clearInterval(interval);
      }
      counter.off(counter_prop, counterUpdateHandler);
    });
    function counterUpdateHandler(values) {
      var owner = individual[actor_property] && individual[actor_property][0];
      if ( this.hasValue("v-s:owner", owner) && values.length && values[0] >= previousCount) {
        previousCount = values[0];
        interval = setTimeout( function () {
          if (interval) {
            interval = clearInterval(interval);
          }
          individual.trigger("search");
        }, 5000);
      }
    }
  });

  template.on("click", "li a", function (e) {
    e.preventDefault();
    var $this = $(this);
    $("li", template).removeClass("active");
    $this.parent().addClass("active");
    var actor_uri = $this.children("#actor").attr("about");
    individual[actor_property] = [new veda.IndividualModel(actor_uri)];
    individual.trigger("search");
  });

  //# sourceURL=v-ft:ActorFilterTemplate_pre
</script>
<ul class="nav nav-pills" role="tablist"></ul>
  """ ;
.

v-ft:TaskResultTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "V-ft:FunctionInbox class template"@en ;
  rdfs:label "Шаблон для класса v-ft:FunctionInbox"@ru ;
  v-ui:template """
<table class="table table-condensed table-bordered table-striped">
  <thead>
    <tr>
      <th width="20px">#</th>
      <th width="20px"><span class="glyphicon glyphicon-search"></span></th>
      <th width="15%" class="orderby" data-orderby="v-wf:from"><span about="v-wf:from" property="rdfs:label"></span></th>
      <th width="15%" class="orderby" data-orderby="v-wf:to"><span about="v-wf:to" property="rdfs:label"></span></th>
      <th class="orderby" data-orderby="rdfs:label"><span about="v-s:description" property="rdfs:label"></span></th>
      <th class="orderby" data-orderby="v-wf:onDocument"><span about="v-wf:onDocument" property="rdfs:label"></span></th>
      <th width="15%" class="orderby" data-orderby="v-wf:dateGiven"><span about="v-wf:dateGiven" property="rdfs:label"></span></th>
    </tr>
  </thead>
  <tbody class="result-container">
    <tr>
      <td>###</td>
      <td><a href="#/@" class="glyphicon glyphicon-search"></a></td>
      <td rel="v-wf:from" data-template="v-ui:LabelTemplate"></td>
      <td rel="v-wf:to" data-template="v-ui:LabelTemplate"></td>
      <td><a href="#/@" property="rdfs:label"></a></td>
      <td rel="v-wf:onDocument" data-template="v-ui:ClassNameLabelTemplate"></td>
      <td property="v-wf:dateGiven"></td>
    </tr>
    <script>
      if ( !individual.hasValue("v-wf:read", true) ) {
        template.css("font-weight", "bold");
      }
      individual.on("v-wf:isCompleted", removeCompleted);
      template.one("remove", function () {
        individual.off("v-wf:isCompleted", removeCompleted);
      });
      var folder = decodeURIComponent(location.hash).substr(2).split("/")[0];
      var remove = (folder === "v-ft:Inbox2") || (folder === "v-ft:Outbox2");
      removeCompleted(individual["v-wf:isCompleted"]);
      function removeCompleted(values) {
        if (remove && values[0] === true) {
          template.remove();
        }
      }
    </script>
  </tbody>
</table>
  """ ;
.

v-ft:FunctionTasks2
  rdf:type owl:Class ;
  rdfs:subClassOf v-s:SystemThing ;
  rdfs:label "Function 'Tasks'2"@en ;
  rdfs:label "Функция 'Задачи'2"@ru ;
  v-ui:hasModel v-ft:FunctionTasks2Model ;
  v-ui:hasTemplate v-ft:FunctionTasks2Template ;
.
v-ft:FunctionTasks2Template
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "v-ft:FunctionTasks2 class template"@en ;
  rdfs:label "Шаблон для класса v-ft:FunctionTasks2"@ru ;
  v-ui:forClass v-ft:FunctionTasks2 ;
  v-ui:template """
<div class="hidden"></div>
  """
.
v-ft:FunctionTasks2Model
  rdf:type v-ui:ClassModel ;
  rdfs:label "v-ft:FunctionTasks2 class model"@en ;
  rdfs:label "Модель для класса v-ft:FunctionTasks2"@ru ;
  v-ui:forClass v-ft:FunctionTasks2 ;
  v-s:script """
  //# sourceURL=v-ft:FunctionTasks2Model
  """
.
