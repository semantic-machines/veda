@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix v-s: <http://semantic-machines.com/veda/veda-schema/> .
@prefix v-ui: <http://semantic-machines.com/veda/veda-ui/> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix cfg: <http://semantic-machines.com/veda/config/> .
@prefix v-fc: <http://semantic-machines.com/veda/veda-function-create/> .
@prefix td: <http://semantic-machines.com/veda/test-data/> .

@prefix v-fs: <http://semantic-machines.com/veda/veda-function-search/> .
<http://semantic-machines.com/veda/veda-function-search>
  rdf:type owl:Ontology ;
  rdfs:label "Онтология функции 'Поиск' системы Веда"@ru ;
  rdfs:label "Veda system function 'Search' ontology"@en ;
#  owl:versionInfo "0.2" ;
  v-s:loadPriority 9 ;
.

########## SEARCH FUNCTION ###########

v-fs:FunctionSearch
  rdf:type owl:Class ;
  rdfs:subClassOf v-s:Function ;
  rdfs:label "Функция Поиск"@ru ;
  rdfs:label "Function Search"@en ;
  v-ui:hasTemplate v-fs:SearchTemplate ;
.
v-fs:FulltextRequest
  rdf:type owl:Class ;
  rdfs:subClassOf v-s:Function ;
  rdfs:label "Полнотекстовый запрос"@ru ;
  rdfs:label "Fulltext request"@en ;
  v-ui:hasModel v-fs:FulltextRequestModel ;
  v-ui:hasTemplate v-fs:FulltextRequestTemplate ;
.
v-fs:AttributiveRequest
  rdf:type owl:Class ;
  rdfs:subClassOf v-s:Function ;
  rdfs:label "Атрибутивный запрос"@ru ;
  rdfs:label "Attributive request"@en ;
  v-ui:hasModel v-fs:AttributiveRequestModel ;
  v-ui:hasTemplate v-fs:AttributiveRequestTemplate ;
.
v-fs:Search
  rdf:type v-fs:FunctionSearch ;
  rdfs:label "Найти"@ru ;
  rdfs:label "Find"@en ;
.
v-fs:Fulltext
  rdf:type v-fs:FulltextRequest ;
  rdfs:label "Полнотекстовый поиск"@ru ;
  rdfs:label "Fulltext search"@en ;
.
v-fs:Attributive
  rdf:type v-fs:AttributiveRequest ;
  rdfs:label "Атрибутивный поиск"@ru ;
  rdfs:label "Attributive search"@en ;
.
v-fs:fulltextQuery
  rdf:type owl:DatatypeProperty ;
  rdfs:label "Запрос"@ru ;
  rdfs:label "Query"@en ;
  rdfs:domain v-fs:FulltextRequest ;
  rdfs:domain v-fs:AttributiveSearch ;
  rdfs:range xsd:string ;
.
v-fs:sortOrder
  rdf:type owl:DatatypeProperty ;
  rdfs:label "Порядок сортировки"@ru ;
  rdfs:label "Sort order"@en ;
  rdfs:domain v-fs:FulltextRequest ;
  rdfs:domain v-fs:AttributiveRequest ;
  rdfs:domain v-fs:AttributiveSearch ;
  rdfs:range xsd:string ;
.
v-fs:databases
  rdf:type owl:DatatypeProperty ;
  rdfs:label "Базы данных"@ru ;
  rdfs:label "Databases"@en ;
  rdfs:domain v-fs:FulltextRequest ;
  rdfs:domain v-fs:AttributiveRequest ;
  rdfs:range xsd:string ;
.
v-fs:reopen
  rdf:type owl:DatatypeProperty ;
  rdfs:label "Открыть заново"@ru ;
  rdfs:label "Reopen"@en ;
  rdfs:domain v-fs:FulltextRequest ;
  rdfs:domain v-fs:AttributiveRequest ;
  rdfs:range xsd:boolean ;
.
v-fs:typeToSearch
  rdf:type owl:ObjectProperty ;
  rdfs:label "Тип искомого объекта"@ru ;
  rdfs:label "Type of object to search"@en ;
  rdfs:domain v-fs:FulltextRequest ;
  rdfs:domain v-fs:AttributiveRequest ;
  rdfs:range owl:Class ;
  rdfs:range rdfs:Class ;
.
v-fs:resultTemplate
  rdf:type owl:DatatypeProperty ;
  rdfs:label "Шаблон отображения результатов"@ru ;
  rdfs:label "Result template"@en ;
  rdfs:domain v-fs:AttributiveRequest ;
  rdfs:range xsd:string ;
.
v-fs:resultTemplateRest
  rdf:type owl:DatatypeProperty ;
  rdfs:label "Шаблон отображения результатов"@ru ;
  rdfs:label "Result template"@en ;
  rdfs:domain v-fs:AttributiveRequest ;
  rdfs:range xsd:string ;
.
v-fs:TypeToSearchSpecFT
  rdf:type v-ui:ObjectPropertySpecification ;
  rdfs:label "Спецификация свойства v-fs:typeToSearch для класса v-fs:FulltextRequest"@ru ;
  rdfs:label "V-fs:typeToSearch property specification for class v-fs:FulltextRequest"@en ;
  v-ui:forClass v-fs:FulltextRequest ;
  v-ui:forProperty v-fs:typeToSearch ;
  v-ui:tooltip "Ссылка на объект класса Класс."@ru ;
  v-ui:tooltip "Link to instance of Class class"@en ;
.
v-fs:TypeToSearchSpecAT
  rdf:type v-ui:ObjectPropertySpecification ;
  rdfs:label "Спецификация свойства v-fs:typeToSearch для класса v-fs:AttributiveRequest"@ru ;
  rdfs:label "V-fs:typeToSearch property specification for class v-fs:AttributiveRequest"@en ;
  v-ui:forClass v-fs:AttributiveRequest ;
  v-ui:forProperty v-fs:typeToSearch ;
  v-ui:tooltip "Ссылка на объект класса Класс."@ru ;
  v-ui:tooltip "Link to instance of Class class"@en ;
  v-ui:maxCardinality "1"^^xsd:integer ;
.
v-fs:FulltextQuerySpec
  rdf:type v-ui:DatatypePropertySpecification ;
  rdfs:label "Спецификация свойства v-fs:fulltextQuery для класса v-fs:FulltextRequest"@ru ;
  rdfs:label "V-fs:fulltextQuery property specification for class v-fs:FulltextRequest"@en ;
  v-ui:forClass v-fs:FulltextRequest ;
  v-ui:forProperty v-fs:fulltextQuery ;
  v-ui:maxCardinality "1"^^xsd:integer ;
  v-ui:tooltip "Введите запрос"@ru ;
  v-ui:tooltip "Enter query"@en ;
.
v-fs:LabelSpec
  rdf:type v-ui:DatatypePropertySpecification ;
  rdfs:label "Спецификация свойства rdfs:label для классов v-fs:FulltextRequest, v-fs:AttributiveRequest"@ru ;
  rdfs:label "Rdfs:label property specification for class v-fs:FulltextRequest, v-fs:AttributiveRequest"@en ;
  v-ui:forClass v-fs:FulltextRequest ;
  v-ui:forClass v-fs:AttributiveRequest ;
  v-ui:forProperty rdfs:label ;
  v-ui:tooltip "Обязательно. Строка произвольной длины."@ru ;
  v-ui:tooltip "Mandatory. Arbitrary length string."@en ;
  v-ui:maxCardinality "1"^^xsd:integer ;
  v-ui:minCardinality "1"^^xsd:integer ;
.
v-fs:RequestMgmt
  rdf:type v-s:Bundle ;
  rdfs:label "Запомнить"@ru ;
  rdfs:label "Remember"@en ;
.
v-fs:SavedRequests
  rdf:type v-s:Bundle ;
  rdfs:label "Сохраненные запросы"@ru ;
  rdfs:label "Saved requests"@en ;
.
v-fs:FulltextBundle
  rdf:type v-s:Bundle ;
  rdfs:label "Полнотекстовый"@ru ;
  rdfs:label "Fulltext"@en ;
.
v-fs:AttributiveBundle
  rdf:type v-s:Bundle ;
  rdfs:label "Атрибутивный"@ru ;
  rdfs:label "Attributive"@en ;
.
v-fs:Request
  rdf:type v-s:Bundle ;
  rdfs:label "Запрос"@ru ;
  rdfs:label "Request"@en ;
.
v-fs:EnterQuery
  rdf:type v-s:Bundle ;
  rdfs:label "Введите запрос"@ru ;
  rdfs:label "Enter query"@en ;
.
v-fs:ChooseType
  rdf:type v-s:Bundle ;
  rdfs:label "Выберите тип объекта"@ru ;
  rdfs:label "Choose type to search"@en ;
.
v-fs:Params
  rdf:type v-s:Bundle ;
  rdfs:label "Что ищем?"@ru ;
  rdfs:label "What we search for?"@en ;
.
v-fs:Find
  rdf:type v-s:Bundle ;
  rdfs:label "Найти"@ru ;
  rdfs:label "Find"@en ;
.
v-fs:Excel
  rdf:type v-s:Bundle ;
  rdfs:label "Excel"@ru ;
  rdfs:label "Excel"@en ;
.
v-fs:FilesRegistry
  rdf:type v-s:Bundle ;
  rdfs:label "Реестр с файлами"@ru ;
  rdfs:label "Registry with files"@en ;
.
v-fs:SetColumns
  rdf:type v-s:Bundle ;
  rdfs:label "Настроить столбцы"@ru ;
  rdfs:label "Set columns"@en ;
.
v-fs:Results
  rdf:type v-s:Bundle ;
  rdfs:label "Результаты"@ru ;
  rdfs:label "Results"@en ;
.
v-fs:Empty
  rdf:type v-s:Bundle ;
  rdfs:label "Пусто!"@ru ;
  rdfs:label "Empty!"@en ;
.
v-fs:NothingFound
  rdf:type v-s:Bundle ;
  rdfs:label "По Вашему запросу ничего не найдено. Пожалуйста, уточните запрос."@ru ;
  rdfs:label "Nothing found for your request. Please refine the query."@en ;
.
v-fs:MoreResults
  rdf:type v-s:Bundle ;
  rdfs:label "Еще результаты"@ru ;
  rdfs:label "More results"@en ;
.
v-fs:AllResults
  rdf:type v-s:Bundle ;
  rdfs:label "Загрузить все"@ru ;
  rdfs:label "Load all"@en ;
.
v-fs:NoMoreResults
  rdf:type v-s:Bundle ;
  rdfs:label "Все результаты загружены"@ru ;
  rdfs:label "All results loaded"@en ;
.
v-fs:SetResultsTable
  rdf:type v-s:Bundle ;
  rdfs:label "Настройте таблицу отображения результатов"@ru ;
  rdfs:label "Set results table"@en ;
.
v-fs:GenericTable
  rdf:type v-s:Bundle ;
  rdfs:label "Таблица по-умолчанию"@ru ;
  rdfs:label "Generic table"@en ;
.
v-fs:CustomTable
  rdf:type v-s:Bundle ;
  rdfs:label "Таблица для отображения"@ru ;
  rdfs:label "Custom table"@en ;
.
v-fs:DragColumns
  rdf:type v-s:Bundle ;
  rdfs:label "Перетащите столбцы из таблицы по-умолчанию."@ru ;
  rdfs:label "Drag columns from generic table"@en ;
.
v-fs:SearchTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Шаблон класса поиск"@ru ;
  rdfs:label "Search class template"@en ;
  v-ui:forClass v-fs:FunctionSearch ;
  v-ui:template """
  <div class="container sheet">
    <h3 about="v-fs:Find" property="rdfs:label"></h3>
    <hr>
    <div class="row">
      <div class="col-md-2 col-sm-3">
        <h4></h4>
        <ul class="nav nav-pills nav-stacked" role="tablist" id="req-tabs">
          <li role="presentation" class="active"><a href="#fulltext-search" about="v-fs:FulltextBundle" property="rdfs:label" aria-controls="fulltext-search" role="tab" data-toggle="tab"></a></li>
          <li role="presentation"><a href="#attributive-search" about="v-fs:AttributiveBundle" property="rdfs:label" aria-controls="attributive-search" role="tab" data-toggle="tab"></a></li>
        </ul>
        <hr>
        <h4 about="v-fs:SavedRequests" property="rdfs:label"></h4>
        <ol id="saved"></ol>
      </div>
      <div class="col-md-10 col-sm-9" style="border-left: 1px solid gainsboro;">
        <div class="tab-content">
          <div role="tabpanel" class="tab-pane active" id="fulltext-search"></div>
          <div role="tabpanel" class="tab-pane" id="attributive-search"></div>
        </div>
      </div>
    </div>
  </div>
  <script>
    var self = individual,
      ftHolder = $("#fulltext-search", template),
      attrHolder = $("#attributive-search", template);
    if (!self.ftRequest) {
      self.ftRequest = new veda.IndividualModel();
      self.ftRequest["rdf:type"] = [ new veda.IndividualModel("v-fs:FulltextRequest") ];
    }
    self.ftRequest.present(ftHolder, undefined, "edit");

    if (!self.attrRequest) {
      self.attrRequest = new veda.IndividualModel();
      self.attrRequest["rdf:type"] = [ new veda.IndividualModel("v-fs:AttributiveRequest") ];
    }
    self.attrRequest.present(attrHolder, undefined, "edit");

    $("#req-tabs a", template).click(function (e) {
      e.preventDefault();
      if ($(this).attr("href") === "#fulltext-search") {
        individual.reqType = "fulltext";
      } else {
        individual.reqType = "attributive";
      }
    });

    if (individual.reqType === "attributive") {
      $("#req-tabs a[href='#attributive-search']", template).tab("show");
      individual.reqType = "attributive";
    } else {
      $("#req-tabs a[href='#fulltext-search']", template).tab("show");
      individual.reqType = "fulltext";
    }

    var regsHolder = $("#saved", template),
      asp = veda.user.aspect,
      regs = asp["v-s:hasRegistry"];
    if (regs) {
      regs.map( function (reg) {
        var cont = $("<li>").appendTo(regsHolder);
        reg.present( cont, new veda.IndividualModel("v-ui:LabelBlockLinkTemplate") );
      });
    }
    //# sourceURL=v-fs:SearchTemplate
  </script>
"""
.
v-fs:FulltextRequestModel
  rdf:type v-ui:ClassModel ;
  rdfs:label "Модель класса v-fs:FulltextRequest"@ru ;
  rdfs:label "V-fs:FulltextRequest class model"@en ;
  v-ui:forClass v-fs:FulltextRequest ;
  v-s:script """
  var self = this,
    q = mkQuery(),
    sort = self.hasValue("v-fs:sortOrder")      ? self["v-fs:sortOrder"][0] : undefined,
    databases = self.hasValue("v-fs:databases") ? self["v-fs:databases"][0] : undefined,
    reopen = self.hasValue("v-fs:reopen")       ? self["v-fs:reopen"][0]    : false;

  self.on("propertyModified", function (property_uri, values) {
    switch (property_uri) {
      case "v-fs:typeToSearch":
      case "v-fs:fulltextQuery" : q = mkQuery(); break;
      case "v-fs:sortOrder"   : sort = values.length      ? values[0].toString() : undefined; break;
      case "v-fs:databases"   : databases = values.length ? values[0].toString() : undefined; break;
      case "v-fs:reopen"      : reopen = values.length    ? values[0].toString() : false; break;
    }
  });
  self.result  = [];
  self.count  = 0;
  self.selected = [];
  self.q = q;
  self.search = function (qq, ss) {
    self.trigger("beforeSearch");
    self.result = query(veda.ticket, qq ? qq : q, ss ? ss : sort, databases, reopen).result;
    self.count = self.result.length;
    self.trigger("afterSearch", self.result);
    return self.result;
  };
  // Search if query defined
  //if (q) { self.search() };

  function mkQuery () {
    var type = self.hasValue("v-fs:typeToSearch") ? "('rdf:type'=='" + self["v-fs:typeToSearch"][0].id + "')" : "";
    var q = self.hasValue("v-fs:fulltextQuery") ? "('*'=='" + self["v-fs:fulltextQuery"][0] + "')" : "";
    return [type, q].filter(function (item) { return !!item }).join(" && ");
  }
  //# sourceURL=v-fs:FulltextRequestModel
  """
.
v-fs:FulltextRequestTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Шаблон класса полнотекстовый запрос"@ru ;
  rdfs:label "Fulltext request class template"@en ;
  v-ui:forClass v-fs:FulltextRequest ;
  v-ui:template """
<div role="tabpanel" class="container sheet">
  <br>
  <!-- Nav tabs -->
  <ul class="nav nav-tabs nav-right" role="tablist">
    <li class="pull-left"><h2 class="no-margin" about="@" property="rdfs:label"></h2></li>
    <li role="presentation"><a id="refresh" href="#refresh"><i class="fa fa-refresh fa-lg"></i></a></li>
    <li role="presentation"><a href="#mgmt-ft" about="v-fs:RequestMgmt" property="rdfs:label" aria-controls="mgmt-ft" role="tab" data-toggle="tab"></a></li>
    <li role="presentation"><a id="results-pill-ft" href="#results-ft" aria-controls="results-ft" role="tab" data-toggle="tab"><span href="#params-ft" about="v-fs:Results" property="rdfs:label"></span> <span class="badge" id="results-count">0</span></a></li>
    <li role="presentation" class="active"><a id="params-pill-ft" href="#params-ft" about="v-fs:Params" property="rdfs:label" aria-controls="params-ft" role="tab" data-toggle="tab"></a></li>
  </ul>
  <br />
  <!-- Tab panes -->
  <div class="tab-content">
    <div role="tabpanel" class="tab-pane active" id="params-ft">
      <div class="not-found alert alert-warning" style="display: none">
        <strong about="v-fs:Empty" property="rdfs:label"></strong> <span about="v-fs:NothingFound" property="rdfs:label"></span>
      </div>
      <form role="form">
        <h4 about="v-fs:EnterQuery" property="rdfs:label"></h4>
        <div class="form-group">
          <div class="input-group">
            <veda-control data-type="string" property="v-fs:fulltextQuery"></veda-control>
            <span class="input-group-btn">
              <button type="submit" id="submit" class="btn btn-primary" about="v-fs:Find" property="rdfs:label"></button>
            </span>
          </div>
        </div>
        <h4 about="v-fs:ChooseType" property="rdfs:label"></h4>
        <div rel="v-fs:typeToSearch" data-template="v-ui:ClassNameLabelLinkTemplate"></div>
        <veda-control rel="v-fs:typeToSearch" data-type="link" class="fulltext dropdown" data-template="{individual['rdfs:label'].join(' ') + ' (' + individual.id + ')'}"></veda-control>
      </form>
    </div>
    <div role="tabpanel" class="tab-pane" id="results-ft">
      <div class="not-found alert alert-warning" style="display: none">
        <strong about="v-fs:Empty" property="rdfs:label"></strong> <span about="v-fs:NothingFound" property="rdfs:label"></span>
      </div>
      <div id="search-results">
        <ol id="results-list"></ol>
        <div class="text-center">
          <ul class="pagination" id="pager"></ul>
          <br />
        </div>
      </div>
    </div>
    <div role="tabpanel" class="tab-pane" id="mgmt-ft">
      <em about="rdfs:label" property="rdfs:label"></em>
      <p property="rdfs:label" class="view -edit -search"></p>
      <veda-control id="query" data-type="string" property="rdfs:label" class="-view edit search"></veda-control>
      <br>
      <div class="actions">
        <span about="@" data-template="v-ui:StandardButtonsTemplate" data-embedded="true" data-buttons="edit save delete"></span>
      </div>
    </div>
  </div>
  <div class="modal" id="object-modal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title"></h4>
        </div>
        <div class="modal-body"></div>
      </div>
    </div>
  </div>
</div>
<script>
  var self = individual,
    asp = veda.user.aspect,
    notFound = $(".not-found", template),
    params = $("a#params-pill-ft", template),
    results = $("a#results-pill-ft", template),
    pager = $("#pager", template),
    resultsList = $("#results-list", template),
    resultsCount = $("#results-count", template),
    submit = $("#submit", template),
    query = $("#query", template),
    form = new veda.IndividualModel();

  // Autofocus on query field
  params.on("shown.bs.tab", function () {
    if (!self.hasValue("v-fs:attributiveQuery")) {
      query.trigger("veda_focus");
    }
  });
  params.trigger("shown.bs.tab");

  // Enter on query field triggers search
  submit.click( function (e) {
    e.preventDefault();
    self.search();
  });

  // Define and clean handlers
  self.on("beforeSearch", beforeSearch);
  self.on("afterSearch", afterSearch);
  self.on("afterSave", updateAspect);
  template.one("remove", function () {
    self.off("beforeSearch", beforeSearch);
    self.off("afterSearch", afterSearch);
    self.off("afterSave", updateAspect);
  });

  // Present results if query defined
  if (self.q) {
    //self.trigger("afterSearch");
    self.search();
  }

  $("#refresh", template).click(function (e) {
    e.preventDefault();
    self.search();
  });

  // Modal for links
  var $objModal = $("#object-modal", template).modal({show: false});
  var cntr = $(".modal-body", $objModal);
  template.one("remove", function () {
    $objModal.modal("hide");
  });
  resultsList.on("click", "a[resource]", function (e) {
    e.preventDefault();
    var uri = $(this).attr("resource"),
      link = new veda.IndividualModel(uri);
    cntr.empty();
    link.present(cntr);
    $objModal.modal("show");
    $objModal.focus();
  });

  // Update user aspect when search request was saved
  function updateAspect() {
    if (self["v-s:deleted"][0] == true) {
      asp["v-s:hasRegistry"] = asp["v-s:hasRegistry"].filter( function (i) { return i.id !== self.id;});
    } else if (
      !asp["v-s:hasRegistry"].filter( function (i) {return i.id === self.id;}).length
    ) {
      asp["v-s:hasRegistry"] = asp["v-s:hasRegistry"].concat(self);
    }
    asp.save();
  }

  function genericTemplate(individual) {
    var head = "<strong><a href='#/@' about='@' data-template='v-ui:ClassNameLabelTemplate'></a></strong>";
    var allprops = Object.getOwnPropertyNames(individual.properties);
    var props = "<br>";
    for (var i = 0, uri; (uri = allprops && allprops[i]); i++) {
      if (uri === "@") { continue }
      if ( individual.hasValue(uri) ) {
        props += "<i about='" + uri + "' property='rdfs:label'></i>: "
        if (individual.get(uri)[0] instanceof veda.IndividualModel) {
          props += "<span about='@' rel='" + uri + "' data-template='v-ui:LabelEmptyLinkTemplate'></span>; "
        } else {
          props += "<span about='@' property='" + uri + "'></span>; "
        }
      }
    }
    return "<p>" + head + props + "</p>";
  }

  // Present results
  function beforeSearch() {
    notFound.hide();
    resultsList.empty();
    pager.empty();
    resultsCount.text(0);
  }
  function afterSearch() {
    resultsList.empty();
    pager.empty();
    resultsCount.text(self.count);

    // Nothing found
    if (self.count === 0) {
      notFound.show();
    }
    // Render results
    self.page = self.page || 0;
    if (self.count < self.page * veda.user.displayedElements) {
      self.page = Math.floor(self.count / veda.user.displayedElements) + 1 * (self.count % veda.user.displayedElements ? 1 : 0) - 1;
    }
    resultsList.attr("start", self.page * veda.user.displayedElements + 1);
    results.tab("show");

    for (var i = self.page * veda.user.displayedElements; i < (self.page + 1) * veda.user.displayedElements && i < self.count; i++) {
      (function (i) {
        setTimeout(function () {
          var container = $("<li>").appendTo(resultsList);
          var result = new veda.IndividualModel( self.result[i] );
          var tmpl = genericTemplate(result);
          result.present(container, tmpl);
        }, 0);
      }(i));
    }

    // Pager
    pager.pager({
      pages: Math.floor(self.count / veda.user.displayedElements) + 1 * (self.count % veda.user.displayedElements ? 1 : 0),
      active: self.page + 1,
      neighbours: 3,
      click: function (page) {
        if (page - 1 === self.page) return false;
        self.page = page - 1;
        self.trigger("afterSearch");
      }
    });
  }
  //# sourceURL=v-fs:FulltextRequestTemplate
</script>
  """
.
v-fs:AttributiveRequestModel
  rdf:type v-ui:ClassModel ;
  rdfs:label "Модель класса v-fs:AttributiveRequest"@ru ;
  rdfs:label "V-fs:AttributiveRequest class model"@en ;
  v-ui:forClass v-fs:AttributiveRequest ;
  v-s:script """
  var stopList = [
    "@",
    "rdf:type",
    "v-s:author",
    "v-s:publisher",
    "v-s:creator",
    "v-s:lastEditor",
    "v-s:created",
    "v-s:edited",
    "v-s:updateCounter",
    "v-s:deleted",
    "rdfs:label",
    "rdfs:isDefinedBy",
    "v-fs:sortOrder",
    "v-fs:databases",
    "v-fs:reopen",
    "v-fs:typeToSearch",
    "v-fs:resultTemplate",
    "v-fs:resultTemplateRest"
  ];
  var mkQuery = veda.Util.queryFromIndividual;

  var self = this,
    sort = self.hasValue("v-fs:sortOrder")      ? self["v-fs:sortOrder"][0] : undefined,
    databases = self.hasValue("v-fs:databases") ? self["v-fs:databases"][0] : undefined,
    reopen = self.hasValue("v-fs:reopen")       ? self["v-fs:reopen"][0]    : false,
    q;

  self.on("propertyModified", function (property_uri, values) {
    switch (property_uri) {
      case "v-fs:typeToSearch":
        self.form = new veda.IndividualModel();
        self.form["rdf:type"] = values;
        for (var property_uri in self.properties) {
          if ( stopList.indexOf(property_uri) >= 0 ) { continue; }
          self.form.set(property_uri, self.get(property_uri));
        }
        self.form.on("propertyModified", handler);
        q = mkQuery(self.form);
        break;
      case "v-fs:sortOrder"   : sort = values.length      ? values[0].toString() : undefined; break;
      case "v-fs:databases"   : databases = values.length ? values[0].toString() : undefined; break;
      case "v-fs:reopen"      : reopen = values.length    ? values[0].toString() : false; break;
    }
  });

  if (self.hasValue("v-fs:typeToSearch")) {
    self.trigger("propertyModified", "v-fs:typeToSearch", self["v-fs:typeToSearch"]);
  }

  function handler(property_uri, values) {
    if ( stopList.indexOf(property_uri) < 0 ) {
      self.set(property_uri, values);
    }
    q = mkQuery(self.form);
  }

  self.result  = [];
  self.count  = 0;
  self.selected = [];
  self.q = q;
  self.search = function () {
    self.trigger("beforeSearch");
    self.result = query(veda.ticket, q, sort, databases, reopen).result;
    self.count = self.result.length;
    self.trigger("afterSearch");
    return self.result;
  };
  // Search if query defined
  //if (q) { self.search() };
  //# sourceURL=v-fs:AttributiveRequestModel
  """
.
v-fs:AttributiveRequestTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Шаблон класса v-fs:AttributiveRequest"@ru ;
  rdfs:label "V-fs:AttributiveRequest class template"@en ;
  v-ui:forClass v-fs:AttributiveRequest ;
  v-ui:template """
<div role="tabpanel" class="container sheet">
  <br>
  <!-- Nav tabs -->
  <ul class="nav nav-tabs nav-right" role="tablist">
    <li class="pull-left"><h2 class="no-margin" about="@" property="rdfs:label"></h2></li>
    <li role="presentation"><a id="refresh" href="#refresh"><i class="fa fa-refresh fa-lg"></i></a></li>
    <li role="presentation"><a id="xls" href="#xls"><i class="fa fa-table fa-lg"></i></a></li>
    <li role="presentation"><a href="#mgmt-at" about="v-fs:RequestMgmt" property="rdfs:label" aria-controls="mgmt-at" role="tab" data-toggle="tab"></a></li>
    <li role="presentation"><a id="results-pill-at" href="#results-at" aria-controls="results-at" role="tab" data-toggle="tab"><span href="#params-at" about="v-fs:Results" property="rdfs:label"></span> <span class="badge" id="results-count">0</span></a></li>
    <li role="presentation" class="active"><a id="params-pill-at" href="#params-at" about="v-fs:Params" property="rdfs:label" aria-controls="params-at" role="tab" data-toggle="tab"></a></li>
  </ul>
  <br />
  <!-- Tab panes -->
  <div id="not-found" class="alert alert-warning" style="display: none">
    <strong about="v-fs:Empty" property="rdfs:label"></strong> <span about="v-fs:NothingFound" property="rdfs:label"></span>
  </div>
  <div class="tab-content">
    <div role="tabpanel" class="tab-pane active" id="params-at">
      <h4 about="v-fs:ChooseType" property="rdfs:label"></h4>
      <veda-control rel="v-fs:typeToSearch" data-type="link" class="fulltext dropdown" data-template="{individual['rdfs:label'].join(' ') + ' (' + individual.id + ')'}"></veda-control>
      <br>
      <div id="form-holder"></div>
      <br>
      <button type="button" id="find" class="btn btn-primary" about="v-fs:Find" property="rdfs:label"></button>
      <hr>
      <h4 about="v-fs:SetResultsTable" property="rdfs:label"></h4>
      <div id="set-result-template" class="table-responsive">
        <table id="generic-table" class="table table-condensed table-bordered">
          <caption about="v-fs:GenericTable" property="rdfs:label"></caption>
          <thead id="generic-head"></thead>
        </table>

        <table id="custom-table" class="table table-condensed table-bordered">
          <caption about="v-fs:CustomTable" property="rdfs:label"></caption>
          <thead id="custom-head">
            <tr><td><em about="v-fs:DragColumns" property="rdfs:label"></em></td></tr>
          </thead>
        </table>
      </div>
      <br>
      <button class="btn btn-danger" id="clear-custom" about="v-s:Reset" property="rdfs:label"></button>
    </div>
    <div role="tabpanel" class="tab-pane" id="results-at">
      <div id="search-results">
        <div class="table-responsive">
          <table id="results-tbl" class="table table-condensed table-striped table-bordered">
            <thead id="results-head"></thead>
            <tbody id="results-body"></tbody>
          </table>
        </div>
        <div class="text-center">
          <ul class="pagination" id="pager"></ul>
          <br />
        </div>
      </div>
    </div>
    <div role="tabpanel" class="tab-pane" id="mgmt-at">
      <em about="rdfs:label" property="rdfs:label"></em>
      <p property="rdfs:label" class="view -edit -search"></p>
      <veda-control data-type="string" property="rdfs:label" class="-view edit search"></veda-control>
      <br>
      <div class="actions">
        <span about="@" data-template="v-ui:StandardButtonsTemplate" data-embedded="true" data-buttons="edit save delete"></span>
      </div>
    </div>
  </div>
  <div class="modal" id="object-modal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title"></h4>
        </div>
        <div class="modal-body"></div>
      </div>
    </div>
  </div>
</div>
<script>
  var self = individual,
    asp = veda.user.aspect,
    notFound = $("#not-found", template),
    params = $("a#params-pill-at", template),
    results = $("a#results-pill-at", template),
    pager = $("#pager", template),
    resultsCount = $("#results-count", template),
    find = $("#find", template),
    fulltext = $("#fulltext", template),
    formHolder = $("#form-holder", template),
    tHead = $("thead#results-head", template),
    tBody = $("tbody#results-body", template),
    genericHead = $("thead#generic-head", template),
    customHead = $("thead#custom-head", template),
    clearCustom = $("#clear-custom", template),
    head, rest, tmpl;

  // Autofocus on query field
  params.on("shown.bs.tab", function () {
    if (!self.hasValue("v-fs:attributiveQuery")) {
      $("#fulltext", template).trigger("veda_focus");
    }
  });
  params.trigger("shown.bs.tab");

  // Enter on query field triggers search
  find.click( function (e) {
    e.preventDefault();
    self.search();
  });

  clearCustom.click(function () {
    self["v-fs:resultTemplate"] = [];
    self["v-fs:resultTemplateRest"] = [];
    setResultTable( self["v-fs:typeToSearch"] );
  });

  // Define and clean handlers
  self.on("beforeSearch", beforeSearch);
  self.on("afterSearch", afterSearch);
  self.on("afterSave", updateAspect);
  self.on("v-fs:typeToSearch", typeChanged);
  template.one("remove", function () {
    self.off("beforeSearch", beforeSearch);
    self.off("afterSearch", afterSearch);
    self.off("afterSave", updateAspect);
    self.off("v-fs:typeToSearch", typeChanged);
  });

  // Present form if defined
  if (self.form) {
    typeChanged(self["v-fs:typeToSearch"]);
  }

  // Present results if query defined
  if (self.q) {
    //self.trigger("afterSearch");
    self.search();
  }

  $("#refresh", template).click(function (e) {
    e.preventDefault();
    self.search();
  });

  // Modal for links
  var $objModal = $("#object-modal", template).modal({show: false});
  var cntr = $(".modal-body", $objModal);
  template.one("remove", function () {
    $objModal.modal("hide");
  });
  tBody.on("click", "a[resource]", function (e) {
    e.preventDefault();
    var uri = $(this).attr("resource"),
      link = new veda.IndividualModel(uri);
    cntr.empty();
    link.present(cntr);
    $objModal.modal("show");
    $objModal.focus();
  });

  // Display search form
  function typeChanged(types) {
    formHolder.empty();
    self.form.present(formHolder, undefined, "search");
    setResultTable(types);
  }

  // Set result table
  function setResultTable(types) {
    if ( self.hasValue("v-fs:resultTemplate") ) {
      head = $( self["v-fs:resultTemplate"][0].toString() );
      $(".rdfs-label", head).each(function () {
        this.textContent = (new veda.IndividualModel(this.parentNode.id))["rdfs:label"].join(", ");
      });
      customHead.html( head );
      rest = $( self["v-fs:resultTemplateRest"][0].toString() );
      genericHead.html( rest );
    } else {
      head = gen_head(types[0]);
      genericHead.html(head);
      customHead.empty();
      var placeholder = (new veda.IndividualModel("v-fs:DragColumns")).present(customHead, '<tr><td><em about="v-fs:DragColumns" property="rdfs:label"></em></td></tr>');
    }
    tHead.html( head.clone() );

    // Sorting
    var sortBy = "", dir = "";
    if ( self.hasValue("v-fs:sortOrder") ) {
      var t = self["v-fs:sortOrder"][0].split(" ");
      sortBy = t[0]; dir = t[1];
    }
    $("a.sort", tHead).each( function () {
      var a = $(this);
      var property_uri = a.parent().attr("id");
      if (sortBy.indexOf(property_uri) >= 0) {
        a.removeClass("text-muted");
        if (dir === "desc") a.removeClass("glyphicon-sort-by-attributes").addClass("glyphicon-sort-by-attributes-alt");
      }
      a.click(function (e) {
        e.preventDefault();
        var $this = $(this);
        $("a.sort", tHead).addClass("text-muted");
        var dir = $this.hasClass("glyphicon-sort-by-attributes-alt") ? " asc" : " desc";
        $this.removeClass("text-muted").toggleClass("glyphicon-sort-by-attributes glyphicon-sort-by-attributes-alt");
        self["v-fs:sortOrder"] = ["'" + property_uri + "_" + Object.keys(veda.user.language)[0].toLowerCase() + "'" + dir + " , " + "'" + property_uri + "'" + dir];
        self.search();
        return false;
      });
    });
    tmpl = gen_row(head)[0].outerHTML;

    $("thead#generic-head > tr").sortable({
      connectWith: "thead#custom-head > tr",
      placeholder: "danger",
      receive: function () {
        self["v-fs:resultTemplateRest"] = [ this.outerHTML ];
        setResultTable(types);
      },
      remove: function () {
        self["v-fs:resultTemplateRest"] = [ this.outerHTML ];
        setResultTable(types);
      }
    });
    $("thead#custom-head > tr").sortable({
      connectWith: "thead#generic-head > tr",
      placeholder: "danger",
      receive: function () {
        self["v-fs:resultTemplate"] = [ this.outerHTML ];
        setResultTable(types);
      },
      remove: function () {
        self["v-fs:resultTemplate"] = [ this.outerHTML ];
        setResultTable(types);
      }
    });
  }

  // Update user aspect when search request was saved
  function updateAspect() {
    if (self["v-s:deleted"][0] == true) {
      asp["v-s:hasRegistry"] = asp["v-s:hasRegistry"].filter( function (i) { return i.id !== self.id;});
    } else if (
      !asp["v-s:hasRegistry"].filter( function (i) {return i.id === self.id;}).length
    ) {
      asp["v-s:hasRegistry"] = asp["v-s:hasRegistry"].concat(self);
    }
    asp.save();
  }

  // Generic header from class
  function gen_head(type) {
    var ontology = new veda.OntologyModel();
    var props = ontology.getClassProperties(type.id);
    var literals = ["rdfs:Literal", "xsd:string", "xsd:boolean", "xsd:integer", "xsd:nonNegativeInteger", "xsd:decimal", "xsd:dateTime"];
    var tr = $("<tr><th id='count' width='20px'>#</th><th id='zoom' width='20px'><span class='glyphicon glyphicon-search'></span></th><th id='@'>@</th></tr>");
    var header = props.map( function (property_uri) {
      if (property_uri === "rdf:type" || property_uri === "v-s:deleted") { return ""; }
      var property = new veda.IndividualModel(property_uri);
      var th = $("<th id='" + property_uri + "'><span class='rdfs-label'>" + property["rdfs:label"].join(", ") + "</span></th>");
      var range = property.hasValue("rdfs:range") ? property["rdfs:range"][0].id : undefined;
      if (literals.indexOf(range) >= 0) {
        var sortOrder = $("<a>", {href:""}).addClass("sort btn btn-xs btn-link text-muted glyphicon glyphicon-sort-by-attributes");
        th.prepend(sortOrder);
      }
      tr.append(th);
    });
    return tr;
  }

  // Generate row from header
  function gen_row(head) {
    var hd = $(head);
    var literals = ["rdfs:Literal", "xsd:string", "xsd:boolean", "xsd:integer", "xsd:nonNegativeInteger", "xsd:decimal", "xsd:dateTime"];
    var row = $("<tr>");
    hd.children().each( function () {
      var td = $("<td>");
      if (this.id === "count") {
        td.text("###");
      } else if (this.id === "zoom") {
        td.html("<a href='#/@'><span class='glyphicon glyphicon-search'></span></a>");
      } else if (this.id === "@") {
        td.attr("property", "@");
      } else {
        var property = new veda.IndividualModel( this.id );
        var range = property.hasValue("rdfs:range") ? property["rdfs:range"][0].id : undefined;
        if (range === "xsd:boolean") {
          td.html( "<veda-control data-type='boolean' property='" + property.id + "'></veda-control>" );
        } else if (literals.indexOf(range) >= 0) {
          td.attr("property", property.id);
        } else {
          td.attr("rel", property.id).attr("data-template", "v-ui:LabelEmptyLinkTemplate");
        }
      }
      td.appendTo(row);
    });
    return row;
  }

  // Present results
  function beforeSearch() {
    notFound.hide();
    tBody.empty();
    pager.empty();
    resultsCount.text(0);
  }
  function afterSearch() {
    tBody.empty();
    pager.empty();
    resultsCount.text(self.count);

    // Nothing found
    if (self.count === 0) {
      notFound.show();
    }
    // Render results
    self.page = self.page || 0;
    if (self.count < self.page * veda.user.displayedElements) {
      self.page = Math.floor(self.count / veda.user.displayedElements) + 1 * (self.count % veda.user.displayedElements ? 1 : 0) - 1;
    }
    results.tab("show");

    for (var i = self.page * veda.user.displayedElements; i < (self.page + 1) * veda.user.displayedElements && i < self.count; i++) {
      (function (i) {
        setTimeout(function () {
          var _tmpl = tmpl.replace("###", i+1);
          var result = new veda.IndividualModel( self.result[i] );
          var $tmpl = result.present(tBody, _tmpl);
          $tmpl.dblclick(function (e) {
            riot.route("#/" + result.id);
          });
        }, 0);
      }(i));
    }

    // Pager
    pager.pager({
      pages: Math.floor(self.count / veda.user.displayedElements) + 1 * (self.count % veda.user.displayedElements ? 1 : 0),
      active: self.page + 1,
      neighbours: 3,
      click: function (page) {
        if (page - 1 === self.page) return false;
        self.page = page - 1;
        self.trigger("afterSearch");
      }
    });
  }

  // Export to Spreadsheet
  var tableToExcel = (function () {
    var uri = 'data:application/vnd.ms-excel;base64,'
      , template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--><meta http-equiv="content-type" content="text/plain; charset=UTF-8"/></head><body><table>{table}</table></body></html>'
      , format = function(s, c) { return s.replace(/{([a-z]+)}/g, function(m, p) { return c[p]; }) }
    return function(table, name) {
      if (!table.nodeType) table = document.getElementById(table)
      var ctx = {
        worksheet: name || 'Worksheet',
        table: table.innerHTML
      };
      var formatted = format(template, ctx);
      var blob = new Blob([formatted], {type: "application/vnd.ms-excel;charset=utf-8"});
      saveAs(blob, name + ".xls");
    }
  })();

  $("#xls", template).click(function (e) {
    e.preventDefault();
    var hd = tHead.clone().removeAttr("id");
    var tbl = $("<table id='export2xls'>").append(hd, "<tbody></tbody>");
    var tmpl = gen_row_simple(head)[0].outerHTML;

    for (var i = 0; i < self.count; i++) {
      (function (i) {
        var _tmpl = tmpl.replace("###", i+1);
        var result = new veda.IndividualModel( self.result[i] );
        result.present($("tbody", tbl), _tmpl);
      }(i));
    }
    setTimeout(function () {
      tableToExcel(tbl[0], self["rdfs:label"].join(", "));
    }, 0);
  });

  function gen_row_simple(head) {
    var hd = $(head);
    var literals = ["rdfs:Literal", "xsd:string", "xsd:boolean", "xsd:integer", "xsd:nonNegativeInteger", "xsd:decimal", "xsd:dateTime"];
    var row = $("<tr>");
    hd.children().each( function () {
      var td = $("<td>");
      if (this.id === "count") {
        td.text("###");
      } else if (this.id === "zoom") {
        td.html("");
      } else if (this.id === "@") {
        td.attr("property", "@");
      } else {
        var property = new veda.IndividualModel( this.id );
        var range = property.hasValue("rdfs:range") ? property["rdfs:range"][0].id : undefined;
        if (literals.indexOf(range) >= 0) {
          td.attr("property", property.id);
        } else {
          td.attr("about", "@").attr("rel", property.id).attr("data-template", "v-ui:LabelTemplate");
        }
      }
      td.appendTo(row);
    });
    return row;
  }
  //# sourceURL=v-fs:AttributiveRequestTemplate
</script>
  """
.

# ============================ NEW ============================

v-fs:AttributiveSearch
  rdf:type owl:Class ;
  rdfs:subClassOf v-s:Function ;
  rdfs:label "Атрибутивный поиск"@ru ;
  rdfs:label "Attributive search"@en ;
  v-ui:hasTemplate v-fs:AttributiveSearchTemplate ;
  v-ui:hasModel v-fs:AttributiveSearchModel ;
.

v-fs:applicableOperation
  rdf:type owl:ObjectProperty ;
  rdfs:label "Применимая операция"@ru ;
  rdfs:label "Applicable operation"@en ;
  rdfs:domain v-fs:AttributiveSearch ;
  rdfs:range v-s:Operation ;
.

v-fs:searchBlankTemplate
  rdf:type owl:ObjectProperty ;
  rdfs:label "Шаблон формы поиска"@ru ;
  rdfs:label "Search form template"@en ;
  rdfs:domain v-fs:AttributiveSearch ;
  rdfs:range v-ui:ClassTemplate ;
.

v-fs:searchResultTemplate
  rdf:type owl:ObjectProperty ;
  rdfs:label "Шаблон результатов поиска"@ru ;
  rdfs:label "Search result template"@en ;
  rdfs:domain v-fs:AttributiveSearch ;
  rdfs:range v-ui:ClassTemplate ;
.

v-fs:searchBlank
  rdf:type owl:ObjectProperty ;
  rdfs:label "Бланк поиска"@ru ;
  rdfs:label "Search blank"@en ;
  rdfs:domain v-fs:AttributiveSearch ;
  rdfs:range v-fc:Blank ;
.

v-fs:searchResult
  rdf:type owl:ObjectProperty ;
  rdfs:label "Результат"@ru ;
  rdfs:label "Result"@en ;
  rdfs:domain v-fs:AttributiveSearch ;
  rdfs:range rdfs:Resource ;
.
v-fs:searchOnLoad
  rdf:type owl:DatatypeProperty ;
  rdfs:label "Искать сразу"@ru ;
  rdfs:label "Search on load"@en ;
  rdfs:domain v-fs:AttributiveSearch ;
  rdfs:range xsd:boolean ;
.
v-fs:query
  rdf:type owl:DatatypeProperty ;
  rdfs:label "Запрос"@ru ;
  rdfs:label "Query"@en ;
  rdfs:domain v-fs:AttributiveSearch ;
  rdfs:range xsd:boolean ;
.
v-fs:loadAll
  rdf:type owl:DatatypeProperty ;
  rdfs:label "Загрузить все"@ru ;
  rdfs:label "Load all"@en ;
  rdfs:domain v-fs:AttributiveSearch ;
  rdfs:range xsd:boolean ;
.
v-fs:cursor
  rdf:type owl:DatatypeProperty ;
  rdfs:label "Обработано"@ru ;
  rdfs:label "Processed"@en ;
  rdfs:domain v-fs:AttributiveSearch ;
  rdfs:range xsd:integer ;
.
v-fs:top
  rdf:type owl:DatatypeProperty ;
  rdfs:label "Топ"@ru ;
  rdfs:label "Top"@en ;
  rdfs:domain v-fs:AttributiveSearch ;
  rdfs:range xsd:integer ;
.
v-fs:limit
  rdf:type owl:DatatypeProperty ;
  rdfs:label "Ограничение"@ru ;
  rdfs:label "Limit"@en ;
  rdfs:domain v-fs:AttributiveSearch ;
  rdfs:range xsd:integer ;
.
v-fs:estimated
  rdf:type owl:DatatypeProperty ;
  rdfs:label "Найдено"@ru ;
  rdfs:label "Estimated"@en ;
  rdfs:domain v-fs:AttributiveSearch ;
  rdfs:range xsd:integer ;
.
v-fs:authorized
  rdf:type owl:DatatypeProperty ;
  rdfs:label "Авторизовано"@ru ;
  rdfs:label "Authorized"@en ;
  rdfs:domain v-fs:AttributiveSearch ;
  rdfs:range xsd:integer ;
.
v-fs:TotalFoundBundle
  rdf:type v-s:Bundle ;
  rdfs:label "Всего найдено"@ru ;
  rdfs:label "Total found"@en ;
.

v-fs:TotalProcessedBundle
  rdf:type v-s:Bundle ;
  rdfs:label "Обработано"@ru ;
  rdfs:label "Processed"@en ;
.

v-fs:TotalAuthorizedBundle
  rdf:type v-s:Bundle ;
  rdfs:label "Вам доступно"@ru ;
  rdfs:label "Authorized"@en ;
.

v-fs:SearchBundle
  rdf:type v-s:Bundle ;
  rdfs:label "Поиск"@ru ;
  rdfs:label "Search"@en ;
.

v-fs:CtrlEnterBundle
  rdf:type v-s:Bundle ;
  rdfs:label "Нажмите 'Ctrl + Enter' чтобы начать поиск"@ru ;
  rdfs:label "Press 'Ctrl + Enter' to begin search"@en ;
.

v-fs:ClickToViewContent
  rdf:type v-s:Bundle ;
  rdfs:label "Кликните, чтобы увидеть всё содержимое"@ru ;
  rdfs:label "Click to view all contents"@en ;
.

v-fs:AttributiveSearchModel
  rdf:type v-ui:ClassModel ;
  v-ui:forClass v-fs:AttributiveSearch ;
  rdfs:label "Шаблон для класса v-fs:AttributiveSearch"@ru ;
  rdfs:label "Template for v-fs:AttributiveSearch class"@en ;
  v-s:script """
  var self = this;

  // Defaults
  this["v-fs:cursor"] = [ this["v-fs:cursor"][0] || 0 ];
  this["v-fs:top"] = [ veda.user.displayedElements || 10 ];
  this["v-fs:limit"] = [ this["v-fs:limit"][0] || 10000 ];
  this["v-fs:estimated"] = [ this["v-fs:estimated"][0] || 0 ];
  this["v-fs:authorized"] = [ this["v-fs:authorized"][0] || 0 ];
  this["v-fs:sortOrder"] = [ this["v-fs:sortOrder"][0] || "'v-s:created' desc" ];

  // Search method
  this.search = function (cursor) {

    if (cursor > 0) {
      self["v-fs:cursor"] = [cursor];
    } else {
      self["v-fs:cursor"] = [0];
      self["v-fs:authorized"] = [0];
      self["v-fs:searchResult"] = [];
    }
    var sort = self.hasValue("v-fs:sortOrder") ? self["v-fs:sortOrder"][0] : undefined;
    var queryString = [];
    if ( self.hasValue("v-fs:searchBlank") ) {
      self["v-fs:searchBlank"][0].initBlank();
      queryString.push( veda.Util.queryFromIndividual(self["v-fs:searchBlank"][0].object) );
    }
    if ( self.hasValue("v-fs:fulltextQuery") ) {
      queryString.push( self["v-fs:fulltextQuery"][0] )
    }
    queryString = queryString.join(" && ");
    if ( queryString ) {
      return query({
        ticket: veda.ticket,
        query: queryString,
        sort: self["v-fs:sortOrder"][0],
        top: self["v-fs:top"][0] || veda.user.displayedElements || 10,
        limit: self["v-fs:limit"][0] || 10000,
        from: self["v-fs:cursor"][0],
        async: true
      }).then(function (results) {
        self["v-fs:estimated"] = [ results.estimated ];
        self["v-fs:cursor"] = [ results.cursor ];
        return results.result;
      }).then(function (resultDelta) {

        var prefetch = [];
        resultDelta.map(function (uri) {
          if ( !veda.cache.get(uri) ) {
            prefetch.push( uri );
          }
        });
        if (prefetch.length) {
          return get_individuals({
            ticket: veda.ticket,
            uris: prefetch,
            async: true
          }).then(function (prefetched) {
            prefetched.forEach(function (json) {
              var fetched = new veda.IndividualModel(json);
            });
            return resultDelta;
          });
        } else {
          return resultDelta;
        }
      }).then(function (resultDelta) {
        self["v-fs:authorized"] = [ self["v-fs:authorized"][0] + resultDelta.length ];
        var delta = resultDelta.map(function (uri) {
          return new veda.IndividualModel(uri);
        });
        self.addValue("v-fs:searchResult", delta);
        if ( self.hasValue("v-fs:loadAll", true) && self["v-fs:cursor"][0] < self["v-fs:estimated"][0] ) {
          return self.search( self["v-fs:cursor"][0] );
        }

        // Notify search blank on search complete
        if ( self.hasValue("v-fs:searchBlank") ) {
          self["v-fs:searchBlank"][0].initBlank();
          self["v-fs:searchBlank"][0].object.trigger("search:complete");
        }

        return self.hasValue("v-fs:loadAll", true) ? self["v-fs:searchResult"] : delta ;
      });
    } else {
      return Promise.resolve( self["v-fs:searchResult"] );
    }
  };

//# sourceURL=v-fs:AttributiveSearchModel
  """ ;
.


v-fs:EnterLabel
  rdf:type v-s:Bundle ;
  rdfs:label "Введите название"@ru ;
  rdfs:label "Enter label"@en ;
.

v-fs:SavePersonalRegistry
  rdf:type v-s:Bundle ;
  rdfs:label "Сохранить личный реестр"@ru ;
  rdfs:label "Save personal registry"@en ;
.

v-fs:UpdatePersonalRegistry
  rdf:type v-s:Bundle ;
  rdfs:label "Обновить личный реестр"@ru ;
  rdfs:label "Update personal registry"@en ;
.

v-fs:RegistrySuccessfullySaved
  rdf:type v-s:Bundle ;
  rdfs:label "Реестр успешно сохранен"@ru ;
  rdfs:label "Registry successfully saved"@en ;
.

v-fs:RegistrySuccessfullyUpdated
  rdf:type v-s:Bundle ;
  rdfs:label "Реестр успешно обновлен"@ru ;
  rdfs:label "Registry successfully updated"@en ;
.

v-fs:AttributiveSearchTemplate
  rdf:type v-ui:ClassTemplate ;
  v-ui:forClass v-fs:AttributiveSearch ;
  rdfs:label "Шаблон для класса v-fs:AttributiveSearch"@ru ;
  rdfs:label "Template for v-fs:AttributiveSearch class"@en ;
  v-ui:template """
<script>
  var notify = new veda.Notify();

  if ( !individual.hasValue("v-s:creator", veda.appointment || veda.user) ) {
    $(".action.save-registry", template).click(function () {
      var personalLabel = prompt( new veda.IndividualModel("v-fs:EnterLabel").toString(), individual.toString() );
      var personalRegistry = individual.clone();
      personalRegistry["v-fs:searchResult"] = [];
      personalRegistry["v-fs:authorized"] = [];
      personalRegistry["v-fs:cursor"] = [];
      personalRegistry["v-fs:estimated"] = [];
      personalRegistry["v-fs:limit"] = [];
      personalRegistry["v-fs:top"] = [];
      personalRegistry["v-s:creator"] = [];
      personalRegistry["v-s:created"] = [];
      personalRegistry["rdfs:isDefinedBy"] = [];
      personalRegistry["rdfs:label"] = [ personalLabel ];
      var searchBlank = individual.hasValue("v-fs:searchBlank") ? individual["v-fs:searchBlank"][0] : undefined;
      if (searchBlank && searchBlank.object) {
        var personalRegistryBlank = searchBlank.clone();
        personalRegistry["rdfs:isDefinedBy"] = [];
        personalRegistry["v-fs:searchBlank"] = [ personalRegistryBlank ];
        personalRegistryBlank.object = searchBlank.object;
        personalRegistryBlank.updateBlank();
        personalRegistryBlank.save();
      }
      personalRegistry.save();
      var aspect = veda.user.aspect;
      aspect.addValue("v-s:hasRegistry", personalRegistry);
      aspect.save();
      notify("success", { message: new veda.IndividualModel("v-fs:RegistrySuccessfullySaved").toString() });
    });
  } else {
    $(".action.save-registry", template).remove();
  }

  if ( individual.rights.hasValue("v-s:canUpdate", true) ) {
    $(".action.update-registry", template).click(function () {
      individual["v-fs:searchResult"] = [];
      var searchBlank = individual.hasValue("v-fs:searchBlank") ? individual["v-fs:searchBlank"][0] : undefined;
      if (searchBlank && searchBlank.object) {
        searchBlank.updateBlank();
        searchBlank.save();
      }
      notify("success", { message: new veda.IndividualModel("v-fs:RegistrySuccessfullyUpdated").toString() });
    });
  } else {
    $(".action.update-registry", template).remove();
  }
  if ( individual.rights.hasValue("v-s:canDelete", true) ) {
    $(".action.delete-registry", template).click(function () {
      template.trigger("delete");
    });
  } else {
    $(".action.delete-registry", template).remove();
  }

//# sourceURL=v-fs:AttributiveSearchTemplate_pre
</script>
<div>
  <div class="container sheet">
    <div class="ribbon-wrapper top-left">
      <div class="ribbon top-left primary" about="v-fs:SearchBundle" property="rdfs:label"></div>
    </div>
    <div class="actions text-right">
      <button class="action save-registry btn btn-success" about="v-fs:SavePersonalRegistry" property="rdfs:label"></button>
      <button class="action update-registry btn btn-success" about="v-fs:UpdatePersonalRegistry" property="rdfs:label"></button>
      <button class="action delete-registry btn btn-link" about="v-s:Delete" property="rdfs:label"></button>
    </div>
  </div>
  <br>
  <div class="container sheet">
    <style>
      td.number {
        mso-number-format:General;
      }
      td.date {
        mso-number-format:"Short Date";
      }
    </style>
    <div about="@" data-template="v-fs:AttributiveSearchInlineTemplate"></div>
    <span class="additional-actions">
      <button class="btn btn-default xls"><span about="v-fs:Excel" property="rdfs:label"></span></button>
      <button class="btn btn-default files"><span about="v-fs:FilesRegistry" property="rdfs:label"></span></button>
      <span class="text-muted padding-lg" about="v-fs:CtrlEnterBundle" property="rdfs:label"></span>
    </span>
  </div>
</div>
<script>
  // Append additional actions
  setTimeout(function () {
    var additionalActions = $(".additional-actions", template);
    var searchActions = $(".search-actions", template);
    additionalActions.appendTo(searchActions);
  }, 0);

  // Export table to 'blob' or 'xls'
  var exportTable = (function () {
    var uri = 'data:application/vnd.ms-excel;base64,'
      , template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--><meta http-equiv="content-type" content="text/plain; charset=UTF-8"/></head><body><table>{table}</table></body></html>'
      , format = function(s, c) { return s.replace(/{([a-z]+)}/g, function(m, p) { return c[p]; }) }
    return function(table, name, exportAs) {
      if (!table.nodeType) table = document.getElementById(table);
      var ctx = {
        worksheet: name || 'Worksheet',
        table: table.innerHTML
      };
      if ( exportAs === "xls" ) {
        // Tags
        var tags = new RegExp("<\/?(a|span|p|div|button) ?.*?>", "gi");
        // Numbers with decimal point
        var decimal = new RegExp("([^\\d\\.\\:]+\\d+)\\.(\\d+[^\\d\\.\\:]+)", "gi");
        ctx.table = ctx.table.replace(tags, " ").replace(decimal, "$1,$2");
      }
      var formatted = format(template, ctx);
      var blob = new Blob([formatted], {type: "application/vnd.ms-excel;charset=utf-8"});
      if ( exportAs === "blob" ) {
        return blob;
      } else if ( exportAs === "xls" ) {
        saveAs(blob, name + ".xls");
      }
    }
  })();

  $(".xls", template).click(function (e) {
    e.preventDefault();
    var resultTable = $(".search-result > table").clone();
    resultTable.find(".hidden").remove();
    resultTable = resultTable.get(0);
    exportTable(resultTable, individual["rdfs:label"].join(", "), "xls");
  });

  $(".files", template).click(function (e) {
    var btn = $(this);
    toggleSpin(btn);
    e.preventDefault();
    var resultTable = $(".search-result > table").clone();
    resultTable.find(".hidden").remove();
    resultTable = resultTable.get(0);

    var filesPromises = $("[typeof='v-s:File']", resultTable).map(function () {
      var $this = $(this);
      var fileUri = $this.attr("resource").replace(":", "_");
      var fileName = $("span", $this).text().replace(/([a-zA-Z0-9]+)$/, fileUri + ".$1");
      var localFileUrl = "./files/" + fileName;
      var link = $("a", $this);
      var fileUrl = link.attr("href");
      link.attr("href", localFileUrl);
      return filePromise(fileUrl, fileName);
    });

    Promise.all(filesPromises).then(function (files) {
      var zip = new JSZip();
      var registry = exportTable(resultTable, individual["rdfs:label"].join(", "), "blob");
      zip.file("registry.html", registry);
      var folder = zip.folder("files");
      files.forEach(function (file) {
        folder.file(file.name, file);
      });
      zip.generateAsync({type:"blob"}).then(function(content) {
        saveAs(content, "registry.zip");
        toggleSpin(btn);
      });
    }).catch(function (error) {
      console.log(error, error.stack);
      toggleSpin(btn);
      var notify = new veda.Notify();
      notify("danger", { message: "Ошибка выгрузки реестра. Обратитесь в поддержку." });
    });
  });

  function filePromise(url, name) {
    return new Promise(function (resolve, reject) {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', url + "?" + Math.random(), true);
      xhr.responseType = 'blob';
      xhr.onload = function(e) {
        if (this.status == 200) {
          var file = new Blob([this.response], {type: 'application/octet-stream'});
          file.name = name;
          resolve(file);
        } else {
          reject(xhr.statusText);
        }
      };
      xhr.onerror = function () {
        reject(xhr.statusText);
      }
      xhr.send();
    });
  }

  // Spinner
  function toggleSpin(el) {
    var $el = $(el);
    var hasSpinner = $el.children(".fa-spinner");
    if ( hasSpinner.length ) {
      $el.removeClass("disabled");
      hasSpinner.remove();
    } else {
      $el.addClass("disabled");
      $("<i class='fa fa-spinner fa-pulse fa-lg fa-fw'></i>").appendTo(el);
    }
  }

  //# sourceURL=v-fs:AttributiveSearchTemplate_post
</script>
  """ ;
.

v-fs:PerformOperation
  rdf:type v-s:Bundle ;
  rdfs:label "Выполнить операцию"@ru ;
  rdfs:label "Perform operation"@en ;
.

v-fs:SelectedResultsActionsTemplate
  rdf:type v-ui:ClassTemplate ;
  v-ui:forClass v-fs:AttributiveSearch ;
  rdfs:label "Шаблон для класса v-fs:AttributiveSearch"@ru ;
  rdfs:label "Template for v-fs:AttributiveSearch class"@en ;
  v-ui:template """
<script>
  var self = this;
  function selectedHandler() {
    var selectedL = self.selected && Object.keys(self.selected).length || 0;
    if (!selectedL) {
      template.addClass("hidden");
    } else {
      template.removeClass("hidden");
    }
  }
  self.on("selected", selectedHandler);
  template.one("remove", function () {
    self.off("selected", selectedHandler);
  });
  selectedHandler();

  $(".dropdown-toggle", template).one("click", function () {
    var dropdown = $(".dropdown-menu", template);
    query({
      ticket: veda.ticket,
      query: "'rdf:type' === 'owl:Class' && 'rdfs:subClassOf' === 'v-s:GenericOperation'",
      async: true
    }).then(function (response) {
      if (self.hasValue("v-fs:applicableOperation") && response.result.length) {
        dropdown.append("<li role='separator' class='divider'></li>");
      }
      response.result.forEach(function (operation_uri) {
        var operation = new veda.IndividualModel(operation_uri);
        operation.present(dropdown, "<li><a about='@' href='#' property='rdfs:label'></a></li>");
      });
    });
  });

  $(".dropdown-menu", template).on("click", "[resource]", function (e) {
    e.preventDefault();
    var operationClassUri = $(this).attr("resource"),
        operationClass = new veda.IndividualModel(operationClassUri),
        operation = new veda.IndividualModel(),
        operationContainer = $(".operation-container", template).empty();
    operation["rdf:type"] = [ operationClass ];
    operation["v-s:data"] = Object.keys(self.selected).map(function (value_uri) {
      return new veda.IndividualModel(value_uri);
    });
    operation["v-s:hasStatus"] = [ new veda.IndividualModel("v-s:StatusStarted") ];
    operation.present(operationContainer, "v-s:OperationStatusTemplate");
    operation.save();
  });

//# sourceURL=v-fs:SelectedResultsActionsTemplate_pre
</script>
<div class="btn-group">
  <button type="button" class="btn btn-xs btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    <span about="v-fs:PerformOperation" property="rdfs:label"></span> <span class="caret"></span>
  </button>
  <ul class="dropdown-menu" about="@" rel="v-fs:applicableOperation">
    <li><a about="@" href="#" property="rdfs:label"></a></li>
  </ul>
  <div class="pull-left operation-container margin-md-h"></div>
</div>
  """ ;
.

v-fs:AttributiveSearchInlineTemplate
  rdf:type v-ui:ClassTemplate ;
  v-ui:forClass v-fs:AttributiveSearch ;
  rdfs:label "Шаблон для класса v-fs:AttributiveSearch"@ru ;
  rdfs:label "Template for v-fs:AttributiveSearch class"@en ;
  v-ui:template """
<script>
  var self = individual,
      searchBlankTemplate = self.hasValue("v-fs:searchBlankTemplate") ? self["v-fs:searchBlankTemplate"][0] : undefined,
      searchResultTemplate = self.hasValue("v-fs:searchResultTemplate") ? self["v-fs:searchResultTemplate"][0]["v-ui:template"][0].toString() : undefined,
      searchResultContainer = $(".search-result", template);
  if ( searchResultTemplate ) {
    searchResultContainer.append( searchResultTemplate );
    var resultContainer = $(".result-container", template);
    var resultTemplate = resultContainer.html();
    individual.resultTemplate = resultTemplate;
    resultContainer.empty();
  } else {
    $(".stats-top, .stats-bottom, .result-heading", template).remove();
    searchResultTemplate = (new veda.IndividualModel("v-fs:MinimalSearchResultTemplate"))["v-ui:template"][0].toString();
    searchResultContainer.append( searchResultTemplate );
    var resultContainer = $(".result-container", template);
    var resultTemplate = resultContainer.html();
    individual.resultTemplate = resultTemplate;
    resultContainer.empty();
  }

  if ( !searchBlankTemplate ) {
    $(".results-load-buttons", template).detach().appendTo(template);
    $(".params", template).remove();
  }
  if ( this.hasValue("v-fs:loadAll", true) ) {
    $(".no-more-results", template).remove();
  }

  // Enable swipe for result table
  $("body").keydown(enableSwipe).keyup(disableSwipe);
  template.one("remove", function () {
    $("body").off("keydown", enableSwipe).off("keyup", disableSwipe);
  });
  function disableSwipe (e) {
    if (e.which === 17) {
      $(".search-result", template).addClass("noSwipe").removeClass("swipe");
    }
  }
  function enableSwipe (e) {
    if (e.ctrlKey) {
      $(".search-result", template).addClass("swipe").removeClass("noSwipe");
    }
  }

  var prevDistance = 0, delta = 0;
  $(".search-result", template).swipe({
    swipeStatus: function (event, phase, direction, distance, duration) {
      if (phase === "move" && event.ctrlKey === true) {
        this.css("cursor", "move");
        if (direction === "left") {
          delta = distance - prevDistance;
          prevDistance = distance;
          this.scrollLeft( this.scrollLeft() + delta );
        } else if (direction === "right") {
          delta = distance - prevDistance;
          prevDistance = distance;
          this.scrollLeft( this.scrollLeft() - delta );
        } else if (direction === "up") {
          window.scrollBy(0, distance);
        } else if (direction === "down") {
          window.scrollBy(0, -distance);
        }
      } else {
        prevDistance = 0;
        delta = 0;
        this.css("cursor", "");
      }
    }
  });
  template.one("remove", function () {
    prevDistance = null;
    delta = null;
    $(".search-result", template).swipe("destroy");
  });

  //# sourceURL=v-fs:AttributiveSearchInlineTemplate_pre
</script>
<div>
  <style>
    .swipe {
      cursor: move;
    }
    .td-wrapper {
      max-height: 100px;
      overflow: hidden;
      display: inline-block;
      position: relative;
    }
    .td-wrapper::after {
      content: "";
      position: absolute;
      bottom: 0;
      right: 0;
      z-index: 2;
      border-top: 0 solid transparent;
      border-right: 0 solid transparent;
      border-bottom: 7px solid gray;
      border-left: 7px solid transparent;
    }
  </style>
  <div class="params">
    <div class="search-form"></div>
    <br>
    <div class="search-actions clearfix">
      <button class="btn btn-primary search-button" id="search-button" about="v-fs:Find" property="rdfs:label"></button>
      <span class="results-load-buttons">
        <button class="more-results btn btn-primary hidden" about="v-fs:MoreResults" property="rdfs:label"></button>
        <button class="all-results btn btn-warning hidden" about="v-fs:AllResults" property="rdfs:label"></button>
      </span>
      <div class="pull-right btn-group dropup set-columns-wrapper" style="margin-left:3px;">
        <button type="button" class="btn btn-info dropdown-toggle set-columns" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <span about="v-fs:SetColumns" property="rdfs:label"></span>
          <span class="caret"></span>
        </button>
        <div class="dropdown-menu" style="padding:15px; width: 300px; max-height: 500px; overflow-y: auto;">
          <div class="checkbox">
            <label>
              <input class="column-check" type="checkbox" checked="true"> <span class="column-name"></span>
            </label>
          </div>
        </div>
      </div>
    </div>
    <br>
  </div>
  <div class="results hidden">
    <div class="result-heading">
      <h3 class="clearfix">
        <span class="pull-left" about="v-fs:Results" property="rdfs:label"></span>
        <div class="pull-left margin-md-h" about="@" data-template="v-fs:SelectedResultsActionsTemplate"></div>
        <small class="stats-top pull-right" style="color:black">
          <span about="v-fs:estimated" property="rdfs:label"></span>
          <span about="@" property="v-fs:estimated" class="badge"></span>&nbsp;&nbsp;
          <span about="v-fs:cursor" property="rdfs:label"></span>
          <span about="@" property="v-fs:cursor" class="badge"></span>&nbsp;&nbsp;
          <strong about="v-fs:authorized" property="rdfs:label"></strong>
          <span about="@" property="v-fs:authorized" class="badge"></span>&nbsp;&nbsp;
        </small>
      </h3>
    </div>
    <div class="search-result table-responsive noSwipe"></div>
    <div class="not-found alert alert-warning hidden">
      <strong about="v-fs:Empty" property="rdfs:label"></strong> <span about="v-fs:NothingFound" property="rdfs:label"></span>
    </div>
    <div class="no-more-results alert alert-success hidden">
      <strong about="v-fs:NoMoreResults" property="rdfs:label"></strong>
    </div>
  </div>
</div>
<script>
  // Make position fixed for buttons bar that doesn't fit the window
  function checkOffset(main, actions, actionsStaticHeight, placeholder) {
    var mainTop = main.offset().top;
    var mainHeight = main.height();
    var windowHeight = window.innerHeight;
    var windowTop = window.scrollY || window.pageYOffset;
    var actionsStaticTop = placeholder.offset().top;
    var actions_inside_viewport = windowTop <= actionsStaticTop && actionsStaticTop < (windowTop + windowHeight);
    var main_inside_viewport = windowTop <= (mainTop + mainHeight - actionsStaticHeight) && (mainTop + actionsStaticHeight) < (windowTop + windowHeight);
    if ( !actions_inside_viewport && main_inside_viewport )  {
      if ( !actions.hasClass("actions-fixed") ) {
        placeholder.css("height", actionsStaticHeight);
        actions.find("br").addClass("hidden");
        actions.addClass("actions-fixed");
      }
    } else {
      if ( actions.hasClass("actions-fixed") ) {
        placeholder.css("height", 0);
        actions.find("br").removeClass("hidden");
        actions.removeClass("actions-fixed");
      }
    }
  }
  setTimeout(function () {
    var main = template;
    var actions = $(".search-actions", template);
    if (!actions.length) { return; }
    var actionsStaticHeight = actions.height();
    var placeholder = $("<div></div>").insertBefore(actions);
    checkOffset(main, actions, actionsStaticHeight, placeholder);
    $(window).on("scroll", scrollHandler);
    template.one("remove", function () {
      $(window).off("scroll", scrollHandler);
    });
    function scrollHandler () {
      checkOffset(main, actions, actionsStaticHeight, placeholder);
    }
  }, 500);

  var self = individual,
      searchBlankContainer = $(".search-form", template),
      searchResultContainer = $(".search-result", template),
      searchButton = $("#search-button.search-button", template),
      moreResults = $(".more-results", template),
      allResults = $(".all-results", template),
      noMoreResults = $(".no-more-results", template),
      searchBlank = self.hasValue("v-fs:searchBlank") ? self["v-fs:searchBlank"][0] : undefined ,
      searchBlankTemplate = self.hasValue("v-fs:searchBlankTemplate") ? self["v-fs:searchBlankTemplate"][0] : undefined ,
      resultContainer = $(".result-container", template),
      notFound = $(".not-found", template),
      statsTop = $(".stats-top", template);

  // Set columns
  var resultContainer = $(".result-container", template);
  individual.hiddenColumns = individual.hiddenColumns || {};
  var checksContainer = $(".set-columns-wrapper .dropdown-menu", template).on('click', function (e) {
    e.stopPropagation();
  });
  var checkTmpl = $(".set-columns-wrapper .dropdown-menu .checkbox", template).remove();
  if (checkTmpl.length) {
    checkTmpl = checkTmpl.get(0).outerHTML;
    $(".search-result table > thead > tr:last > th", template).each(function (index) {
      var th = $(this);
      var check = $(checkTmpl);
      var checkbox = $("input", check);
      var columnName = $(this).find("span").clone();
      if ( columnName.length ) {
        $(".column-name", check).html( columnName );
      } else {
        $(".column-name", check).text( th.text() );
      }
      if (index in individual.hiddenColumns) {
        checkbox.prop("checked", false);
      } else {
        checkbox.prop("checked", true);
      }
      checkbox.change(checkHandler);
      checkHandler.call( checkbox.get(0) );
      checksContainer.append(check);

      // Show/hide result table columns & update resultTemplate accordingly
      function checkHandler() {
        individual.resultTemplate = $(individual.resultTemplate);
        if ( $(this).is(":checked") ) {
          th.removeClass("hidden");
          $("tr td:nth-child(" + (index + 1) + ")", resultContainer).removeClass("hidden");
          individual.resultTemplate.not("script").children().eq(index).removeClass("hidden");
          delete individual.hiddenColumns[index];
        } else {
          th.addClass("hidden");
          $("tr td:nth-child(" + (index + 1) + ")", resultContainer).addClass("hidden");
          individual.resultTemplate.not("script").children().eq(index).addClass("hidden");
          individual.hiddenColumns[index] = true;
        }
        individual.resultTemplate = individual.resultTemplate.map(function () { return this.outerHTML; }).get().join("");
      }
    });
  }

  // Read extra parameters from URL
  var hash = window.location.hash;
  var tokens = decodeURI(hash).slice(2).split("/"),
      uri = tokens[0],
      extra = tokens[4];
  if (uri === self.id) {
    if (extra) {
      extra = extra.split("&").reduce(function (acc, pair) {
        var split = pair.split("="),
            property_uri = split[0] || "",
            value = split[1] || "";
        acc[property_uri] = acc[name] || [];
        acc[property_uri].push( parse(property_uri, value) );
        return acc;
      }, {});
    }
  }
  function parse (property_uri, value) {
    var property = new veda.IndividualModel(property_uri);
    var range = property.hasValue("rdfs:range") ? property["rdfs:range"][0].id : "rdfs:Resource";
    var parsed;
    switch (range) {
      case "xsd:string": parsed = value; break;
      case "xsd:integer":
      case "xsd:decimal": parsed = parseFloat( value.split(" ").join("").split(",").join(".") ); break;
      case "xsd:boolean": parsed = value === "true"; break;
      case "xsd:dateTime": parsed = new Date(value); break;
      default: parsed = new veda.IndividualModel(value);
    }
    return parsed;
  }

  // Render search form
  if ( searchBlank ) {
    searchBlank.initBlank();
    searchBlank.object.on("search", formHandler);
    template.one("remove", function () {
      searchBlank.object.off("search", formHandler);
    });
    if ( searchBlankTemplate && searchBlankContainer.length ) {
      searchBlank.object.present(searchBlankContainer, searchBlankTemplate, "search");
    }
    // Populate blank with extra parameters from URL
    if (extra) {
      for (var property_uri in extra) {
        searchBlank.object[property_uri] = extra[property_uri];
      }
    }
  } else {
    $(".params", template).remove();
  }
  function formHandler () {
    self.search()
      .then(renderResult)
      .then(function () {
        scrollTo(self.scroll);
      });
  }

  // Remember scroll position
  template.one("remove", function () {
    self.scroll = $(window).scrollTop();
  });

  // Scroll to position
  function scrollTo(position) {
    $("html, body").animate({
      scrollTop: position
    });
  }

  // Search handler
  function searchHandler() {
    var searchButtons = $(".search-button", template);
    toggleSpin(searchButtons);
    self.search()
      .then(renderResult)
      .then(function () {
        if ( location.hash.indexOf(individual.id) >= 0 ) {
          scrollTo(self.scroll);
        }
        toggleSpin(searchButtons);
      })
      .catch(function (error) {
        console.log(error);
        toggleSpin(searchButtons);
      });
  }

  // Search button handler
  searchButton.click(searchHandler);

  // Ctrl + Enter triggers search
  function ctrlEnterHandler (e) {
    if (e.ctrlKey && e.keyCode === 13) {
      searchHandler.call( searchButton.get(0) );
    }
  }
  $(window).on("keyup", ctrlEnterHandler);
  template.one("remove", function () {
    $(window).off("keyup", ctrlEnterHandler);
  });

  // More results handler
  function moreResultsHandler() {
    return self.search( self["v-fs:cursor"][0] )
      .then(renderResult)
      .catch(function (error) {
        console.log(error);
      });
  }

  // More results button
  moreResults.click(moreResultsHandler);

  // All results button
  allResults.click(function () {
    var warn = new veda.IndividualModel("v-s:AreYouSure")["rdfs:label"].join(" ");
    if ( self["v-fs:estimated"][0] - self["v-fs:cursor"][0] < 100 || confirm(warn) ) {
      loadAll();
    }
  });
  function loadAll() {
    if (self["v-fs:cursor"][0] < self["v-fs:estimated"][0] && template.is(":visible")) {
      moreResultsHandler().then(loadAll);
    }
  }

  // Double click on result table row routes to search result
  $(".search-result", template).on("dblclick", "table tbody tr", function () {
    var uri = $(this).attr("resource");
    riot.route("#/" + uri);
  });
  // Mark clicked row
  $(".search-result", template).on("click", "table tbody tr", function () {
    var that = $(this);
    that.addClass("warning").siblings(".warning").removeClass("warning");
    self.marked = that.index();
  });

  // Manage sort
  var sortBy = "", dir = "";
  var tmp = self["v-fs:sortOrder"][0].split(" ");
  sortBy = tmp[0]; dir = tmp[1];
  $(".orderby", template).each( function () {
    var header = $(this);
    var a = $("<a href='#' class='text-muted glyphicon glyphicon-sort-by-attributes'></a>");
    header.prepend(a, " ");
    var property_uri = header.attr("data-orderby");
    if (sortBy.indexOf(property_uri) >= 0) {
      a.removeClass("text-muted");
      if (dir === "desc") { a.removeClass("glyphicon-sort-by-attributes").addClass("glyphicon-sort-by-attributes-alt"); }
    }
    a.click(function (e) {
      e.preventDefault();
      e.stopPropagation();
      var $this = $(this);
      $(".orderby a", template).addClass("text-muted");
      var dir = $this.hasClass("glyphicon-sort-by-attributes-alt") ? " asc" : " desc";
      $this.removeClass("text-muted").toggleClass("glyphicon-sort-by-attributes glyphicon-sort-by-attributes-alt");
      self["v-fs:sortOrder"] = [ "'" + property_uri + "'" + dir + " , " + "'" + property_uri + "_" + Object.keys(veda.user.language)[0].toLowerCase() + "'" + dir ];
      searchHandler.call(this);
    });
  });

  // Select results
  self.selected = self.selected || {};
  var toggleSelectAll = searchResultContainer.find(".toggle-select-all");
  searchResultContainer.on("click", ".toggle-select", toggleSelect);

  toggleSelectAll.click(function () {
    var selectedL = Object.keys(self.selected).length;
    var resultsL = resultContainer.children().length;
    if ( resultsL !== 0 && selectedL !== 0 && resultsL !== selectedL ) {
      searchResultContainer.find(".toggle-select:checked").click();
    } else if ( resultsL !== 0 && selectedL === 0) {
      searchResultContainer.find(".toggle-select").click();
    } else if ( resultsL !== 0 && selectedL !== 0 && resultsL === selectedL) {
      searchResultContainer.find(".toggle-select").click();
    }
  });
  function checkToggleSelectAll() {
    var selectedL = Object.keys(self.selected).length;
    var resultsL = resultContainer.children().length;
    if ( resultsL !== 0 && resultsL === selectedL ) {
      toggleSelectAll.prop("checked", true);
      toggleSelectAll.prop("indeterminate", false);
    } else if ( resultsL !== 0 && selectedL !== 0 && resultsL !== selectedL ) {
      toggleSelectAll.prop("indeterminate", true);
    } else if ( selectedL === 0 ) {
      toggleSelectAll.prop("indeterminate", false);
      toggleSelectAll.prop("checked", false);
    }
    self.trigger("selected");
  }
  function toggleSelect() {
    var $this = $(this);
    var result_uri = $this.closest("[resource]").attr("resource");
    if ( $this.is(":checked") ) {
      self.selected[result_uri] = true;
    } else {
      delete self.selected[result_uri];
    }
    checkToggleSelectAll()
  }

  // Render result
  function renderResult(resultDelta) {

    $(".results", template).removeClass("hidden");

    // Toggle "more results" button & "no more results" alert
    if ( self["v-fs:cursor"][0] === self["v-fs:estimated"][0] ) {
      moreResults.addClass("hidden");
      allResults.addClass("hidden");
      noMoreResults.removeClass("hidden");
    } else {
      moreResults.removeClass("hidden");
      allResults.removeClass("hidden");
      noMoreResults.addClass("hidden");
    }
    // Toggle "not found" alert & "no more results" alert
    if ( resultDelta.length ) {
      notFound.addClass("hidden");
    } else {
      notFound.removeClass("hidden");
      noMoreResults.addClass("hidden");
    }

    // Render each result
    var total = self["v-fs:authorized"][0];
    var delta = resultDelta.length;

    // New search triggered
    if ( total === delta ) {
      resultContainer.empty();
    }
    return resultDelta.map(function (result, i) {
      var tmpl = result.present(resultContainer, individual.resultTemplate);
      var serialNumber = total - delta + i + 1;
      $(".serial-number", tmpl).text(serialNumber);
      if (serialNumber === self.marked + 1) {
        tmpl.addClass("warning");
      }
      tmpl.find(".toggle-select").prop("checked", self.selected[result.id] ? true : false);

      setTimeout(function () {
        $("td", tmpl).each( function () {
          var text = this.innerText || this.textContent;
          if (text && text.length > 100) {
            var $this = $(this);
            var contents = $this.contents();
            var wrapper = $("<div class='td-wrapper'></div>").append(contents);
            $this.empty().append(wrapper);
            wrapper.popover({
              content: wrapper.html(),
              html: true,
              placement: "top"
            }).tooltip({
              title: new veda.IndividualModel("v-fs:ClickToViewContent")["rdfs:label"].join(" "),
              placement: "bottom",
              delay: { show: 750, hide: 0 }
            });
          }
        });
      }, 300);
      return tmpl;
    });
  }

  // Spinner
  function toggleSpin(el) {
    var $el = $(el);
    var hasSpinner = $el.children(".fa-spinner");
    if ( hasSpinner.length ) {
      $el.removeClass("disabled");
      hasSpinner.remove();
    } else {
      $el.addClass("disabled");
      $("<i class='fa fa-spinner fa-pulse fa-lg fa-fw'></i>").appendTo(el);
    }
  }

  // Show results on load if they are available (e.g. if we came back)
  if ( self.hasValue("v-fs:searchResult") ) {
    renderResult( self["v-fs:searchResult"] );
    checkToggleSelectAll();
    if ( location.hash.indexOf(individual.id) >= 0 ) {
      scrollTo(self.scroll);
    }
  // Search on load
  } else if ( individual.hasValue("v-fs:searchOnLoad", true) ) {
    self.search()
      .then(renderResult)
      .then(function () {
        if ( location.hash.indexOf(individual.id) >= 0 ) {
          scrollTo(self.scroll);
        }
      });
  }

  //# sourceURL=v-fs:AttributiveSearchInlineTemplate_post
</script>
  """ ;
.

### INDIVIDUALS ###

v-fs:TestSearch
  rdf:type v-fs:AttributiveSearch ;
  rdfs:label "Тестовый поиск"@ru ;
  rdfs:label "Test search"@en ;
  v-fs:searchBlank v-fs:TestBlank ;
  v-fs:searchBlankTemplate v-fs:TestBlankTemplate ;
  v-fs:searchResultTemplate v-fs:TestResultTemplate ;
  v-fs:fulltextQuery "('rdf:type'=='v-s:Person')" ;
  v-fs:sortOrder "'rdfs:label' asc" ;
.

v-fs:TestBlank
  rdf:type v-fc:Blank ;
  rdfs:label "Тестовый бланк"@ru ;
  rdfs:label "Test blank"@en ;
  v-fc:targetType v-s:Person ;
  v-s:firstName "Роман" ;
  v-s:lastName "Карпов" ;
  v-s:middleName "Константинович" ;
.

v-fs:TestBlankTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Шаблон бланка поиска персоны"@ru ;
  rdfs:label "Person search blank template"@en ;
  v-ui:template """
<div class="row">
  <div class="col-md-3">
    <em about="v-s:lastName" property="rdfs:label">Фамилия</em>
    <veda-control property="v-s:lastName" data-type="string"></veda-control>
    <div property="v-s:lastName"></div>
  </div>
  <div class="col-md-3">
    <em about="v-s:firstName" property="rdfs:label">Имя</em>
    <veda-control property="v-s:firstName" data-type="string"></veda-control>
    <div property="v-s:firstName"></div>
  </div>
  <div class="col-md-3">
    <em about="v-s:middleName" property="rdfs:label">Отчество</em>
    <veda-control property="v-s:middleName" data-type="string"></veda-control>
    <div property="v-s:middleName"></div>
  </div>
  <div class="col-md-3">
    <em about="v-s:birthday" property="rdfs:label">День рождения</em>
    <veda-control property="v-s:birthday" data-type="dateTime"></veda-control>
    <div property="v-s:birthday"></div>
  </div>
</div>
  """ ;
.

v-fs:TestResultTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Шаблон отображения результатов поиска персоны"@ru ;
  rdfs:label "Person search result template"@en ;
  v-ui:template """
<table class="table table-bordered">
  <thead class="result-header">
    <tr>
      <th width="1%">#</th>
      <th width="1%"><span class="glyphicon glyphicon-search"></span></th>
      <th width="30%" class="orderby" data-orderby="v-s:lastName"><span about="v-s:lastName" property="rdfs:label"></span></th>
      <th width="30%" class="orderby" data-orderby="v-s:firstName"><span about="v-s:firstName" property="rdfs:label"></span></th>
      <th width="30%" class="orderby" data-orderby="v-s:middleName"><span about="v-s:middleName" property="rdfs:label"></span></th>
    </tr>
  </thead>
  <tbody class="result-container">
    <tr>
      <td class="serial-number"></td>
      <td about="@" data-template="v-ui:IconModalTemplate"></td>
      <td property="v-s:lastName"></td>
      <td property="v-s:firstName"></td>
      <td property="v-s:middleName"></td>
    </tr>
  </tbody>
</table>
  """ ;
.

v-fs:FulltextSearch
  rdf:type v-fs:AttributiveSearch ;
  rdfs:label "Полнотекстовый поиск"@ru ;
  rdfs:label "Fulltext search"@en ;
  v-fs:searchBlank v-fs:FulltextBlank ;
  v-fs:searchBlankTemplate v-fs:FulltextBlankTemplate ;
  v-fs:searchResultTemplate v-fs:FulltextResultTemplate ;
.

v-fs:FulltextBlank
  rdf:type v-fc:Blank ;
  rdfs:label "Тестовый бланк"@ru ;
  rdfs:label "Test blank"@en ;
  v-fc:targetType v-s:UserThing ;
.

v-fs:AdvancedSearchBundle
  rdf:type v-s:Bundle ;
  rdfs:label "Расширенный поиск"@ru ;
  rdfs:label "Advanced search"@en ;
.

v-fs:FulltextBlankTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Шаблон бланка полнотекстового поиска"@ru ;
  rdfs:label "Fulltext search blank template"@en ;
  v-ui:template """
<div class="row">
  <style>
    .input-group input {
      border-top-left-radius: 4px!important;
      border-bottom-left-radius: 4px!important;
    }
  </style>
  <div class="col-md-12">
    <h2 about="v-fs:EnterQuery" property="rdfs:label"></h2>
    <div class="input-group">
      <veda-control property="*" data-type="string"></veda-control>
      <span class="input-group-btn">
        <button class="btn btn-primary search-button" id="custom-search-button" type="button" about="v-fs:Find" property="rdfs:label"></button>
      </span>
    </div>
    <small class="advanced-toggle text-muted" about="v-fs:AdvancedSearchBundle" property="rdfs:label" style="border-bottom:1px dashed #707070; cursor:pointer;"></small>
    <div class="advanced-search hidden panel panel-default margin-md">
      <div class="panel-body bg-default">
        <em about="rdf:type" property="rdfs:label"></em>
        <div rel="rdf:type" data-template="v-ui:LabelTemplate"></div>
        <veda-control rel="rdf:type" data-type="link" data-query-prefix="'rdf:type'=='owl:Class' && 'rdfs:subClassOf'=='v-s:UserThing'" class="fulltext dropdown"></veda-control>
      </div>
    </div>
  </div>
</div>
<script>
  var find = container.siblings(".search-actions").find("#search-button.search-button").addClass("hidden");
  var customFind = $("#custom-search-button.search-button", template);
  customFind.click(function () {
    if ( $("input", template).val() ) {
      find.click();
    }
  });
  $("input", template).keydown(function (e) {
    if (e.which === 13 && this.value) {
      var value = this.value;
      individual.set("*", [value]);
      find.click();
    }
  });
  if (individual.advanced) {
    $(".advanced-search", template).removeClass("hidden");
  }
  $(".advanced-toggle", template).click(function (e) {
    e.preventDefault();
    individual.advanced = !individual.advanced;
    if (individual.advanced) {
      $(".advanced-search", template).removeClass("hidden");
    } else {
      $(".advanced-search", template).addClass("hidden");
    }
  });
  //# sourceURL=v-fs:FulltextBlankTemplate_post
</script>
  """ ;
.

v-fs:FulltextResultTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Шаблон отображения результатов полнотекстового поиска"@ru ;
  rdfs:label "Fulltext search result template"@en ;
  v-ui:template """
<table class="table table-bordered table-condensed">
  <thead class="result-header">
    <tr>
      <th width="1%"><input type="checkbox" class="toggle-select-all"></th>
      <th width="1%">#</th>
      <th width="1%"><span class="glyphicon glyphicon-search"></span></th>
      <th width="5%" class="orderby" data-orderby="rdf:type.rdfs:label"><span about="rdf:type" property="rdfs:label"></span></th>
      <th width="30%" class="orderby" data-orderby="rdfs:label"><span about="rdfs:label" property="rdfs:label"></span></th>
      <th width="5%" class="orderby" data-orderby="v-s:created"><span about="v-s:created" property="rdfs:label"></span></th>
      <th width="5%" class="orderby" data-orderby="v-s:creator"><span about="v-s:creator" property="rdfs:label"></span></th>
    </tr>
  </thead>
  <tbody class="result-container">
    <tr>
      <td width="1%"><input type="checkbox" class="toggle-select"></td>
      <td class="serial-number"></td>
      <td about="@"><a href="#/@" class="glyphicon glyphicon-search"></a></td>
      <td about="@" rel="rdf:type" data-template="v-ui:LabelTemplate"></td>
      <td about="@" property="rdfs:label"></td>
      <td about="@" property="v-s:created"></td>
      <td about="@" rel="v-s:creator" data-template="v-ui:LabelTemplate"></td>
    </tr>
  </tbody>
</table>
  """ ;
.

v-fs:MinimalSearch
  rdf:type v-fs:AttributiveSearch ;
  rdfs:label "Минимальный поиск"@ru ;
  rdfs:label "Minimal search"@en ;
  v-fs:searchBlank v-fs:MinimalSearchBlank ;
  v-fs:searchOnLoad true ;
  v-fs:loadAll true ;
.

v-fs:MinimalSearchBlank
  rdf:type v-fc:Blank ;
  rdfs:label "Тестовый бланк"@ru ;
  rdfs:label "Test blank"@en ;
  v-fc:targetType rdf:Property ;
.

v-fs:MinimalSearchResultTemplate
  rdf:type v-ui:ClassTemplate ;
  v-ui:forClass v-fs:AttributiveSearch ;
  rdfs:label "Шаблон отображения результатов минимального поиска"@ru ;
  rdfs:label "Minimal search result template"@en ;
  v-ui:template """
<table class="table table-condensed table-striped">
  <thead class="result-header">
    <tr>
      <th width="1%">#</th>
      <th width="1%"><span class="glyphicon glyphicon-search"></span></th>
      <th>@</th>
      <th class="orderby" data-orderby="rdfs:label"><span about="rdfs:label" property="rdfs:label"></span></th>
    </tr>
  </thead>
  <tbody class="result-container">
    <tr>
      <td class="serial-number"></td>
      <td about="@" data-template="v-ui:IconModalTemplate"></td>
      <td property="@"></td>
      <td about="@" property="rdfs:label"></td>
    </tr>
  </tbody>
</table>
  """ ;
.

# ------------------------------------------------------------ УПРАВЛЕНИЕ ПРАВАМИ --

v-fs:AttributiveSearch_permission1
  rdf:type v-s:PermissionStatement ;
  v-s:permissionObject v-fs:AttributiveSearch ;
  v-s:permissionSubject cfg:AllUsersGroup ;
  v-s:canCreate "true"^^xsd:boolean ;
  rdfs:label "C. Все пользователи. Класс v-fs:AttributiveSearch" ;
.
