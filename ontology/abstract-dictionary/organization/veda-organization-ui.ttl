
@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix v-s: <http://semantic-machines.com/veda/veda-schema/> .
@prefix v-ui: <http://semantic-machines.com/veda/veda-ui/> .
@prefix d: <http://semantic-machines.com/veda/veda-data/> .
@prefix v-fs: <http://semantic-machines.com/veda/veda-function-search/> .
@prefix v-fc: <http://semantic-machines.com/veda/veda-function-create/> .

<http://semantic-machines.com/veda/veda-organization-ui>
  rdf:type owl:Ontology ;
  rdfs:label "Онтология системы Veda. Организация. UI."@ru ;
  rdfs:label "Veda system ontology. Organization. UI."@en ;
#  owl:versionInfo "1.3" ;
  v-s:loadPriority 6 ;
.

v-s:DeleteAppointmentBundle
  rdf:type v-s:Bundle ;
  rdfs:label "Удалить назначение"@ru ;
  rdfs:label "Delete assignment"@en ;
.
v-s:AppointmentBundle
  rdf:type v-s:Bundle ;
  rdfs:label "Перевести на другую должность"@ru ;
  rdfs:label "Transfer to another position"@en ;
.
v-s:AnotherDepartmentBundle
  rdf:type v-s:Bundle ;
  rdfs:label "Перевести должность в другой отдел"@ru ;
  rdfs:label "Move to another department"@en ;
.
v-s:DismissBundle
  rdf:type v-s:Bundle ;
  rdfs:label "Уволить сотрудника"@ru ;
  rdfs:label "To dismiss"@en ;
.
v-s:AddInGroupOrgWithVedaAccount
  rdf:type v-s:Bundle ;
  rdfs:label "Учётка в Veda"@ru ;
  rdfs:label "Group with an Veda account"@en ;
.
v-s:AddInGroupOrgWithVedaADAccount
  rdf:type v-s:Bundle ;
  rdfs:label "Учётка в AD"@ru ;
  rdfs:label "Group with an AD account"@en ;
.
v-s:AddInGroupOrgWithLimitedClassTypes
  rdf:type v-s:Bundle ;
  rdfs:label "Ограниченный доступ"@ru ;
  rdfs:label "Group with an Veda account"@en ;
.
v-s:AddInGroupOrgWithoutLimitedClassTypes
  rdf:type v-s:Bundle ;
  rdfs:label "Потенциальный доступ ко всему"@ru ;
  rdfs:label "Group with an AD account"@en ;
.
v-s:EmployeeValidationBundle
  rdf:type v-s:Bundle ;
  rdfs:label "В организацию уже введен сотрудик с данными ФИО и датой рождения"@ru ;
  rdfs:label "The organization has already entered an employee with this full name and date of birth"@en ;
.


# ------------------------------------------------------------ МОДЕЛИ --

v-s:OrganizationUnitModel
  rdf:type v-ui:ClassModel ;
  v-ui:forClass v-s:OrganizationUnit ;
  v-ui:forClass v-s:OrgGroup ;
  v-ui:forClass v-s:Organization ;
  v-ui:forClass v-s:Subsidiary ;
  v-ui:forClass v-s:Department ;
  v-ui:forClass v-s:Position ;
  v-ui:forClass v-s:Appointment ;
  rdfs:comment "Модель для класса v-s:OrganizationUnit"@ru ;
  rdfs:comment "Model for v-s:OrganizationUnit class"@en ;
  rdfs:label "Модель организационной единицы"@ru ;
  rdfs:label "Organization unit model"@en ;
  v-s:script """
  /**
   * @method
   * @param unit {String/veda.IndividualModel} Super unit uri or individual.
   * @return {boolean}.
   */
  this.isSubUnitOf = function (unit, depth) {
    if (unit instanceof veda.IndividualModel) {
      unit = unit.id;
    }
    depth = depth || 0;
    return this.load().then(function (self) {
      if ( !self.hasValue("v-s:parentUnit") || depth > 16 ) {
        return false;
      } else if ( self.hasValue("v-s:parentUnit", unit) ) {
        return true;
      } else {
        return self.isSubUnitOf.call(self["v-s:parentUnit"][0], unit, depth + 1);
      }
    });
  };

  /**
   * @method
   * @param unit {String/veda.IndividualModel} Super unit uri or individual.
   * @return {veda.IndividualModel | false }.
   */
  this.getChief = function (chiefId, depth) {
    depth = depth || 0;
    return this.load().then(function (self) {
      chiefId = chiefId || self.id;
      if ( (self.hasValue("v-s:hasChief") || depth > 16) && self["v-s:hasChief"][0].id !== chiefId ) {
        return self["v-s:hasChief"][0];
      } else if ( self.hasValue("v-s:parentUnit") ) {
        return self.getChief.call(self["v-s:parentUnit"][0], chiefId, depth + 1);
      }
    });
  };

  this.getFieldChief = function (depth) {
    depth = depth || 0;
    return this.load().then(function (self) {
      if ( self.hasValue("v-s:hasFieldChief") || depth > 16 ) {
        return self["v-s:hasFieldChief"][0];
      } else if ( self.hasValue("v-s:parentUnit") ) {
        return self.getFieldChief.call(self["v-s:parentUnit"][0], depth + 1);
      }
    });
  };

  /**
   * @method
   * @param unit {String/veda.IndividualModel} Super unit uri or individual.
   * @return {veda.IndividualModel | false }.
   */
  this.getOrganization = function (depth) {
    depth = depth || 0;
    return this.load().then(function (self) {
      if ( self.hasValue("rdf:type", "v-s:Organization") || depth > 16) {
        return self;
      } else if ( self.hasValue("v-s:parentOrganization", "v-s:Organization") ) {
        return self["v-s:parentOrganization"][0];
      } else if ( self.hasValue("v-s:parentUnit") ) {
        return self.getOrganization.call(self["v-s:parentUnit"][0], depth + 1);
      }
    });
  };
  //# sourceURL=v-s:OrganizationUnitModel
  """ ;
.

# ------------------------------------------------------------ СПЕЦИФИКАЦИИ --

v-s:PsHasSubsidiaryForOrganization
  rdf:type v-ui:ObjectPropertySpecification ;
  v-ui:forClass v-s:Organization ;
  v-ui:forProperty v-s:hasSubsidiary ;
  v-ui:minCardinality 0 ;
  v-ui:maxCardinality 100 ;
  v-ui:rangeRestriction v-s:Subsidiary ;
.

v-s:PsTaxIdForOrganization
  rdf:type v-ui:DatatypePropertySpecification ;
  v-ui:forClass v-s:Organization ;
  v-ui:forProperty v-s:taxId ;
  v-ui:minCardinality 1 ;
  v-ui:maxCardinality 1 ;
  v-ui:regexp "^([A-Z]{2,3}[0-9]{4,}|([0-9]{10}|[0-9]{12}))$" ;
  v-ui:tooltip "Цифро-буквенное значение, минимум 6 символов. Примеры: 123456789101, KZ4438, NL123456789B11"@ru ;
  v-ui:tooltip "Alphanumeric value, 6 characters minimum. Ex: 123456789101, KZ4438, NL123456789B11"@en ;
.

# Перенести в управление контрагентами

v-s:PsHasContractorOrganization
  rdf:type v-ui:ObjectPropertySpecification ;
  v-ui:forClass v-s:Organization;
  v-ui:forProperty v-s:hasContractor ;
  v-ui:minCardinality 0 ;
  v-ui:maxCardinality 100 ;
  v-ui:rangeRestriction v-s:Contractor;
  rdfs:label "Спецификация свойства v-s:hasContractor для класса v-s:Organization"@ru ;
  rdfs:label "v-s:hasContractor property specification for v-s:Organization"@en ;
.

v-s:PsHasClassifierCountryOrganization
  rdf:type v-ui:ObjectPropertySpecification ;
  v-ui:forClass v-s:Organization;
  v-ui:forProperty v-s:hasClassifierCountry ;
  v-ui:minCardinality 1 ;
  v-ui:maxCardinality 1 ;
  v-ui:defaultValue d:Country_RUS;
  rdfs:label "Спецификация свойства v-s:hasClassifierCountry для класса v-s:Organization"@ru ;
  rdfs:label "v-s:hasClassifierCountry property specification for v-s:Organization"@en ;
.

v-s:PslabelForOrganization
  rdf:type v-ui:PropertySpecification ;
  v-ui:forClass v-s:Organization ;
  v-ui:forProperty rdfs:label ;
  v-ui:forProperty v-s:shortLabel;
  v-ui:forProperty v-s:legalAddress;
  v-ui:forProperty v-s:postalAddress;
  v-ui:minCardinality 1 ;
  v-ui:maxCardinality 100 ;
  rdfs:label "Спецификация свойств rdfs:label, v-s:shortLabel, v-s:legalAddress, v-s:postalAddress для класса v-s:Organization"@ru ;
  rdfs:label "rdfs:label, v-s:shortLabel, v-s:legalAddress, v-s:postalAddress property specification for v-s:Organization"@en ;
.

v-s:taxRegistrationCauseForOrganization
  rdf:type v-ui:PropertySpecification ;
  v-ui:forClass v-s:Organization ;
  v-ui:forProperty v-s:taxRegistrationCause;
  v-ui:minCardinality 0 ;
  v-ui:maxCardinality 1;
  v-ui:regexp "^[0-9]{9}$";
  rdfs:label "Спецификация свойств v-s:taxRegistrationCause для класса v-s:Organization"@ru ;
  rdfs:label "v-s:taxRegistrationCause property specification for v-s:Organization"@en ;
  v-ui:tooltip "Числовое значение, 9 символов, например: 123456789"@ru ;
  v-ui:tooltip "Numeric value, 9 characters, i.e. 123456789"@en ;
.

v-s:PsContractorProfileDateToFact
  rdf:type v-ui:ObjectPropertySpecification ;
  v-ui:forClass v-s:Organization ;
  v-ui:forProperty v-s:dateToFact ;

  rdfs:label "Спецификация к свойству v-s:dateToFact для класса v-s:ContractorProfile"@ru ;
  rdfs:label "Spec for property v-s:dateToFact for class v-s:ContractorProfile"@en ;
  v-ui:placeholder "Дата ликвидации юр лица"@ru ;
  v-ui:placeholder "Registered legal persons"@en ;
.

v-s:PsContractorProfileDateFromFact
  rdf:type v-ui:ObjectPropertySpecification ;
  v-ui:forClass v-s:Organization ;
  v-ui:forProperty v-s:dateFromFact ;
  v-ui:placeholder "Дата регистрации юр лица"@ru ;
  v-ui:placeholder "Registered legal persons"@en ;
  rdfs:label "Спецификация к свойству v-s:dateFromFact для класса v-s:ContractorProfile"@ru ;
  rdfs:label "Spec for property v-s:dateFromFact for class v-s:ContractorProfile"@en ;
.

v-s:PsParentsForDepartment
  rdf:type v-ui:ObjectPropertySpecification ;
  v-ui:forClass v-s:Department ;
  v-ui:forProperty v-s:parentOrganization ;
  v-ui:forProperty v-s:parentUnit ;
  v-ui:minCardinality 1 ;
  v-ui:maxCardinality 1 ;
  rdfs:label "Спецификация к свойствам v-s:parentOrganization и v-s:parentUnit для класса v-s:Department"@ru ;
  rdfs:label "Spec for property v-s:parentOrganization and v-s:parentUnit for class v-s:Department"@en ;
.

v-s:PsTextLabelForDepartment
  rdf:type v-ui:ObjectPropertySpecification ;
  v-ui:forClass v-s:Department ;
  v-ui:forProperty rdfs:label ;
  v-ui:forProperty v-s:shortLabel ;
  v-ui:forProperty v-s:subjectCode ;
  v-ui:minCardinality 1 ;
  v-ui:maxCardinality 100 ;
  rdfs:label "Спецификация к свойствам rdfs:label и v-s:shortLabel и v-s:subjectCode для класса v-s:Department"@ru ;
  rdfs:label "Spec for property rdfs:label and v-s:shortLabel and v-s:subjectCode for class v-s:Department"@en ;
.

v-s:PsParentUnitForSubsidiary
  rdf:type v-ui:ObjectPropertySpecification ;
  v-ui:forClass v-s:Subsidiary ;
  v-ui:forProperty v-s:parentUnit ;
  v-ui:minCardinality 1 ;
  v-ui:maxCardinality 100 ;
  v-ui:rangeRestriction v-s:Organization ;
.

# ------------------------------------------------------------ СТРОКИ --

v-s:NonUniqueTaxId
  rdf:type v-s:Bundle ;
  rdfs:label "Сообщение не уникальный ИНН"@ru ;
  rdfs:label "Non unique tax id message"@en ;
  rdfs:comment "Организация с таким ИНН уже существует"@ru ;
  rdfs:comment "Organization with this tax number already exists"@en ;
.
v-s:ForSafeTaxId
  rdf:type v-s:Bundle ;
  rdfs:label "Сообщение не уникальный ИНН"@ru ;
  rdfs:label "Non unique tax id message"@en ;
  rdfs:comment "Нельзя создать огранизацию с таким ИНН"@ru ;
  rdfs:comment "Нельзя создать огранизацию с таким ИНН"@en ;
.
v-s:LegalEntityExistencePeriodBundle
  rdf:type v-s:Bundle ;
  rdfs:label "Период существования юридического лица"@ru ;
  rdfs:label "Legal entity existence period"@en ;
.
v-s:AddProfile
  rdf:type v-s:Bundle ;
  rdfs:label "Создать досье"@ru ;
  rdfs:label "Add profile"@en ;
.
v-s:AddSubsidiary
  rdf:type v-s:Bundle ;
  rdfs:label "Добавить филиал"@ru ;
  rdfs:label "Add subsidiary"@en ;
.
v-s:DepartmentCode
  rdf:type v-s:Bundle ;
  rdfs:label "Код подразделения"@ru ;
  rdfs:label "Department code"@en ;
.
v-s:PositionCode
  rdf:type v-s:Bundle ;
  rdfs:label "Код должности"@ru ;
  rdfs:label "Position code"@en ;
.
v-s:NonUniqueDepartmentCode
  rdf:type v-s:Bundle ;
  rdfs:label "Сообщение о не уникальном коде подразделения"@ru ;
  rdfs:label "Non unique department code message"@en ;
  rdfs:comment "Подразделение с таким кодом уже существует"@ru ;
  rdfs:comment "Department with this code already exists"@en ;
.
v-s:NonUniquePositionCode
  rdf:type v-s:Bundle ;
  rdfs:label "Сообщение о не уникальном коде должности"@ru ;
  rdfs:label "Non unique position code message"@en ;
  rdfs:comment "Должность с таким кодом уже существует"@ru ;
  rdfs:comment "Position with this code already exists"@en ;
.
v-s:NonUniqueTabNumber
  rdf:type v-s:Bundle ;
  rdfs:label "Сообщение о не уникальном табельном номере"@ru ;
  rdfs:label "Non unique tab number message"@en ;
  rdfs:comment "Персона с таким табельным номером уже существует"@ru ;
  rdfs:comment "Person with this tab number already exists"@en ;
.
v-s:NotValidCode
  rdf:type v-s:Bundle ;
  rdfs:label "Сообщение о не корректном коде (должности, подразделения, табельном номере)"@ru ;
  rdfs:label "Not valid subject code message"@en ;
  rdfs:comment "Поле может содержать только латинские буквы и цифры"@ru ;
  rdfs:comment "Field must consist only a-z character and digits"@en ;
.
v-s:DefaultAppointmentBundle
  rdf:type v-s:Bundle ;
  rdfs:label "Основное назначение"@ru ;
  rdfs:label "Default appointment"@en ;
.
# ------------------------------------------------------------ ШАБЛОНЫ --
v-s:TS_Organization
  rdf:type v-ui:TemplateSpecification ;
  v-ui:forClass v-s:Organization ;
  v-ui:defaultTemplate v-s:OrganizationTemplate ;
  v-s:loadPriority "15" ;
.
v-s:TS_Department rdf:type 
  v-ui:TemplateSpecification;
  v-s:loadPriority "15"^^xsd:integer;
  v-ui:defaultTemplate v-s:DepartmentTemplate;
  v-ui:forClass v-s:Department
.
v-s:TS_Subsidiary 
  rdf:type v-ui:TemplateSpecification;
  v-s:loadPriority "15"^^xsd:integer;
  v-ui:defaultTemplate v-s:SubsidiaryTemplate;
  v-ui:forClass v-s:Subsidiary
.
v-s:TS_Position
  rdf:type v-ui:TemplateSpecification;
  v-s:loadPriority "15"^^xsd:integer;
  v-ui:defaultTemplate v-s:PositionTemplate;
  v-ui:forClass v-s:Position
.
v-s:TS_Person
  rdf:type v-ui:TemplateSpecification;
  v-s:loadPriority "15"^^xsd:integer;
  v-ui:defaultTemplate v-s:PersonTemplate;
  v-ui:forClass v-s:Person
.

v-s:OrganizationTemplate
  rdf:type v-ui:ClassTemplate ;
  v-ui:forClass v-s:Organization ;
  rdfs:label "Шаблон для класса v-s:Organization"@ru ;
  rdfs:label "Template for v-s:Organization class"@en ;
  v-ui:template """
<script>
  var _class = new veda.IndividualModel("v-s:Subsidiary");

  Promise.all([_class.rights, individual.rights]).then(function (rights) {
    var class_rights = rights[0],
        individual_rights = rights[1];
    if ( !class_rights.hasValue("v-s:canCreate", true) || !individual_rights.hasValue("v-s:canUpdate", true) ) {
      $("#add-subsidiary", template).remove();
    }
  }).catch(function (error) {
    console.log(error);
  });

  var prevTaxId = individual.hasValue("v-s:taxId") && individual["v-s:taxId"][0].toString();

  // Validation
  template.on("validate", function () {
    var result = {state: true},
        regexp;
    if ( individual.hasValue("v-s:hasClassifierCountry", "d:Country_RUS") && individual.hasValue("v-s:hasClassifierLegalForm", "d:OKOPF_50102") ) {
      regexp = /^([0-9]{12})$/gi;
    } else if ( individual.hasValue("v-s:hasClassifierCountry", "d:Country_RUS") ) {
      regexp = /^([0-9]{10})$/gi;
    } else if ( individual.hasValue("v-s:hasClassifierCountry", "d:Country_NLD") ) {
      regexp = /^[A-Z]{1,3}[0-9]{9}[B]{1}[0-9]{2}$/gi;
    } else if ( individual.hasValue("v-s:hasClassifierCountry") ) {
      regexp = /^[A-Z]{1,3}[0-9]{4,}$/gi;
    }
    if ( !individual.hasValue("v-s:taxId") ) {
      result["v-s:taxId"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      }
    } else {
      // Check regexp
      var taxId = individual["v-s:taxId"][0].toString();
      if(taxId != '0000000000' && taxId != '000000000000') {
        result["v-s:taxId"] = {
          state: regexp.test( taxId ),
          cause: ["v-ui:regexp"]
        }
      } else {
        result["v-s:taxId"] = {
        state: false,
        cause: ["v-s:ForSafeTaxId"]
        }
      }

      // Check unique
      var newTaxId = individual.hasValue("v-s:taxId") && individual["v-s:taxId"][0].toString();
      if ( prevTaxId !== newTaxId ) { prevTaxId = newTaxId; }
      if ( result["v-s:taxId"].state ) {
        veda.Backend.query(veda.ticket, "'rdf:type'==='v-s:Organization' && 'v-s:taxId'=='" + taxId + "'").then(function (queryResult) {
          var queryResult = queryResult.result;
          result["v-s:taxId"] = {
            state: (!queryResult.length || queryResult[0] === individual.id),
            cause: ["v-s:NonUniqueTaxId"]
          }
          template.trigger("validated", result);
        });
      }
    }
    // Если значение поля v-s:hasClassifierCountry=d:Country_RUS то поле v-s:hasClassifierLegalForm Обязательное
    if (individual.hasValue("v-s:hasClassifierCountry", "d:Country_RUS") ) {
      result["v-s:hasClassifierLegalForm"] = {
        state: individual.hasValue("v-s:hasClassifierLegalForm"),
        cause: ["v-ui:minCardinality"]
      }
    }
    // Если значение поля v-s:hasClassifierCountry=d:Country_RUS и поле v-s:hasClassifierLegalForm=d:OKOPF_50102 то поле v-s:taxRegistrationCause должно быть обязательным.
    if (individual.hasValue("v-s:hasClassifierCountry", "d:Country_RUS") && !individual.hasValue("v-s:hasClassifierLegalForm", "d:OKOPF_50102") && !individual.hasValue("v-s:hasClassifierLegalForm", "d:OKOPF_50000") ) {
      result["v-s:taxRegistrationCause"] = {
        state: /^[0-9]{9}$/.test(individual["v-s:taxRegistrationCause"][0]),
        cause: ["v-ui:regexp"]
      }
    }
    template.trigger("validated", result);
  });

  //# sourceURL=v-s:OrganizationTemplate_pre
</script>
<div>
  <div class="container sheet">
    <h2>
      <span about="v-s:Organization" property="rdfs:label"></span>
      <small about="@" property="rdfs:label"></small>
    </h2>
    <hr>
    <div class="row">
      <div class="col-md-4">
        <em about="v-s:shortLabel" property="rdfs:label"></em>
        <div property="v-s:shortLabel" class="view -edit -search"></div>
        <veda-control data-type="string" property="v-s:shortLabel" class="-view edit search"></veda-control>
      </div>
      <div class="col-md-8">
        <em about="rdfs:label" property="rdfs:label"></em>
        <div property="rdfs:label" class="view -edit -search"></div>
        <veda-control data-type="string" property="rdfs:label" class="-view edit search"></veda-control>
      </div>
    </div>
    <hr class="view -edit -search">
    <div class="row">
      <div class="col-md-4">
        <em about="v-s:hasClassifierCountry" property="rdfs:label"></em>
        <div rel="v-s:hasClassifierCountry" class="view -edit search" data-template="v-ui:LabelTemplate"></div>
        <veda-control data-type="link" rel="v-s:hasClassifierCountry" class="-view edit search fulltext" data-template="{individual['v-s:shortLabel'][0] + ' | ' + individual['rdfs:label'][0]}"></veda-control>
      </div>
      <div class="col-md-8">
        <em about="v-s:hasClassifierLegalForm" property="rdfs:label"></em>
        <div rel="v-s:hasClassifierLegalForm" class="view -edit search" data-template="v-ui:LabelTemplate"></div>
        <veda-control data-type="link" rel="v-s:hasClassifierLegalForm" class="-view edit search fulltext"></veda-control>
      </div>
    </div>
    <hr class="view -edit -search">
    <div class="row">
      <div class="col-sm-4">
        <em about="v-s:taxId" property="rdfs:label"></em>
        <div property="v-s:taxId" class="view -edit -search"></div>
        <veda-control data-type="string" property="v-s:taxId" class="-view edit search"></veda-control>
      </div>
      <div class="col-sm-4">
        <em about="v-s:taxRegistrationCause" property="rdfs:label"></em>
        <div property="v-s:taxRegistrationCause" class="view -edit -search"></div>
        <veda-control data-type="string" property="v-s:taxRegistrationCause" class="-view edit search"></veda-control>
      </div>
      <div class="col-sm-4">
        <em about="v-s:taxRegistrationNumber" property="rdfs:label"></em>
        <div property="v-s:taxRegistrationNumber" class="view -edit -search"></div>
        <veda-control data-type="string" property="v-s:taxRegistrationNumber" class="-view edit search"></veda-control>
      </div>
    </div>

    <hr class="view -edit -search">

    <div class="row">
      <div class="col-sm-4">
        <em about="v-s:legalAddress" property="rdfs:label"></em>
        <div property="v-s:legalAddress" class="view -edit -search"></div>
        <veda-control data-type="text" rows="3" property="v-s:legalAddress" class="-view edit search"></veda-control>
      </div>
      <div class="col-sm-4">
        <em about="v-s:postalAddress" property="rdfs:label"></em>
        <div property="v-s:postalAddress" class="view -edit -search"></div>
        <veda-control data-type="text" rows="3" property="v-s:postalAddress" class="-view edit search"></veda-control>
      </div>
    </div>
    <hr class="view -edit -search">
    <em about="v-s:LegalEntityExistencePeriodBundle" property="rdfs:label"></em>
    <div class="row">
      <div class="col-md-4">
        <div property="v-s:dateFromFact" class="view -edit -search"></div>
        <veda-control property="v-s:dateFromFact" data-type="date" class="-view edit search"></veda-control>
      </div>
      <div class="col-md-4">
        <div property="v-s:dateToFact" class="view -edit -search"></div>
        <veda-control property="v-s:dateToFact" data-type="date" class="-view edit search"></veda-control>
      </div>
    </div>
    <em about="v-s:hasSubsidiary" property="rdfs:label"></em>
    <table class="table table-condensed table-bordered">
      <thead>
        <tr class="view -edit -search active">
          <th width="1%"><span class="glyphicon glyphicon-search"></th>
          <th about="v-s:shortLabel" property="rdfs:label"></th>
          <th about="v-s:taxRegistrationCause" property="rdfs:label"></th>
          <th about="v-s:postalAddress" property="rdfs:label"></th>
        </tr>
      </thead>
      <tbody rel="v-s:hasSubsidiary" data-embedded="true">
        <tr>
          <td about="@" data-template="v-ui:IconModalTemplate"></td>
          <td>
            <div property="v-s:shortLabel" class="view -edit -search"></div>
            <veda-control property="v-s:shortLabel" data-type="string" class="-view edit search"></div>
          </td>
          <td>
            <div property="v-s:taxRegistrationCause" class="view -edit -search"></div>
            <veda-control property="v-s:taxRegistrationCause" data-type="string" class="-view edit search"></div>
          </td>
          <td>
            <div property="v-s:postalAddress" class="view -edit -search"></div>
            <veda-control property="v-s:postalAddress" data-type="string" class="-view edit search"></div>
          </td>
        </tr>
      </tbody>
    </table>
    <div class="view -edit -search">
      <button class="btn btn-success" id="add-subsidiary">
        <span class="glyphicon glyphicon-zoom-in"></span>
        <span about="v-s:AddSubsidiary" property="rdfs:label"></span>
      </button>
    </div>

    <em about="v-s:HeadOrganization" property="rdfs:label"></em>
    <div rel="v-s:parentUnit" class="view -edit -search" data-template="v-ui:LabelTemplate"></div>
    <veda-control data-type="link" rel="v-s:parentUnit" class="-view edit search fulltext"></veda-control>
    <hr class="view -edit -search">

    <div about="@" data-template="v-ui:SystemPropertiesTemplate" data-embedded="true"></div>
    <br>
    <!-- BUTTONS -->
    <div class="actions">
      <span about="@" data-template="v-ui:StandardButtonsTemplate" data-embedded="true" data-buttons="edit save cancel delete journal"></span>
    </div>
  </div>
  <div about="@" class="container sheet view edit -search" data-template="v-s:LinksTemplate" data-embedded="true"></div>
  <div about="@" class="container sheet view -edit -search" data-template="v-s:CommentsTemplate"></div>
</div>
<script>
  //Генерация Uri
  veda.Util.registerHandler(individual, template, "beforeSave", function () {
    var shortLabel = individual["v-s:hasClassifierCountry"][0]["v-s:shortLabel"];
    var taxId = individual["v-s:taxId"] ;
    if ( individual.hasValue("v-s:hasClassifierCountry", "d:Country_RUS") && individual.isNew() ){
      individual.id = "d:org_"+ shortLabel + taxId ;
    } else if ( individual.isNew() ) {
      individual.id = "d:org_"+ taxId ;
    }
  });

  $("#add-subsidiary", template).click(function () {
    var modal = $("#notification-modal-template").html();
    modal = $(modal);
    modal.modal({"show": false});
    $("body").append(modal);
    modal.modal("show");
    template.one("remove", function () {
      modal.modal("hide").remove();
    });
    var cntr = $(".modal-body", modal),
        _class = new veda.IndividualModel("v-s:Subsidiary"),
        subsidiary = new veda.IndividualModel(),
        tmpl = new veda.IndividualModel("v-s:SubsidiaryTemplate");
    subsidiary["rdf:type"] = [_class];
    subsidiary["v-s:backwardTarget"] = [individual];
    subsidiary["v-s:backwardProperty"] = [new veda.IndividualModel("v-s:hasSubsidiary")];
    subsidiary["v-s:canRead"] = [ true ];
    subsidiary.present(cntr, tmpl, "edit");
    subsidiary.one("beforeReset", function () {
      modal.modal("hide").remove();
    });
    subsidiary.one("afterSave", function () {
      modal.modal("hide").remove();
    });
  });
  //# sourceURL=v-s:OrganizationTemplate_post
</script>
  """ ;
.


v-s:hasMembership
  rdf:type owl:ObjectProperty ;
  rdfs:domain v-s:Person ;
  rdfs:label "Досье сотрудника"@ru ;
  rdfs:label "Employee proile"@en ;
  rdfs:range v-s:Membership ;
.

v-s:OrganizationForAdminTemplate
  rdf:type v-ui:ClassTemplate ;
  v-ui:forClass v-s:Organization ;
  rdfs:label "Шаблон для класса v-s:Organization"@ru ;
  rdfs:label "Template for v-s:Organization class"@en ;
  v-ui:template """
<script>


  //# sourceURL=v-s:OrganizationForAdminTemplate_pre
</script>
<div>
  <div class="container sheet">
    <h2>
      <span about="v-s:Organization" property="rdfs:label"></span>
      <small about="@" property="rdfs:label"></small>
    </h2>
    <hr>
    <!--<h3 about="v-s:hasMembership" property="rdfs:label"></h3>-->
    <div class="memberships" data-limit="10"></div>
   
    <div about="@" data-template="v-ui:SystemPropertiesTemplate" data-embedded="true"></div>
    <br>
    <!-- BUTTONS -->
    <div class="actions">
      <span about="@" data-template="v-ui:StandardButtonsTemplate" data-embedded="true" data-buttons="edit save cancel delete journal"></span>
      <span id="rigthsForAdmin" class="hide">
        <button class="btn btn-secondary view -edit -search" id="add-OrgVedaAccount" >
          <span  about="v-s:AddInGroupOrgWithVedaAccount" property="rdfs:label"></span>
        </button>
        <button class="btn btn-secondary view -edit -search" id="add-OrgADAccount" >
          <span  about="v-s:AddInGroupOrgWithVedaADAccount" property="rdfs:label"></span>
        </button>
        <button class="btn btn-secondary view -edit -search" id="add-OrgWithLimited" >
          <span  about="v-s:AddInGroupOrgWithLimitedClassTypes" property="rdfs:label"></span>
        </button>
        <button class="btn btn-secondary view -edit -search" id="add-OrgWithoutLimited" >
          <span  about="v-s:AddInGroupOrgWithoutLimitedClassTypes" property="rdfs:label"></span>
        </button>
      </span>
    </div>
  </div>
  <div about="@" class="container sheet view edit -search" data-template="v-s:LinksTemplate" data-embedded="true"></div>
  <div about="@" class="container sheet view -edit -search" data-template="v-s:CommentsTemplate"></div>
</div>
<script>
  function forAdmin(){
    if (veda.appointment.id == 'cfg:AdministratorAppointment' && individual.id != 'd:org_RU1121003135' )  $("#rigthsForAdmin").removeClass('hide');
  }
  forAdmin();

  $("#add-OrgVedaAccount", template).click(function() {
    var org = individual.id;
    var org1 = org.slice(6);
    var org_gr = new veda.IndividualModel(individual+"_group");

    var _class = new veda.IndividualModel("v-s:Membership"),
        OrgWithVedaAccount = new veda.IndividualModel();
    OrgWithVedaAccount["rdf:type"]=[_class];
    OrgWithVedaAccount["v-s:memberOf"] = [new veda.IndividualModel("v-s:OrganizationsWithVedaAccount")];
    OrgWithVedaAccount["v-s:resource"] = [org_gr];
    OrgWithVedaAccount.id = "v-s:OrganizationsWithVedaAccount" +"_"+org1;
    OrgWithVedaAccount.save();
  });
  $("#add-OrgADAccount", template).click(function() {
    var org = individual.id;
    var org1 = org.slice(6);
    var org_gr = new veda.IndividualModel(individual+"_group");

    var _class = new veda.IndividualModel("v-s:Membership"),
        OrgWithADAccount = new veda.IndividualModel();
    OrgWithADAccount["rdf:type"]=[_class];
    OrgWithADAccount["v-s:memberOf"] = [new veda.IndividualModel("v-s:OrganizationsWithADAccount")];
    OrgWithADAccount["v-s:resource"] = [org_gr];
    OrgWithADAccount.id = "v-s:OrganizationsWithADAccount" +"_"+org1;
    OrgWithADAccount.save();
  });
  $("#add-OrgWithLimited", template).click(function() {
    var org = individual.id;
    var org1 = org.slice(6);
    var org_gr = new veda.IndividualModel(individual+"_group");

    var _class = new veda.IndividualModel("v-s:Membership"),
        OrgWithLimited = new veda.IndividualModel();
    OrgWithLimited["rdf:type"]=[_class];
    OrgWithLimited["v-s:memberOf"] = [new veda.IndividualModel("v-s:OrganizationsWithLimitedClassTypes")];
    OrgWithLimited["v-s:resource"] = [org_gr];
    OrgWithLimited.id = "v-s:OrganizationsWithLimitedClassTypes" +"_"+org1;
    OrgWithLimited.save();
  });
  $("#add-OrgWithoutLimited", template).click(function() {
    var org = individual.id;
    var org1 = org.slice(6);
    var org_gr = new veda.IndividualModel(individual+"_group");

    var _class = new veda.IndividualModel("v-s:Membership"),
        OrgWithoutLimited = new veda.IndividualModel();
    OrgWithoutLimited["rdf:type"]=[_class];
    OrgWithoutLimited["v-s:memberOf"] = [new veda.IndividualModel("v-s:OrganizationsWithoutLimitedClassTypes")];
    OrgWithoutLimited["v-s:resource"] = [org_gr];
    OrgWithoutLimited.id = "v-s:OrganizationsWithoutLimitedClassTypes" +"_"+org1;
    OrgWithoutLimited.save();
  });

  var membershipRegistry = new veda.IndividualModel("v-s:OrganizationMembershipRegistry", false);
  var orgUri = individual.id;
  var membershipContainer = $(".memberships", template);
  membershipRegistry.load().then(function(loaded) {
    loaded["v-fs:top"] = [10];
    loaded["v-fs:fulltextQuery"] = ["'rdf:type' == 'v-s:Membership' && 'v-s:resource' == '" + orgUri + "_group'"];
    //loaded["v-fs:fulltextQuery"] = ["'rdf:type'=='v-s:Membership'"];
    loaded.present(membershipContainer, "v-fs:AttributiveSearchInlineTemplate");
  })
  
  //# sourceURL=v-s:OrganizationTemplate_post
</script>
  """ ;
.

# --------------------------------------------- Реестр, вложенный в шаблон

v-s:OrganizationMembershipRegistry
  a v-fs:AttributiveSearch;
  rdfs:label "Вхождения организации в группы"@ru ;
  rdfs:label "Entries of the organization into groups"@en ;
  v-fs:searchBlank v-s:OrganizationMembershipRegistryBlank ;
  v-fs:searchResultTemplate v-s:OrganizationMembershipRegistryResultTemplate ;
  v-fs:searchOnLoad true ;
.

v-s:OrganizationMembershipRegistryBlank
  rdf:type v-fc:Blank ;
  rdfs:label "Тестовый бланк"@ru ;
  rdfs:label "Test blank"@en ;
  v-fc:targetType v-s:Membership;
.

v-s:OrganizationMembershipRegistryResultTemplate
  rdf:type v-ui:ClassTemplate ;
  v-ui:template """
<table class="table table-condensed table-bordered">
  <thead>
    <tr class="active">
      <th width="1%">#</th>
      <th width="1%"><span class="glyphicon glyphicon-search"></th>
      <th about="rdfs:label" property="rdfs:label"></th>
      <!--<th about="v-s:hasAppointment" property="rdfs:label"></th>
      <th about="mnd-s:hasEmployeeProfile" property="rdfs:label"></th>-->
    </tr>
  </thead>
  <tbody class="result-container">
    <tr>
      <td class="serial-number"></td>
      <td about="@" data-template="v-ui:IconModalTemplate"></td>
      <td about="@" property="rdfs:label" class="view edit -search"></td>
      <!--<td about="@" rel="v-s:hasAppointment" data-template="v-ui:LabelTemplate" class="view edit -search"></td>
      <td about="@" rel="mnd-s:hasEmployeeProfile" class="view edit -search" data-template="v-ui:ClassNameLabelLinkTemplate"></td>-->
    </tr>
  </tbody>
</table>
  """ ;
.







v-s:SubsidiaryTemplate
  rdf:type v-ui:ClassTemplate ;
  v-ui:forClass v-s:Subsidiary ;
  rdfs:label "Шаблон для класса v-s:Subsidiary"@ru ;
  rdfs:label "Template for v-s:Subsidiary class"@en ;
  v-ui:template """
<div class="container sheet">
  <h2>
    <span about="v-s:Subsidiary" property="rdfs:label"></span>
    <small about="@" property="rdfs:label"></small>
  </h2>
  <span about="@" data-template="v-ui:RabbitHole"></span>
  <hr>
  <div id="mainProperties">
    <em about="v-s:parentOrganization" property="rdfs:label"></em>
    <span about="@" rel="v-s:backwardTarget" data-template="v-ui:LabelLinkTemplate"></span>

    <hr class="view -edit -search">

    <em about="rdfs:label" property="rdfs:label"></em>
    <div property="rdfs:label" class="view -edit -search"></div>
    <veda-control data-type="string" property="rdfs:label" class="-view edit search"></veda-control>

    <em about="v-s:shortLabel" property="rdfs:label"></em>
    <div property="v-s:shortLabel" class="view -edit -search"></div>
    <veda-control data-type="string" property="v-s:shortLabel" class="-view edit search"></veda-control>

    <hr class="view -edit -search">

    <div class="row">
      <div class="col-sm-4">
        <em about="v-s:taxRegistrationCause" property="rdfs:label"></em>
        <div property="v-s:taxRegistrationCause" class="view -edit -search"></div>
        <veda-control data-type="string" property="v-s:taxRegistrationCause" class="-view edit search"></veda-control>
      </div>
    </div>

    <hr class="view -edit -search">

    <em about="v-s:postalAddress" property="rdfs:label"></em>
    <div property="v-s:postalAddress" class="view -edit -search"></div>
    <veda-control data-type="text" rows="3" property="v-s:postalAddress" class="-view edit search"></veda-control>

    <hr class="view -edit -search">

    <em about="rdfs:comment" property="rdfs:label"></em>
    <div property="rdfs:comment" class="view -edit -search"></div>
    <veda-control data-type="text" rows="3" property="rdfs:comment" class="-view edit search"></veda-control>
  </div>

  <hr>
  <div about="@" data-template="v-ui:SystemPropertiesTemplate" data-embedded="true"></div>
  <br>
  <!-- BUTTONS -->
  <div class="actions">
    <span about="@" data-template="v-ui:StandardButtonsTemplate" data-embedded="true" data-buttons="edit save cancel delete"></span>
  </div>
</div>
  """ ;
.

v-s:DepartmentTemplate
  rdf:type v-ui:ClassTemplate ;
  v-ui:forClass v-s:Department ;
  rdfs:label "Шаблон для класса v-s:Department"@ru ;
  rdfs:label "Template for v-s:Department class"@en ;
  v-ui:template """
<script>
  if (individual.hasValue('v-s:parentOrganization')) {
    var parentOrganization = individual['v-s:parentOrganization'][0];
    var departmentQueryPrefix = "('rdf:type'=='v-s:Department' && 'v-s:parentOrganization'=='" + parentOrganization.id + "') || ('rdf:type'=='v-s:Organization' && '@'=='" + parentOrganization.id + "')";
    $('veda-control[rel="v-s:parentUnit"]', template).attr('data-query-prefix', departmentQueryPrefix);

    var appointmentQueryPrefix = "'rdf:type'=='v-s:Appointment' && 'v-s:parentOrganization'=='" + parentOrganization.id + "'";
    $('veda-control[rel="v-s:hasChief"]', template).attr('data-query-prefix', appointmentQueryPrefix);
    $('veda-control[rel="v-s:hasFieldChief"]', template).attr('data-query-prefix', appointmentQueryPrefix);
    $('veda-control[rel="v-s:hasFunctionalChief"]', template).attr('data-query-prefix', appointmentQueryPrefix);
  };
  template.on('validate', function() {
    var result = {};
    var subjectCode = individual.hasValue("v-s:subjectCode") && individual["v-s:subjectCode"][0].toString();
    if (!subjectCode) {
      result["v-s:subjectCode"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      }
    }
    template.trigger("validated", result);
  });
//# sourceURL=v-s:DepartmentTemplate_pre
</script>
<div class="container sheet">
  <h2>
    <span about="v-s:Department" property="rdfs:label"></span>
    <small about="@" property="rdfs:label"></small>
  </h2>
  <hr>
  <div id="mainProperties">
    <em about="v-s:parentOrganization" property="rdfs:label"></em>
    <div about="@" rel="v-s:parentOrganization" class="view edit -search">
      <a href="#/@">
        <span property="v-s:taxId"></span> - <span property="v-s:shortLabel"></span> - <span property="v-s:legalAddress"></span>
      </a>
    </div>
    <!-- <veda-control data-type="link" rel="v-s:parentOrganization" class="-view edit search fulltext"></veda-control> -->
    <em about="v-s:parentUnit" property="rdfs:label"></em>
    <div rel="v-s:parentUnit" class="view -edit -search" data-template="v-ui:LabelLinkTemplate"></div>
    <veda-control data-type="link" rel="v-s:parentUnit" class="-view edit search fulltext dropdown"></veda-control>
    <hr class="view -edit -search">
    <em about="rdfs:label" property="rdfs:label"></em>
    <div property="rdfs:label" class="view -edit -search"></div>
    <veda-control data-type="string" property="rdfs:label" class="-view edit search"></veda-control>
    <div class="row">
      <div class="col-md-6">
        <em about="v-s:shortLabel" property="rdfs:label"></em>
        <div property="v-s:shortLabel" class="view -edit -search"></div>
        <veda-control data-type="string" property="v-s:shortLabel" class="-view edit search"></veda-control>
      </div>
      <div class="col-md-6">
        <em about="v-s:DepartmentCode" property="rdfs:label"></em>
        <div property="v-s:subjectCode" class="view -edit search"></div>
        <veda-control data-type="string" property="v-s:subjectCode" class="-view edit search"></veda-control>
      </div>
    </div>
    <hr class="view -edit -search">
    <div class="row">
      <div class="col-sm-6">
        <em about="v-s:hasChief" property="rdfs:label"></em>
        <div rel="v-s:hasChief" class="view -edit search" data-template="v-ui:LabelTemplate"></div>
        <veda-control data-type="link" rel="v-s:hasChief" class="-view edit search fulltext dropdown"></veda-control>
        <em about="v-s:hasFieldChief" property="rdfs:label"></em>
        <div rel="v-s:hasFieldChief" class="view -edit search" data-template="v-ui:LabelTemplate"></div>
        <veda-control data-type="link" rel="v-s:hasFieldChief" class="-view edit search fulltext dropdown"></veda-control>
      </div>
      <div class="col-sm-6">
        <em about="v-s:hasFunctionalChief" property="rdfs:label"></em>
        <div rel="v-s:hasFunctionalChief" class="view -edit search" data-template="v-ui:LabelTemplate"></div>
        <veda-control data-type="link" rel="v-s:hasFunctionalChief" class="-view edit search fulltext dropdown"></veda-control>
      </div>
    </div>
    <hr class="view -edit -search">
    <em about="v-s:postalAddress" property="rdfs:label"></em>
    <div property="v-s:postalAddress" class="view -edit -search"></div>
    <veda-control data-type="text" rows="3" property="v-s:postalAddress" class="-view edit search"></veda-control>
  </div>

  <hr>
  <div about="@" data-template="v-ui:SystemPropertiesTemplate" data-embedded="true"></div>
  <br>
  <!-- BUTTONS -->
  <div class="actions">
    <span about="@" data-template="v-ui:StandardButtonsTemplate" data-embedded="true" data-buttons="edit save cancel delete journal"></span>
  </div>
</div>
  """ ;
.

##########НАЗНАЧЕНИЕ############
v-s:TS_Appointment 
  rdf:type v-ui:TemplateSpecification;
  v-s:loadPriority "15"^^xsd:integer;
  v-ui:defaultTemplate v-s:AppointmentTemplate;
  v-ui:forClass v-s:Appointment
.
v-s:NewAppointmentTemplate
  rdf:type v-ui:ClassTemplate ;
  v-ui:forClass v-s:Appointment ;
  rdfs:label "Шаблон для класса v-s:Appointment"@ru ;
  rdfs:label "Template for v-s:Appointment class"@en ;
  v-ui:template """
<script>
  template.on('validate', function() {
    var result = {};
    result["v-s:employee"] = {
      state: individual.hasValue('v-s:employee'),
      cause: ["v-ui:minCardinality"]
    };
    result["v-s:occupation"] = {
      state: individual.hasValue('v-s:occupation'),
      cause: ["v-ui:minCardinality"]
    };
    result["v-s:parentUnit"] = {
      state: individual.hasValue('v-s:parentUnit'),
      cause: ["v-ui:minCardinality"]
    };
    template.trigger("validated", result);
  });
  template.on("special-validate", function (e, validStates) {
    setTimeout(function(){
      // console.log($('div.validating-block:not(.hide) veda-control.has-error', template));
      if ($('div.validating-block:not(.hide) .has-error', template).length == 0) {
        $('.action#save', template).removeAttr('disabled');
      } else {
        $('.action#save', template).attr('disabled', 'disabled');
      }
    },500);
  });

  var parentOrganization = "unknown";
  if (individual.hasValue("v-s:parentOrganization")) {
    parentOrganization = individual['v-s:parentOrganization'][0].id;
  }
  var personQueryPrefixString;
  if (individual.hasValue("v-s:employee")) {
    $(".disabling", template).attr("disabled", "disabled");
    personQueryPrefixString = "'@'==='"+individual["v-s:employee"][0].id+"'";
  } else {
    personQueryPrefixString = "'rdf:type'=='v-s:Person' && 'v-s:parentOrganization'=='"+parentOrganization+"'";
  }
  $('#select-Person veda-control', template).attr('data-query-prefix', personQueryPrefixString);

  var occupationQueryPrefixString = "'rdf:type'=='v-s:Position' && 'v-s:parentOrganization'=='"+parentOrganization+"'";
  if (individual.hasValue("v-s:parentUnit")) {
    var parentUnit = individual['v-s:parentUnit'][0].id;
    occupationQueryPrefixString+=" && 'v-s:parentUnit'=='"+parentUnit+"'";
  }
  $('#select-Occupation veda-control', template).attr('data-query-prefix', occupationQueryPrefixString);

  // function parentUnitHandler() {
  //   if (individual.hasValue('v-s:parentUnit')) {
  //     var parentUnit = individual['v-s:parentUnit'][0].id;
  //     var occupQueryPrefixString = "'rdf:type'=='v-s:Position' && 'v-s:parentUnit'=='"+parentUnit+"'";
  //     var tmpl = $('<div><veda-control data-type="link" rel="v-s:occupation" class="fulltext dropdown"></veda-control></div>');
  //     var container = $("#select-Occupation", template);
  //     container = container.empty();
  //     tmpl.children().first().attr('data-query-prefix', occupQueryPrefixString);
  //     individual.present(container, tmpl.get(0), 'edit');
  //     // template.trigger("validate");
  //   }
  // }
  // parentUnitHandler();
  // individual.on("v-s:parentUnit", parentUnitHandler);
  // template.one("remove", function(){
  //   individual.off("v-s:parentUnit", parentUnitHandler);
  // })

//# sourceURL=v-s:NewAppointmentTemplate_pre
</script>
<div class="container sheet">
  <h2>
    <span about="v-s:Appointment" property="rdfs:label"></span>
    <small about="@" property="rdfs:label"></small>
  </h2>
  <hr>
  <div id="mainProperties">
    <em about="v-s:parentUnit" property="rdfs:label"></em>
    <div rel="v-s:parentUnit" class="view edit search" data-template="v-ui:LabelTemplate"></div>
    <veda-control id="select-ParentUnit" rel="v-s:parentUnit" data-query-prefix = "('rdf:type'=='v-s:Department' && 'v-s:parentOrganization'=='{individual['v-s:parentOrganization'][0].id}') || '@'==='{individual['v-s:parentOrganization'][0].id}'" data-type="link" class="-view edit search fulltext dropdown"></veda-control>
    <em about="v-s:date" property="rdfs:label"></em>
    <div class="form-inline">
      <div class="form-group">
        <span property="v-s:dateFrom" class="view -edit search"></span>
        <veda-control property="v-s:dateFrom" data-type="date" class="-view edit search"></veda-control>
      </div>
      <span class="view -edit -search">&mdash;&nbsp;&nbsp;&nbsp;</span>
      <div class="form-group">
        <span property="v-s:dateTo" class="view -edit search"></span>
        <veda-control property="v-s:dateTo" data-type="date" class="-view edit search"></veda-control>
      </div>
    </div>
    <hr class="view -edit -search">
    <div class="row">
      <div class="col-md-6">
        <em about="v-s:employee" property="rdfs:label"></em>
        <div class="btn-group">
          <button id="selectPersonBtn" class="btn btn-sm btn-primary navbar-btn disabling">Выбрать</button>
          <button id="createPersonBtn" class="btn btn-sm btn-default navbar-btn disabling">Создать</button>
        </div>
        <div id="select-Person" class="validating-block">
          <veda-control data-type="link" rel="v-s:employee" class="fulltext dropdown margin-sm"></veda-control>
        </div>
        <div id="fill-Person" class="validating-block"></div>
      </div>
      <div class="col-md-6">
        <em about="v-s:occupation" property="rdfs:label"></em>
        <div class="btn-group">
          <button id="selectOccupationBtn" class="btn btn-sm btn-primary navbar-btn">Выбрать</button>
          <button id="createOccupationBtn" class="btn btn-sm btn-default navbar-btn">Создать</button>
        </div>
        <div id="select-Occupation" class="validating-block">
          <veda-control data-type="link" rel="v-s:occupation" class="fulltext dropdown margin-sm"></veda-control>
        </div>
        <div id="fill-Occupation" class="validating-block"></div>
      </div>
    </div>
    <div id="radioBlock" class="hide">
      <em>Основное назначение</em>
      <div class="radio">
    </div>
  </div>
  <hr>
  <br>
  <!-- BUTTONS -->
  <div class="actions">
    <span about="@" data-template="v-ui:StandardButtonsTemplate" data-embedded="true" data-buttons="save cancel"></span>
  </div>
</div>
<script>
  if(mode === "edit" && individual.isNew()) {
    individual["v-s:dateFrom"]=[new Date()];
  }


  var NewPerson;
  var NewOccupation;

  var defaultAppointment;
  template.on('click', '#radioBlock input[type="radio"]', function () {
    defaultAppointment = $(this).attr('value');
  });

  template.on("special-validate", function (e, validStates) {
    setTimeout(function () {
      if ($('div.validating-block:not(.hide) .has-error', template).length == 0) {
        $('.action#save', template).removeAttr('disabled');
      } else {
        $('.action#save', template).attr('disabled', 'disabled');
      }
    }, 500);
  });

  function toogleButtons(currentBtn) {
    currentBtn.siblings().removeClass('btn-primary').addClass('btn-default')
    currentBtn.removeClass('btn-default').addClass('btn-primary');
    template.trigger('special-validate');
  }

  $('#createPersonBtn', template).click(function () {
    var self = $(this);
    if (self.hasClass('btn-primary')) return false;
    toogleButtons(self);
    $('#radioBlock').addClass('hide');
    defaultAppointment = undefined;
    $('#select-Person').addClass('hide');
    if (NewPerson) {
      $('#fill-Person').removeClass('hide');
    } else {
      NewPerson = new veda.IndividualModel();
      NewPerson['rdf:type'] = [new veda.IndividualModel('v-s:Person')];
      NewPerson['v-s:parentOrganization'] = individual['v-s:parentOrganization'];
      NewPerson.present($("<div>"), 'v-s:EmployeeEmbeddedTemplate', 'edit').then(function (tmpl) {
        tmpl.on("validate", function () {
          template.trigger('special-validate');
        });
        $('#fill-Person').append(tmpl);
      });
    }
    individual['v-s:employee'] = [NewPerson];
  });

  $('#selectPersonBtn').click(function () {
    var self = $(this);
    if (self.hasClass('btn-primary')) { return false; }
    toogleButtons(self);
    defaultAppointment = undefined;
    $('#select-Person').removeClass('hide');
    $('#fill-Person').addClass('hide');
    individual['v-s:employee'] = [];
    individual.on('v-s:employee', setDefaultAppointment);
  });

  $('#createOccupationBtn', template).click(function () {
    var self = $(this);
    if (self.hasClass('btn-primary')) { return false; }
    toogleButtons(self);
    individual.off('v-s:employee', setDefaultAppointment);
    $('#select-Occupation').addClass('hide');
    if (NewOccupation) {
      $('#fill-Occupation').removeClass('hide');
    } else {
      NewOccupation = new veda.IndividualModel();
      NewOccupation['rdf:type'] = [new veda.IndividualModel('v-s:Position')];
      NewOccupation['v-s:parentOrganization'] = individual['v-s:parentOrganization'];
      NewOccupation['v-s:parentUnit'] = individual['v-s:parentUnit'];
      NewOccupation.present($("<div>"), 'v-s:OccupationEmbeddedTemplate', 'edit').then(function (tmpl) {
        tmpl.on("validate", function () {
          template.trigger('special-validate');
        });
        $('#fill-Occupation').append(tmpl);
      });
    }
    individual['v-s:occupation'] = [NewOccupation];
  });

  $('#selectOccupationBtn').click(function () {
    var self = $(this);
    if (self.hasClass('btn-primary')) { return false; }
    toogleButtons(self);
    $('#select-Occupation').removeClass('hide');
    $('#fill-Occupation').addClass('hide');
    individual['v-s:occupation'] = [];
  });

  function setDefaultAppointment() {
    var radioCont = $('.radio', template).empty();
    if (individual.hasValue('v-s:employee')) {
      var employeeId = individual['v-s:employee'][0].id;
      var queryString = "'rdf:type'==='v-s:Appointment' && 'v-s:employee'=='" + employeeId + "' && 'v-s:parentOrganization'=='" + individual['v-s:parentOrganization'][0].id + "'";
      veda.Backend.query({ticket: veda.ticket, query: queryString}).then(function (queryResult) {
        var appointmentsUris = queryResult.result;
        if (appointmentsUris.length > 0) {
          veda.Backend.get_individuals(veda.ticket, appointmentsUris).then(function (appointmentsJSONs) {
            appointmentsJSONs.forEach(function (appointmentJSON) {
              var label = $('<label></label>');
              var radio = $('<input type="radio" name="defaultAppointment"/>').attr('value', appointmentJSON["@"]);
              label.append(radio);
              label.append( (new veda.IndividualModel(appointmentJSON))['rdfs:label'][0] );
              radioCont.append($('<div class="radio"></div>').append(label));
            });
            var newAppointLabel = individual['v-s:employee'][0]['rdfs:label'][0];
            radioCont.append('<div class="radio"><label><input type="radio" checked name="defaultAppointment"/>Новое для ' + newAppointLabel + '</label></div>');
            $('#radioBlock').removeClass('hide');
            return;
          });
        }
      });
    }
    $('#radioBlock').addClass('hide');
  }
  setDefaultAppointment();
  individual.on('v-s:employee', setDefaultAppointment);
  template.one('remove', function () {
    individual.off('v-s:employee', setDefaultAppointment);
  });

  $(".actions #save").off("click");
  $(".actions #save").on("click", function() {
    var occupationCode = individual['v-s:occupation'][0]['v-s:subjectCode'][0];
    var personTabNumber = individual['v-s:employee'][0]['v-s:tabNumber'][0];
    var tempEmployee = individual['v-s:employee'][0];
    var tempOccupation = individual['v-s:occupation'][0];
    Promise.resolve().then(function(){
      if (tempOccupation.isNew()) {
        tempOccupation['v-s:parentUnit'] = individual['v-s:parentUnit'];
        tempOccupation['v-s:parentOrganization'] = individual['v-s:parentOrganization'];
        return tempOccupation.save();
      }
      return undefined;
    }).then(function(savedOccupation){
      if (savedOccupation) {
        individual['v-s:occupation'] = [savedOccupation];
      }
      if (defaultAppointment){
        tempEmployee['v-s:defaultAppointment'] = [ new veda.IndividualModel(defaultAppointment) ];
      } else {
        tempEmployee['v-s:defaultAppointment'] = [individual];
      }
      tempEmployee['v-s:hasAppointment'] = tempEmployee['v-s:hasAppointment'].concat(individual);
      if (tempEmployee.isNew()) {
        tempEmployee['v-s:parentOrganization'] = individual['v-s:parentOrganization'];
      }
      return tempEmployee.save();
    }).then(function(savedEmployee) {
      if (savedEmployee) {
        individual['v-s:employee'] = [ tempEmployee ]; 
      }
      individual['v-s:official'] = [true]; 
      individual.save();
    });
    return false;
  });

  //# sourceURL=v-s:NewAppointmentTemplate_post
</script>
  """ ;
.

v-s:EmployeeEmbeddedTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Шаблон для класса v-s:Person при создании v-s:Appoinment"@ru ;
  rdfs:label "Template for v-s:Person to create v-s:Appointment class"@en ;
  v-ui:template """
<script>
  template.on("validate", function () {
    var result = {};
    if ( individual.hasValue('v-s:lastName') && individual.hasValue('v-s:firstName') ) {
      var queryString = "'rdf:type'==='v-s:Person' && 'v-s:parentOrganization'=='" + individual['v-s:parentOrganization'][0].id + "' && 'v-s:lastName'=='" + individual['v-s:lastName'][0] + "' && 'v-s:firstName'=='" + individual['v-s:firstName'][0] + "'";
      veda.Backend.query(veda.ticket, queryString).then(function (queryResult) {
        var tmp = queryResult.result;
        if (tmp.length == 0) {
          $('#warningPerson').addClass('hide');
        } else {
          $('#warningPerson').removeClass('hide');
        }
      });
    }
    if ( individual.hasValue('v-s:lastName') && individual.hasValue('v-s:firstName') && individual.hasValue('v-s:middleName') && individual.hasValue('v-s:birthday')) {
      var queryString = "'rdf:type'==='v-s:Person' && 'v-s:parentOrganization'=='" + individual['v-s:parentOrganization'][0].id + "' && 'v-s:lastName'=='" + individual['v-s:lastName'][0] + "' && 'v-s:firstName'=='" + individual['v-s:firstName'][0] + "' && 'v-s:middleName'=='" + individual['v-s:middleName'][0] + "' && 'v-s:birthday'=='" + individual['v-s:birthday'][0] + "'";
      veda.Backend.query(veda.ticket, queryString).then(function (queryResult) {
        var tmp = queryResult.result;
        if (tmp.length > 0) {
          result["v-s:lastName"] = {
            state: false,
            cause: ["v-s:EmployeeValidationBundle"]
          };
          result["v-s:firstName"] = {
            state: false,
            cause: ["v-s:EmployeeValidationBundle"]
          };
          result["v-s:middleName"] = {
            state: false,
            cause: ["v-s:EmployeeValidationBundle"]
          };
          result["v-s:birthday"] = {
            state: false,
            cause: ["v-s:EmployeeValidationBundle"]
          };
        }
      });
    }    
    if (!individual.hasValue('v-s:lastName')) {
      result["v-s:lastName"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    }
    if (!individual.hasValue('v-s:firstName')) {
      result["v-s:firstName"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    }
    if (!individual.hasValue('v-s:middleName')) {
      result["v-s:middleName"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    }
    if (!individual.hasValue('v-s:birthday')) {
      result["v-s:birthday"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    }
    if (!individual.hasValue('v-s:tabNumber')) {
      result["v-s:tabNumber"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    }
    template.trigger("validated", result);
  });
</script>
<div>
  <div id="warningPerson" class="alert alert-warning hide">
    <span>Внимание. Пользователь с такими ФИО уже существует. Возможно Вам следует выбрать его.</span>
  </div>
  <div class="row">
    <div class="col-md-6">
      <em about="v-s:lastName" property="rdfs:label"></em>
    </div>
    <div class="col-md-6">
      <veda-control data-type="string" property="v-s:lastName"></veda-control>
    </div>
  </div>
  <br>
  <div class="row">
    <div class="col-md-6">
      <em about="v-s:firstName" property="rdfs:label"></em>
    </div>
    <div class="col-md-6">
      <veda-control data-type="string" property="v-s:firstName"></veda-control>
    </div>
  </div>
  <br>
  <div class="row">
    <div class="col-md-6">
      <em about="v-s:middleName" property="rdfs:label"></em>
    </div>
    <div class="col-md-6">
      <veda-control data-type="string" property="v-s:middleName"></veda-control>
    </div>
  </div>
  <br>
  <div class="row">
    <div class="col-md-6">
      <em about="v-s:birthday" property="rdfs:label"></em>
    </div>
    <div class="col-md-6">
      <veda-control data-type="date" property="v-s:birthday"></veda-control>
    </div>
  </div>
  <br>
  <div class="row">
    <div class="col-md-6">
      <em about="v-s:tabNumber" property="rdfs:label"></em>
    </div>
    <div class="col-md-6">
      <veda-control data-type="string" property="v-s:tabNumber"></veda-control>
    </div>
  </div>
</div>
  """ ;
.

v-s:OccupationEmbeddedTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Шаблон для класса v-s:Position при создании v-s:Appoinment"@ru ;
  rdfs:label "Template for v-s:Position to create v-s:Appointment class"@en ;
  v-ui:template """
<script>
  template.on("validate", function () {
    var result = {};
    if (!individual.hasValue('v-s:subjectCode')) {
      result["v-s:subjectCode"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    }
    if (!individual.hasValue('rdfs:label')) {
      result["rdfs:label"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    } else {
      var queryString = "'rdf:type'==='v-s:Position' && 'v-s:parentOrganization'=='" + individual['v-s:parentOrganization'][0].id + "' && 'rdfs:label'=='" + individual['rdfs:label'][0] + "' && 'v-s:parentUnit'=='" + individual['v-s:parentUnit'][0].id + "'";
      veda.Backend.query(veda.ticket, queryString).then(function (queryResult) {
        var tmp = queryResult.result;
        if (tmp.length == 0) {
          $('#warningOccupation').addClass('hide');
        } else {
          $('#warningOccupation').removeClass('hide');
        }
      });
    }
    template.trigger("validated", result);
  });
</script>
<div>
  <div id="warningOccupation" class="alert alert-warning hide">
    <span>Внимание. Должность с похожим названием уже существует в выбранном подразделении. Возможно Вам следует использовать ее.</span>
  </div>
  <div class="row">
    <div class="col-md-6">
      <em about="v-s:title" property="rdfs:label"></em>
    </div>
    <div class="col-md-6">
      <div property="rdfs:label" class="view -edit search"></div>
      <veda-control data-type="string" property="rdfs:label" class="-view edit search"></veda-control>
    </div>
  </div>
  <br>
  <div class="row">
    <div class="col-md-6">
      <em about="v-s:PositionCode" property="rdfs:label"></em>
    </div>
    <div class="col-md-6">
      <div property="v-s:subjectCode" class="view -edit search"></div>
      <veda-control data-type="string" property="v-s:subjectCode" class="-view edit search"></veda-control>
    </div>
  </div>
</div>
  """ ;
.














###################################################НОВОЕ########################################################
#-------шаблон создания НАЗНАЧЕНИЯ для админа
v-s:AppointmentTemplate
  rdf:type v-ui:ClassTemplate ;
  v-ui:forClass v-s:Appointment ;
  rdfs:label "Шаблон для класса v-s:Appointment"@ru ;
  rdfs:label "Template for v-s:Appointment class"@en ;
  v-ui:template """
<script>
  template.on('validate', function() {
    var result = {};
    result["v-s:employee"] = {
      state: individual.hasValue('v-s:employee'),
      cause: ["v-ui:minCardinality"]
    };
    result["v-s:occupation"] = {
      state: individual.hasValue('v-s:occupation'),
      cause: ["v-ui:minCardinality"]
    };
    if (!individual.hasValue('v-s:parentOrganization')) {
      result["v-s:parentOrganization"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    }
    if (!individual.hasValue('v-s:parentUnit')) {
      result["v-s:parentUnit"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    }
    if (!individual.hasValue('v-s:origin')) {
      result["v-s:origin"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    }
    template.trigger("validated", result);
  });
  template.on("special-validate", function (e, validStates) {
    setTimeout(function(){
      // console.log($('div.validating-block:not(.hide) veda-control.has-error', template));
      if ($('div.validating-block:not(.hide) .has-error', template).length == 0) {
        $('.action#save', template).removeAttr('disabled');
      } else {
        $('.action#save', template).attr('disabled', 'disabled');
      }
    },500);
  });

//# sourceURL=v-s:AppointmentTemplate_pre
</script>
<div class="container sheet">
  <h2>
    <span about="v-s:Appointment" property="rdfs:label"></span>
    <small about="@" property="rdfs:label"></small>
  </h2>
  <hr>
  <div id="mainProperties">
    <div class="row row-attribute">
      <div class="col-sm-3 col-xs-5">
        <label about="v-s:Organization" property="rdfs:label"></label>
      </div>
      <div class="col-sm-9 col-xs-7">
        <div about="@" rel="v-s:parentOrganization" class="view -edit -search" data-template="v-ui:LabelLinkTemplate"></div>
        <veda-control rel="v-s:parentOrganization" data-query-prefix = "'rdf:type'=='v-s:Organization'" data-type="link" class="-view edit search fulltext dropdown"></veda-control>
      </div>
    </div>
    <div class="row row-attribute">
      <div class="col-sm-3 col-xs-5">
        <label about="v-s:Department" property="rdfs:label"></label>
      </div>
      <div class="col-sm-9 col-xs-7">
        <div about="@" rel="v-s:parentUnit" class="view -edit -search" data-template="v-ui:LabelLinkTemplate"></div>
        <veda-control rel="v-s:parentUnit" data-query-prefix = "('rdf:type'=='v-s:Department' && 'v-s:parentOrganization'=='{individual['v-s:parentOrganization'][0].id}') || '@'=='{individual['v-s:parentOrganization'][0].id}'" data-type="link" class="-view edit search fulltext dropdown"></veda-control>
      </div>
    </div>
    <section id="Employee" class="hide">
      <h4 class="section-header -view edit search">
        <span about="v-s:employee" property="rdfs:label"></span>
        <div class="btn-group -view edit -search">
          <button id="selectPersonBtn" class="btn btn-sm btn-primary navbar-btn">Выбрать</button>
          <button id="createPersonBtn" class="btn btn-sm btn-default navbar-btn">Создать</button>
        </div>
      </h4>
      <div class="section-content">
        <div class="row row-attribute">
          <div class="col-sm-3 col-xs-5">
            <label about="v-s:employee" property="rdfs:label" class="view -edit -search"></label>
          </div>
          <div class="col-sm-9 col-xs-7">
             <div id="select-Person" class="validating-block">
              <div about="@" rel="v-s:employee" class="view -edit -search" data-template="v-ui:LabelLinkTemplate"></div>
              <veda-control data-type="link" rel="v-s:employee" class="fulltext dropdown margin-sm -view edit -search" data-query-prefix="'rdf:type'=='v-s:Person' && 'v-s:parentOrganization'=='{individual['v-s:parentOrganization'][0].id}'"></veda-control>
            </div>
          </div>
        </div>
        <div id="fill-Person" class="validating-block"></div>
      </div>
    </section>
    <section id="Position" class="hide">
      <h4 class="section-header -view edit search">
        <span about="v-s:Position" property="rdfs:label"></span>
        <div class="btn-group -view edit -search">
          <button id="selectOccupationBtn" class="btn btn-sm btn-primary navbar-btn">Выбрать</button>
          <button id="createOccupationBtn" class="btn btn-sm btn-default navbar-btn">Создать</button>
        </div>
      </h4>
      <div class="section-content">
        <div class="row row-attribute">
          <div class="col-sm-3 col-xs-5">
            <label about="v-s:Position" property="rdfs:label" class="view -edit -search"></label>
          </div>
          <div class="col-sm-9 col-xs-7">
            <div id="select-Occupation" class="validating-block">
              <div about="@" rel="v-s:occupation" class="view -edit -search" data-template="v-ui:LabelLinkTemplate"></div>
              <veda-control data-type="link" rel="v-s:occupation" class="fulltext dropdown margin-sm -view edit -search" data-query-prefix="'rdf:type'=='v-s:Position' && 'v-s:parentUnit'=='{individual['v-s:parentUnit'][0].id}'"></veda-control>
            </div>
          </div>
        </div>
        <div id="fill-Occupation" class="validating-block"></div>
      </div>
    </section>
    <hr class="-view edit -search">
    <div id="radioBlock">
      <div class="row row-attribute  -view edit -search">
        <div class="col-sm-3 col-xs-5">
          <label about="v-s:DefaultAppointmentBundle" property="rdfs:label"></label>
        </div>
        <div class="col-sm-9 col-xs-7">
           <div class="radio">
          </div>
        </div>
      </div>
    </div>
    <section id="ForAdmin" class="notEditForUsers">
      <h4 class="section-header -view edit search">
        <span about="cfg:Administrator" property="rdfs:label"></span>
      </h4>
      <div class="row row-attribute">
        <div class="col-sm-3 col-xs-5">
          <label about="v-s:date" property="rdfs:label"></label>
        </div>
        <div class="col-sm-9 col-xs-7">
          <div class="form-inline">
            <div class="form-group">
              <span property="v-s:dateFrom" class="view -edit search"></span>
              <veda-control property="v-s:dateFrom" data-type="date" class="-view edit search"></veda-control>
            </div>
            <span class="view -edit -search">&mdash;&nbsp;&nbsp;&nbsp;</span>
            <div class="form-group">
              <span property="v-s:dateTo" class="view -edit search"></span>
              <veda-control property="v-s:dateTo" data-type="date" class="-view edit search"></veda-control>
            </div>
          </div>
        </div>
      </div>
      <div class="section-content">
        <div class="row row-attribute">
          <div class="col-sm-3 col-xs-5">
            <label about="v-s:origin" property="rdfs:label"></label>
          </div>
          <div class="col-sm-9 col-xs-7">
            <div property="v-s:origin" class="view -edit search"></div>
            <veda-control property="v-s:origin" data-type="string" class="-view edit search"></veda-control>
          </div>
        </div>
        <div class="row row-attribute">
          <div class="col-sm-3 col-xs-5">
          </div>
          <div class="col-sm-9 col-xs-7">
            <div class="checkbox no-margin">
              <label>
                <veda-control property="v-s:official" data-type="boolean"></veda-control>
                <span about="v-s:official" property="rdfs:label"></span>
              </label>
            </div>
          </div>
        </div>
        <div class="row row-attribute  -view edit -search">
          <div class="col-sm-3 col-xs-5">
          </div>
          <div class="col-sm-8 col-xs-6">
            <veda-control rel="@" data-type="uri" class="-view edit search"></veda-control>
          </div>
          <div class="col-sm-1 col-xs-1">
            <button id="recalculate" class="btn btn-xs btn-success">
              <span class="glyphicon glyphicon-refresh"></span>
            </button>
          </div>
        </div>
        <hr>
    </section> 
    
    <!--Системные свойства -->
    <div about="@" data-template="v-ui:SystemPropertiesTemplate" data-embedded="true"></div>
    <br>
    <!-- BUTTONS -->
    <div class="actions">
    <span about="@" data-template="v-ui:StandardButtonsTemplate" data-embedded="true" data-buttons="edit save cancel delete"></span>
    </div>
  </div>
</div>
<script>
  if (template.data("mode") === "view" && veda.appointment.id != 'cfg:AdministratorAppointment'){
    $('#edit.action', template).remove();
  }
  if(veda.appointment.id != 'cfg:AdministratorAppointment'){
    $('.notEditForUsers').addClass('hide'); 
  }
  //проставляет признаки по умолчанию для Назначения
  if(mode === "edit" && individual.isNew()) {
    individual["v-s:official"]=[true];
    individual["v-s:dateFrom"]=[new Date()];
  }

  //Отображает Персону и Должность после выбора ОрганизTeации
  function hidePosAndEmp(){
    if (individual.hasValue("v-s:parentOrganization"))
    {
      $("#Employee").removeClass('hide');
      $("#Position").removeClass('hide');
    }
    else {
      $("#Employee").addClass('hide');
      $("#Position").addClass('hide');
      individual["v-s:parentUnit"] = [];}
  }
  individual.on("v-s:parentOrganization", hidePosAndEmp);
  template.one("remove", function () {
    individual.off("v-s:parentOrganization", hidePosAndEmp);
  });
  hidePosAndEmp();
   
  var NewPerson;
  var NewOccupation;
  var defaultAppointment;
  template.on('click', '#radioBlock input[type="radio"]', function () {
    defaultAppointment = $(this).attr('value');
  });
  template.on("special-validate", function (e, validStates) {
    setTimeout(function () {
      if ($('div.validating-block:not(.hide) .has-error', template).length == 0) {
        $('.action#save', template).removeAttr('disabled');
      } else {
        $('.action#save', template).attr('disabled', 'disabled');
      }
    }, 500);
  });

  function toogleButtons(currentBtn) {
    currentBtn.siblings().removeClass('btn-primary').addClass('btn-default')
    currentBtn.removeClass('btn-default').addClass('btn-primary');
    template.trigger('special-validate');
  }

  $('#createPersonBtn', template).click(function () {
    var self = $(this);
    if (self.hasClass('btn-primary')) return false;
    toogleButtons(self);
    $('#radioBlock').addClass('hide');
    defaultAppointment = undefined;
    $('#select-Person').addClass('hide');
    if (NewPerson) {
      $('#fill-Person').removeClass('hide');
    } else {
      NewPerson = new veda.IndividualModel();
      NewPerson['rdf:type'] = [new veda.IndividualModel('v-s:Person')];
      NewPerson['v-s:parentOrganization'] = individual['v-s:parentOrganization'];
      NewPerson.present($("<div>"), 'v-s:PersonEmbeddedTemplate', 'edit').then(function (tmpl) {
        tmpl.on("validate", function () {
          template.trigger('special-validate');
        });
        $('#fill-Person').append(tmpl);
      });
    }
    individual['v-s:employee'] = [NewPerson];
  });

  $('#selectPersonBtn').click(function () {
    var self = $(this);
    if (self.hasClass('btn-primary')) { return false; }
    toogleButtons(self);
    defaultAppointment = undefined;
    $('#select-Person').removeClass('hide');
    $('#fill-Person').addClass('hide');
    individual['v-s:employee'] = [];
    //individual.on('v-s:employee', setDefaultAppointment);
  });

 $('#createOccupationBtn', template).click(function () {
    var self = $(this);
    if (self.hasClass('btn-primary')) { return true; }
    toogleButtons(self);
    //individual.off('v-s:employee', setDefaultAppointment);
    $('#select-Occupation').addClass('hide');
    if (NewOccupation) {
      $('#fill-Occupation').removeClass('hide');
    } else {
      NewOccupation = new veda.IndividualModel();
      NewOccupation['rdf:type'] = [new veda.IndividualModel('v-s:Position')];
      NewOccupation['v-s:parentOrganization'] = individual['v-s:parentOrganization'];
      NewOccupation['v-s:parentUnit'] = individual['v-s:parentUnit'];
      NewOccupation['v-s:origin'] = individual['v-s:origin'];
      NewOccupation.present($("<div>"), 'v-s:PositionEmbeddedTemplate', 'edit').then(function (tmpl) {
        tmpl.on("validate", function () {
          template.trigger('special-validate');
        });
        $('#fill-Occupation').append(tmpl);
      });
    }
    individual['v-s:occupation'] = [NewOccupation];
  });

  $('#selectOccupationBtn').click(function () {
    var self = $(this);
    if (self.hasClass('btn-primary')) { return true; }
    toogleButtons(self);
    $('#select-Occupation').removeClass('hide');
    $('#fill-Occupation').addClass('hide');
    individual['v-s:occupation'] = [];
  });
  function setDefaultAppointment() {
    var radioCont = $('.radio', template).empty();
    if (individual.hasValue('v-s:employee')) {
      var employeeId = individual['v-s:employee'][0].id;
      var queryString = "'rdf:type'==='v-s:Appointment' && 'v-s:employee'=='" + employeeId + "' && 'v-s:parentOrganization'=='" + individual['v-s:parentOrganization'][0].id + "' && '@'!='"+individual.id+"'";
      veda.Backend.query({ticket: veda.ticket, query: queryString}).then(function (queryResult) {
        var appointmentsUris = queryResult.result;
        if (appointmentsUris.length > 0) {
          veda.Backend.get_individuals(veda.ticket, appointmentsUris).then(function (appointmentsJSONs) {
            appointmentsJSONs.forEach(function (appointmentJSON) {
              var label = $('<label></label>');
              var radio = $('<input type="radio" name="defaultAppointment"/>').attr('value', appointmentJSON["@"]);
              label.append(radio);
              label.append( (new veda.IndividualModel(appointmentJSON))['rdfs:label'][0] );
              radioCont.append($('<div class="radio"></div>').append(label));
            });
            var newAppointLabel = individual['v-s:employee'][0]['rdfs:label'][0];
            radioCont.append('<div class="radio"><label><input type="radio" checked name="defaultAppointment"/>Текущее для ' + newAppointLabel + '</label></div>');
            $('#radioBlock').removeClass('hide');
            return;
          });
        }
      });
    }
    $('#radioBlock').addClass('hide');
  }
  setDefaultAppointment();
  individual.on('v-s:employee', setDefaultAppointment);
  template.one('remove', function () {
    individual.off('v-s:employee', setDefaultAppointment);
  });

  function autoID() {
    var org1 = individual["v-s:parentOrganization"][0].id;
    var org = org1.slice(6);
  
    var id_emp = individual["v-s:employee"][0]["v-s:tabNumber"][0];
    var id_occup = individual["v-s:occupation"][0]["v-s:subjectCode"][0];
    individual.id = "d:"+ org +"_emp_"+ id_emp +"_pos_"+ id_occup;
    individual.trigger("idChanged");
  }

  $("#recalculate", template).click(autoID);


  $(".actions #save").off("click");
  $(".actions #save").on("click", function() {
    var tempEmployee = individual['v-s:employee'][0];
    var tempOccupation = individual['v-s:occupation'][0];
    var tempCommunicationMean = individual['v-s:employee'][0]['v-s:hasCommunicationMean'];
    var tempAccount = individual['v-s:employee'][0]['v-s:hasAccount'][0];
  

    //новый id персоны
    var promises_emp = individual.getPropertyChain("v-s:employee", "v-s:description").then(function(emp_id) {
      return (new veda.IndividualModel(""+emp_id[0]));
    }).then(function(emp) { 
        if(tempCommunicationMean){ tempCommunicationMean.map(function(CommunicationMean) {//Средства связи
          CommunicationMean["v-s:parent"] = [emp];
          return CommunicationMean.save(); 
        });}
        if(tempAccount){ //Аккаунт
          tempAccount["v-s:owner"] = [emp];
          tempAccount["v-s:parent"] = [emp];
          tempAccount.id = emp.id + "_account";
          tempAccount["v-s:origin"] = individual['v-s:origin'];
          return tempAccount.save();}
        else return undefined;
      return Promise.all();
    }).then(function() { //Должность
      if (tempOccupation.isNew()) {
        tempOccupation.id = individual['v-s:occupation'][0]["v-s:description"][0];
        tempOccupation['v-s:parentUnit'] = individual['v-s:parentUnit'];
        tempOccupation['v-s:parentOrganization'] = individual['v-s:parentOrganization'];
        tempOccupation["v-s:origin"] = individual['v-s:origin'];
        return tempOccupation.save();
      }
      else return undefined;
    }).then(function(savedOccupation){ //Персона
      if (tempEmployee.isNew()) {
          tempEmployee.id = individual['v-s:employee'][0]["v-s:description"][0];
          tempEmployee['v-s:parentOrganization'] = individual['v-s:parentOrganization'];
          tempEmployee['v-s:owner'] = [tempEmployee];
          tempEmployee['v-s:origin'] = individual['v-s:origin'];
          tempEmployee['v-s:hasAccount'] = [ tempAccount];
          if(tempAccount) tempEmployee['v-s:hasAccount'] = [ tempAccount];
        }

      if (savedOccupation) {
        individual['v-s:occupation'] = [savedOccupation];
      }
      if (defaultAppointment){
        tempEmployee['v-s:defaultAppointment'] = [ new veda.IndividualModel(defaultAppointment) ];
      } else {
        tempEmployee['v-s:defaultAppointment'] = [individual];
      }
      tempEmployee['v-s:hasAppointment'] = tempEmployee['v-s:hasAppointment'].concat(individual);
      return tempEmployee.save();
    }).then(function(savedEmployee) { //Назначение
      if (savedEmployee) {
        individual['v-s:employee'] = [ tempEmployee ];  
      }
      individual.save();
    });
    return true;
  });


  //# sourceURL=v-s:AppointmentTemplate_post
</script>
  """ ;
.


#-------шаблон создания ПЕРСОНЫ для админа
v-s:PersonTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Шаблон отображения персональной информации"@ru ;
  rdfs:label "Personal information template"@en ;
  v-ui:forClass v-s:Person ;
  v-ui:template """
<script>
  template.on("validate", function () {
    var result = {};
    if (!individual.hasValue('v-s:lastName')) {
      result["v-s:lastName"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    }
    if (!individual.hasValue('v-s:firstName')) {
      result["v-s:firstName"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    } 
    if (!individual.hasValue('v-s:tabNumber')) {
      result["v-s:tabNumber"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    }
    if (!individual.hasValue('v-s:parentOrganization')) {
      result["v-s:parentOrganization"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    }
    if ( individual.hasValue('v-s:lastName') && individual.hasValue('v-s:firstName') && individual.hasValue('v-s:parentOrganization') && individual.isNew()) {
      var queryString = "'rdf:type'==='v-s:Person' && 'v-s:parentOrganization'=='" + individual['v-s:parentOrganization'][0].id + "' && 'v-s:lastName'=='" + individual['v-s:lastName'][0] + "' && 'v-s:firstName'=='" + individual['v-s:firstName'][0] + "'";
      veda.Backend.query(veda.ticket, queryString).then(function (queryResult) {
        var tmp = queryResult.result;
        if (tmp.length == 0) {
          $('#warningPersonFIO').addClass('hide'); 
        } else {
          $('#warningPersonFIO').removeClass('hide');
        }
      });
    }
    if ( individual.hasValue('v-s:tabNumber') && individual.isNew()) {
      var queryString = "'rdf:type'==='v-s:Person' && 'v-s:parentOrganization'=='" + individual['v-s:parentOrganization'][0].id + "' && 'v-s:tabNumber'=='" + individual['v-s:tabNumber'][0] + "'";
      veda.Backend.query(veda.ticket, queryString).then(function (queryResult) {
        var tmp = queryResult.result;
        if (tmp.length == 0) {
          $('#warningPersonTabNum').addClass('hide'); 
        } else {
          $('#warningPersonTabNum').removeClass('hide');
        }
      });
    }
    template.trigger("validated", result);
  });


  if (veda.appointment.id != 'cfg:AdministratorAppointment') {
    $("#add-Account", template).attr('disabled', 'disabled');

  }
  var canCreateSubsidiary = (new veda.IndividualModel("v-s:Subsidiary")).canCreate();
  Promise.all([canCreateSubsidiary, canUpdatePromise]).then(function(results) {
    if ( !results[0] || !results[1]) {
      $("#add-subsidiary", template).remove();
    }
  })
  var canUpdatePromise = individual.canUpdate();
  var canCreatePerson = (new veda.IndividualModel("v-s:Person")).canCreate();
  var canCreatePosition = (new veda.IndividualModel("v-s:Position")).canCreate();
  var canCreateAppointment = (new veda.IndividualModel("v-s:Appointment")).canCreate();
  Promise.all([canUpdatePromise,canCreatePerson,canCreatePosition,canCreateAppointment]).then(function(results) {
    if ( !results[0] || !results[1] || !results[2] || !results[3]) {
      $("#deleteAppointment", template).remove();
    }
  })

  var canDeletePerson = individual.canDelete();
  Promise.all([canDeletePerson]).then(function(results) {
    if ( !results[0]) {
      $("#dismissEmployee", template).remove();
    }
  })

  var queryString = "'rdf:type'==='v-s:Appointment' && 'v-s:employee'==='"+individual.id+"'";
  $("veda-control[rel='v-s:defaultAppointment']", template).attr("data-query-prefix", queryString);
  //$('veda-control[rel="v-s:parentUnit"]', template).attr('data-query-prefix', departmentQueryPrefix);
</script>
<div class="container sheet">
  <div class="col-sm-12 col-xs-12">
   <div id="warningPersonFIO" class="alert alert-warning hide">
      <span>Внимание. Пользователь с такими ФИО уже существует в данной организации. Возможно Вам следует выбрать его.</span>
    </div>
    <div id="warningPersonTabNum" class="alert alert-danger hide">
      <span>Внимание. Пользователь с таким табельным номером уже существует в данной организации.</span>
    </div>
     <div class="col-md-9">
        <h3 class="margin-sm view edit search">
          <span about="v-s:Person" property="rdfs:label"></span>
        </h3>
        <hr>
        <div class="row row-attribute">
          <div class="col-sm-3 col-xs-5"></div>
          <div class="col-sm-9 col-xs-7">
            <h4 class="view edit -search"><span about="@" property="v-s:lastName"></span> <span about="@" property="v-s:firstName"></span> <span about="@" property="v-s:middleName"></span></h4>
          </div>
        </div>
        <div class="row row-attribute -view edit -search new">
          <div class="col-sm-3 col-xs-5">
            <label about="v-s:parentOrganization" property="rdfs:label"></label>
          </div>
          <div class="col-sm-9 col-xs-7 -view edit -search new">
            <veda-control rel="v-s:parentOrganization" data-query-prefix = "'rdf:type'=='v-s:Organization'" data-type="link" class="-view edit search fulltext dropdown"></veda-control>
          </div>
        </div>
        <div id="notNewBundle" class="alert alert-info hide -view edit -search">
          <span>ФИО пользователя редактировать нельзя. Если Вы допустили опечатку, то обратитесь в службу поддержки.
          </span>
        </div>
        <div class="row row-attribute -view edit search new">
          <div class="col-sm-3 col-xs-5">
            <label about="v-s:lastName" property="rdfs:label"></label>
          </div>
          <div class="col-sm-9 col-xs-7 new">
            <veda-control property="v-s:lastName" data-type="multilingualString" class="-view edit search"></veda-control>
          </div>
        </div>
        <div class="row row-attribute  -view edit search new">
          <div class="col-sm-3 col-xs-5">
            <label about="v-s:firstName" property="rdfs:label"></label>
          </div>
          <div class="col-sm-9 col-xs-7 new">
            <veda-control property="v-s:firstName" data-type="multilingualString" class="-view edit search"></veda-control>
          </div>
        </div>
        <div class="row row-attribute -view edit search new">
          <div class="col-sm-3 col-xs-5">
            <label about="v-s:middleName" property="rdfs:label"></label>
          </div>
          <div class="col-sm-9 col-xs-7">
            <veda-control property="v-s:middleName" data-type="multilingualString" class="-view edit search"></veda-control>
          </div>
        </div>
        <div class="row row-attribute">
          <div class="col-sm-3 col-xs-5">
            <label about="v-s:birthday" property="rdfs:label"></label>
          </div>
          <div class="col-sm-3 col-xs-3">
            <span class="view -edit -search" about="@" property="v-s:birthday"></span>
            <veda-control property="v-s:birthday" data-type="date" class="-view edit search"></veda-control>
          </div>
        </div>
        <div class="row row-attribute">
          <div class="col-sm-3 col-xs-5">
            <label about="v-s:tabNumber" property="rdfs:label"></label>
          </div>
          <div class="col-sm-3 col-xs-3">
            <span class="view -edit -search" about="@" property="v-s:tabNumber"></span>
            <veda-control property="v-s:tabNumber" data-type="string" class="-view edit search"></veda-control>
          </div>
        </div>
        <div class="row row-attribute">
          <div class="col-sm-3 col-xs-5">
            <label about="v-s:parentOrganization" property="rdfs:label" class="view -edit search"></label>
          </div>
          <div class="col-sm-9 col-xs-7">
            <div about="@" rel="v-s:parentOrganization" class="view -edit search" data-template="v-ui:LabelLinkTemplate"></div>
            <veda-control rel="v-s:parentOrganization" data-type="link" class="-view -edit search fulltext"></veda-control>
          </div>
        </div>
        <div class="row row-attribute notEditForUsers">
          <div class="col-sm-3 col-xs-5">
            <label about="v-s:origin" property="rdfs:label" class="-view edit search"></label>
          </div>
          <div class="col-sm-9 col-xs-7">
            <veda-control property="v-s:origin" data-type="string" class="-view -edit search"></veda-control>
          </div>
        </div>
        <div class="row row-attribute">
          <div class="col-sm-3 col-xs-5">
            <label about="v-s:defaultAppointment" property="rdfs:label" class="view edit -search"></label>
          </div>
          <div class="col-sm-9 col-xs-7">
            <div about="@" rel="v-s:defaultAppointment" class="view -edit -search" data-template="v-ui:LabelTemplate">
            </div>
            <veda-control rel="v-s:defaultAppointment" data-type="link" class="-view edit -search fulltext dropdown"></veda-control>
          </div>
        </div>
        <div class="row row-attribute">
          <div class="col-sm-3 col-xs-5">
            <label about="v-s:hasAppointment" property="rdfs:label" class="view edit search"></label>
          </div>
          <div class="col-sm-9 col-xs-7">
            <table class="table table-bordered view edit -search">
              <thead>
                <tr class="view edit -search">
                  <th width="1%" class="view -edit -search"><span class="glyphicon glyphicon-search"></th>
                  <th about="rdfs:label" property="rdfs:label"></th>
                  <th about="v-s:dateFrom" property="rdfs:label"></th>
                  <th about="v-s:dateTo" property="rdfs:label"></th>
                  <th class="view -edit -search"></th>
                  <th class="view -edit -search"></th>
                </tr>
              </thead>
              <tbody about="@" rel="v-s:hasAppointment" data-embedded="true" data-template="v-s:AppointmentEmbeddedTableTemplate"></tbody>

            </table>
            <div class="view -edit -search">
              <button class="btn btn-xs btn-success" id="add-Appointment">
                <span class="glyphicon glyphicon-zoom-in"></span>
                <span  about="v-s:AppointmentBundle" property="rdfs:label"> </span>
              </button>
              <button class="btn btn-xs btn-danger" id="dismissEmployee">
                <span  about="v-s:DismissBundle" property="rdfs:label"> </span>
              </button>
            </div>
            <veda-control data-type="link" rel="v-s:hasAppointment" class="-view -edit search fulltext"></veda-control>
          </div>
        </div>
        <br>
        <div class="row row-attribute">
          <div class="col-sm-3 col-xs-5">
            <label about="v-s:hasCommunicationMean" property="rdfs:label" class="view edit -search"></label>
          </div>
          <div class="col-sm-9 col-xs-7">
            <table class="table table-bordered view edit -search">
              <thead>
                <tr class="view edit -search">
                  <th width="1%"><span class="glyphicon glyphicon-search"></th>
                  <th about="v-s:hasCommunicationMeanChannel" property="rdfs:label"></th>
                  <th about="v-s:hasCommunicationMeanTarget" property="rdfs:label"></th>
                  <th about="v-s:description" property="rdfs:label"></th>
                  <th about="rdfs:comment" property="rdfs:label"></th>
                </tr>
              </thead>
              <tbody rel="v-s:hasCommunicationMean" data-embedded="true" data-template="v-s:CommunicationMeanTemplateEmbedded"></tbody>
            </table>
            <veda-control data-type="link" rel="v-s:hasCommunicationMean" class="-view edit -search create"></veda-control>
          </div>
        </div>
        <div class="row row-attribute">
          <div class="col-sm-3 col-xs-5">
            <label about="v-s:login" property="rdfs:label" class="view -edit -search"></label>
          </div>
          <div class="col-sm-9 col-xs-7 view -edit -search" >
            <span about="@" rel="v-s:hasAccount">
              <span about="@" property="v-s:login" ></span>
            </span>
            <button class="btn btn-xs btn-success" id="add-Account">
              <span class="glyphicon glyphicon-zoom-in"></span>
              <span  about="v-s:hasAccount" property="rdfs:label"> </span>
            </button>
          </div>
        </div>
        <div class="row row-attribute notEditForUsers">
          <div class="col-sm-3 col-xs-5">
          </div>
          <div class="col-sm-8 col-xs-6">
            <veda-control rel="@" data-type="uri" class="-view edit -search"></veda-control>
          </div>
          <div class="col-sm-1 col-xs-1 -view edit -search">
            <button id="recalculate" class="btn btn-xs btn-success">
              <span class="glyphicon glyphicon-refresh"></span>
            </button>
          </div>
        </div>
    </div>
    <div class="col-md-3">
      <div rel="v-s:hasImage">
        <div class="img-thumbnail" about="@" data-template="v-ui:ModalImageTemplate"></div>
      </div>
      <br class="-view edit search"/>
      <veda-control rel="v-s:hasImage" data-type="file" accept=".png, .jpg, .jpeg" class="-view edit -search"></veda-control>
    </div>
    
  </div>

    <div class="col-sm-12 col-xs-12"> 
      <br/>
      <hr>
    </div>
    <div about="@" data-template="v-ui:SystemPropertiesTemplate" data-embedded="true"></div>
    <br>
    <div class="actions">
      <span about="@" data-template="v-ui:StandardButtonsTemplate" data-embedded="true" data-buttons="edit save cancel"></span>
    </div>
</div>
<script>
  //нельзя редактировать пользователей ttl
  if ( individual.hasValue('rdfs:isDefinedBy') ) $(".actions #edit", template).attr('disabled', 'disabled');

  if (!individual.hasValue('v-s:birthday')) $('span[property="v-s:birthday"]').text('Не указано');

  //Блок только для админа
  if(!individual.isNew() && veda.appointment.id != 'cfg:AdministratorAppointment') 
  {
    $('.notEditForUsers').addClass('hide'); 
    $('#notNewBundle').removeClass('hide'); 
    $('.new').addClass('hide'); 
  }
 



  //Для формирования id
  function autoID() {
    if(individual.isNew()) {
      var org1 = individual["v-s:parentOrganization"][0].id;
      var org = org1.slice(6);
      var number = individual["v-s:tabNumber"];
      individual.id = "d:"+ org +"_emp_"+ number;
      individual.trigger("idChanged");
    }
  }
  $("#recalculate", template).click(autoID);
 


  $(".actions #save").on("click", function() {
    var tempCommunicationMean = individual['v-s:hasCommunicationMean'];

    individual["v-s:owner"] = [individual];
    if(tempCommunicationMean) tempCommunicationMean.map(function(CommunicationMean){
      CommunicationMean["v-s:parent"] = [individual];
      return CommunicationMean.save(); 
    });
    individual.save();
   
    
  });


    //добавить аккаунт
  $("#add-Account", template).click(function() {
    var NewAccount = new veda.IndividualModel(individual.id + "_account");
    var _class = new veda.IndividualModel('v-s:Account');
    var tmpl = new veda.IndividualModel('v-s:AccountTemplate');
    NewAccount["rdf:type"] = [_class];
    NewAccount["v-s:backwardTarget"] = [individual];
    NewAccount["v-s:backwardProperty"] = [new veda.IndividualModel("v-s:hasAccount")];
    NewAccount["v-s:owner"] = [individual];
    var modal = veda.Util.showModal(NewAccount, tmpl, "edit");
    NewAccount.one("afterSave", function () {
      individual.save();
      modal.modal("hide").remove();
    });
  });

  //добавить назначение
  $("#add-Appointment", template).click(function() {
    var NewAppointment = new veda.IndividualModel();
    var _class = new veda.IndividualModel('v-s:Appointment');
    var tmpl = new veda.IndividualModel('v-s:NewAppointmentTemplate');
    NewAppointment['rdf:type'] = [_class];
    if(individual.hasValue("v-s:hasAppointment")) NewAppointment['v-s:parentUnit'] = individual["v-s:hasAppointment"][0]['v-s:parentUnit'] ;
    else {NewAppointment['v-s:parentUnit'] = individual['v-s:parentOrganization'] ;}
    NewAppointment['v-s:parentOrganization'] = individual['v-s:parentOrganization'];
    NewAppointment['v-s:employee'] = [individual];
    var modal = veda.Util.showModal(NewAppointment, tmpl, "edit");
    NewAppointment.one("afterSave", function () {
      individual.save();
      modal.modal("hide").remove();
    });
  });

  

  //уволить сотрудника
  $("#dismissEmployee", template).click(function() {
    individual["v-s:deleted"] = [true];
    individual.save();
  });

  
  function handlerAccount(){
    if (individual.hasValue("v-s:hasAccount")) {
      $("#add-Account", template).remove();
    }
  }
  handlerAccount();

  function deletedHandler() {
    if (individual.hasValue("v-s:deleted", true)) {
      if(individual.hasValue("v-s:hasAppointment"))
      individual["v-s:hasAppointment"].forEach(function(appointment) {
        appointment.delete();
      });
    }
  }

  
  individual.on("v-s:deleted", deletedHandler);
  individual.on("v-s:hasAccount", handlerAccount);
  /*individual.on("add-Account", handler);*/
  template.one("remove", function () {
    individual.off("v-s:hasAccount", handlerAccount);
    individual.off("v-s:deleted", deletedHandler);
  });
  
  
  //# sourceURL=v-s:PersonTemplate_post
</script>
  """;
.
#-------шаблон создания ПЕРСОНЫ для админа (вложенный)
v-s:PersonEmbeddedTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Шаблон отображения персональной информации"@ru ;
  rdfs:label "Personal information template"@en ;
  v-ui:forClass v-s:Person ;
  v-ui:template """
<script>
  template.on("validate", function () {
    var result = {};
    if (!individual.hasValue('v-s:lastName')) {
      result["v-s:lastName"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    }
    if (!individual.hasValue('v-s:firstName')) {
      result["v-s:firstName"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    } 
    if (!individual.hasValue('v-s:tabNumber')) {
      result["v-s:tabNumber"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    }
    if (!individual.hasValue('v-s:parentOrganization')) {
      result["v-s:parentOrganization"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    }
    if ( individual.hasValue('v-s:lastName') && individual.hasValue('v-s:firstName') && individual.hasValue('v-s:parentOrganization') && individual.isNew()) {
      var queryString = "'rdf:type'==='v-s:Person' && 'v-s:parentOrganization'=='" + individual['v-s:parentOrganization'][0].id + "' && 'v-s:lastName'=='" + individual['v-s:lastName'][0] + "' && 'v-s:firstName'=='" + individual['v-s:firstName'][0] + "'";
      veda.Backend.query(veda.ticket, queryString).then(function (queryResult) {
        var tmp = queryResult.result;
        if (tmp.length == 0) {
          $('#warningPersonFIO').addClass('hidden'); 
        } else {
          $('#warningPersonFIO').removeClass('hidden');
        }
      });
    }
    if ( individual.hasValue('v-s:description') && individual.isNew()) {
      var queryString = "'@'=='" + individual['v-s:description'][0] + "'";
      veda.Backend.query(veda.ticket, queryString).then(function (queryResult) {
        var tmp = queryResult.result;
        if (tmp.length == 0) {
          $('#warningPersonID').addClass('hidden'); 
        } else {
          $('#warningPersonID').removeClass('hidden');
        }
      });
    }
    if ( individual.hasValue('v-s:tabNumber') && individual.isNew()) {
      var queryString = "'v-s:parentOrganization'=='" + individual['v-s:parentOrganization'][0].id +"' && 'v-s:tabNumber'=='" + individual['v-s:tabNumber'][0] + "'";
      veda.Backend.query(veda.ticket, queryString).then(function (queryResult) {
        var tmp = queryResult.result;
        if (tmp.length == 0) {
          $('#warningTN').addClass('hidden'); 
        } else {
          $('#warningTN').removeClass('hidden');
        }
      });
    }
    template.trigger("validated", result);
  });



  var canCreateSubsidiary = (new veda.IndividualModel("v-s:Subsidiary")).canCreate();
  Promise.all([canCreateSubsidiary]).then(function(results) {
    if ( !results[0] || !results[1]) {
      $("#add-subsidiary", template).remove();
    }
  });
  
  var queryString = "'rdf:type'==='v-s:Appointment' && 'v-s:employee'==='"+individual.id+"'";
  $("veda-control[rel='v-s:defaultAppointment']", template).attr("data-query-prefix", queryString);
  //$('veda-control[rel="v-s:parentUnit"]', template).attr('data-query-prefix', departmentQueryPrefix);
</script>
<div class="container sheet">
  
    <div id="warningPersonFIO" class="alert alert-warning hidden">
      <span>Внимание. Пользователь с такими ФИО уже существует в данной организации. Возможно Вам следует выбрать его.</span>
    </div>
    <div id="warningPersonID" class="alert alert-danger hidden">
      <span>Внимание. Такой ID уже существует.</span>
    </div>
    <div id="warningTN" class="alert alert-danger hidden">
      <span>Внимание. Такой табельный номер уже существует.</span>
    </div>
    <div class="row row-attribute">
      <div class="col-sm-3 col-xs-5">
        <label about="v-s:lastName" property="rdfs:label"></label>
      </div>
      <div class="col-sm-9 col-xs-7">
        <veda-control property="v-s:lastName" data-type="multilingualString" class="-view edit search"></veda-control>
      </div>
    </div>
    <div class="row row-attribute">
      <div class="col-sm-3 col-xs-5">
        <label about="v-s:firstName" property="rdfs:label"></label>
      </div>
      <div class="col-sm-9 col-xs-7">
        <veda-control property="v-s:firstName" data-type="multilingualString" class="-view edit search"></veda-control>
      </div>
    </div>
    <div class="row row-attribute">
      <div class="col-sm-3 col-xs-5">
        <label about="v-s:middleName" property="rdfs:label"></label>
      </div>
      <div class="col-sm-9 col-xs-7">
        <veda-control property="v-s:middleName" data-type="multilingualString" class="-view edit search"></veda-control>
      </div>
    </div>
    <div class="row row-attribute">
      <div class="col-sm-3 col-xs-5">
        <label about="v-s:birthday" property="rdfs:label"></label>
      </div>
      <div class="col-sm-3 col-xs-3">
        <span class="view -edit -search" about="@" property="v-s:birthday"></span>
        <veda-control property="v-s:birthday" data-type="date" class="-view edit search"></veda-control>
      </div>
    </div>
    <div class="row row-attribute">
      <div class="col-sm-3 col-xs-5">
        <label about="v-s:tabNumber" property="rdfs:label"></label>
      </div>
      <div class="col-sm-3 col-xs-3">
        <span class="view -edit -search" about="@" property="v-s:tabNumber"></span>
            <veda-control property="v-s:tabNumber" data-type="string" class="-view edit search"></veda-control>
      </div>
    </div>
    <div class="row row-attribute">
      <div class="col-sm-3 col-xs-5">
        <label about="v-s:description" property="rdfs:label"></label>
      </div>
      <div class="col-sm-9 col-xs-7">
        <div property="v-s:description" class="view -edit search"></div>
        <veda-control property="v-s:description" data-type="string" class="-view edit search"></veda-control>
      </div>
    </div>
    <div class="row row-attribute">
      <div class="col-sm-3 col-xs-5">
        <label about="v-s:hasCommunicationMean" property="rdfs:label"></label>
      </div>
      <div class="col-sm-9 col-xs-7">
        <span class="view -edit -search" about="@" property="v-s:tabNumber"></span>
          <table class="table table-bordered">
            <thead>
              <tr class="view edit -search">
                <th width="1%"><span class="glyphicon glyphicon-search"></th>
                <th about="v-s:hasCommunicationMeanChannel" property="rdfs:label"></th>
                <th about="v-s:hasCommunicationMeanTarget" property="rdfs:label"></th>
                <th about="v-s:description" property="rdfs:label"></th>
                <th about="rdfs:comment" property="rdfs:label"></th>
              </tr>
            </thead>
            <tbody rel="v-s:hasCommunicationMean" data-embedded="true" data-template="v-s:CommunicationMeanTemplateEmbedded"></tbody>
          </table>
          <veda-control data-type="link" rel="v-s:hasCommunicationMean" class="-view edit -search create"></veda-control>
      </div>
    </div>
    <section id="Account">
      <h4 class="section-header -view edit search">
        <span about="v-s:Account" property="rdfs:label"></span>
        <div class="btn-group -view edit -search"></div>
        <veda-control data-type="link" rel="v-s:hasAccount" class="-view edit -search create pull-right"></veda-control>
      </h4>
      <div rel="v-s:hasAccount" data-embedded="true" data-template="v-s:AccountEmbeddedTemplate"></div>
    </section>
   
</div>
<script>

  function autoID() {
    var org1 = individual["v-s:parentOrganization"][0].id;
    var org = org1.slice(6);
    var number = individual["v-s:tabNumber"];
    individual["v-s:description"] = ["d:"+ org +"_emp_"+ number];
  }
  individual.on("v-s:tabNumber", autoID);
  template.one("remove", function () {
    individual.off("v-s:tabNumber", autoID);
  });





  if ( individual.hasValue('rdfs:isDefinedBy') ) {
    $(".actions #edit", template).attr('disabled', 'disabled');
  }
  if (!individual.hasValue('v-s:birthday')) {
    $('span[property="v-s:birthday"]').text('Не указано');
  }
  
  //# sourceURL=v-s:PersonEmbeddedTemplate_post
</script>
  """;
.
#-------шаблон создания Должности для админа
v-s:PositionTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Шаблон для класса v-s:Position при создании v-s:Appoinment"@ru ;
  rdfs:label "Template for v-s:Position to create v-s:Appointment class"@en ;
  v-ui:template """
<script>
  template.on("validate", function () {
    var result = {};
    if (!individual.hasValue('v-s:subjectCode')) {
      result["v-s:subjectCode"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    }
    if (!individual.hasValue('rdfs:label')) {
      result["rdfs:label"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    } 
    if (!individual.hasValue('v-s:parentOrganization')) {
      result["v-s:parentOrganization"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    }
    if (!individual.hasValue('v-s:parentUnit')) {
      result["v-s:parentUnit"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    }
    if (!individual.hasValue('v-s:origin')) {
      result["v-s:origin"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    }
    if( individual.hasValue('rdfs:label') && individual.hasValue('v-s:parentOrganization') && individual.isNew())  {
      var queryString = "'rdf:type'==='v-s:Position' && 'v-s:parentUnit'=='" + individual['v-s:parentUnit'][0].id + "' && 'rdfs:label'=='" + individual['rdfs:label'][0] + "'";
      veda.Backend.query(veda.ticket, queryString).then(function (queryResult) {
        var tmp = queryResult.result;
        if (tmp.length == 0) {
          $('#warningOccupationName').addClass('hide');
        } else {
          $('#warningOccupationName').removeClass('hide');
        }
      });
    }
    if( individual.hasValue('v-s:subjectCode') && individual.hasValue('v-s:parentOrganization') && individual.isNew())  {
      var queryString = "'rdf:type'==='v-s:Position' && 'v-s:parentOrganization'=='" + individual['v-s:parentOrganization'][0].id + "' && 'v-s:subjectCode'=='" + individual['v-s:subjectCode'][0] + "'";
      veda.Backend.query(veda.ticket, queryString).then(function (queryResult) {
        var tmp = queryResult.result;
        if (tmp.length == 0) {
          $('#warningOccupationSubCode').addClass('hide');
        } else {
          $('#warningOccupationSubCode').removeClass('hide');
        }
      });
    }
    template.trigger("validated", result);
  });
</script>
<div>
  <div class="container sheet">
    <h2>
      <span about="v-s:Position" property="rdfs:label"></span>
      <small about="@" property="rdfs:label"></small>
    </h2>
    <hr>
    <div id="warningOccupationName" class="alert alert-warning hide">
      <span>Внимание. Должность с похожим названием уже существует в данной организации. Возможно Вам следует использовать ее.</span>
    </div>
    <div id="warningOccupationSubCode" class="alert alert-danger hide">
      <span>Внимание. Должность с таким кодом уже существует в данной организации. </span>
    </div>
    <div class="row row-attribute">
      <div class="col-sm-3 col-xs-5">
        <label about="v-s:Organization" property="rdfs:label"></label>
      </div>
      <div class="col-sm-9 col-xs-7">
        <div about="@" rel="v-s:parentOrganization" class="view edit search" data-template="v-ui:LabelLinkTemplate"></div>
        <veda-control rel="v-s:parentOrganization" data-query-prefix = "'rdf:type'=='v-s:Organization'" data-type="link" class="-view edit search fulltext dropdown notEditForUsers"></veda-control>
      </div>
    </div>
    <div class="row row-attribute">
      <div class="col-sm-3 col-xs-5">
        <label about="v-s:Department" property="rdfs:label"></label>
      </div>
      <div class="col-sm-9 col-xs-7">
        <div about="@" rel="v-s:parentUnit" class="view edit search" data-template="v-ui:LabelLinkTemplate"></div>
        <veda-control rel="v-s:parentUnit" data-query-prefix = "('rdf:type'=='v-s:Department' && 'v-s:parentOrganization'=='{individual['v-s:parentOrganization'][0].id}') || '@'=='{individual['v-s:parentOrganization'][0].id}'" data-type="link" class="-view edit search fulltext dropdown notEditForUsers"></veda-control>
      </div>
    </div>
    <div class="row row-attribute">
      <div class="col-sm-3 col-xs-5">
        <label about="v-s:title" property="rdfs:label"></label>
      </div>
      <div class="col-sm-9 col-xs-7">
        <div property="rdfs:label" class="view -edit -search"></div>
        <veda-control data-type="multilingualText" property="rdfs:label" class="-view edit search"></veda-control>
      </div>
    </div>
    <div class="row row-attribute">
      <div class="col-sm-3 col-xs-5">
        <label about="v-s:PositionCode" property="rdfs:label"></label>
      </div>
      <div class="col-sm-9 col-xs-7">
        <div property="v-s:subjectCode" class="view -edit -search"></div>
        <veda-control data-type="string" property="v-s:subjectCode" class="-view edit search"></veda-control>
      </div>
    </div>
    <div class="row row-attribute notEditForUsers">
      <div class="col-sm-3 col-xs-5">
        <label about="v-s:origin" property="rdfs:label"></label>
      </div>
      <div class="col-sm-9 col-xs-7">
        <div property="v-s:origin" class="view -edit -search"></div>
        <veda-control property="v-s:origin" data-type="string" class="-view edit search"></veda-control>
      </div>
    </div>
    <div class="row row-attribute notEditForUsers">
      <div class="col-sm-3 col-xs-5">
      </div>
      <div class="col-sm-8 col-xs-6">
        <veda-control rel="@" data-type="uri" class="-view edit search"></veda-control>
      </div>
      <div class="col-sm-1 col-xs-1 -view edit -search">
        <button id="recalculate" class="btn btn-xs btn-success" >
          <span class="glyphicon glyphicon-refresh"></span>
        </button>
      </div>
    </div>
    <hr>
    <br>
    <!--Системные свойства-->
    <div about="@" data-template="v-ui:SystemPropertiesTemplate" data-embedded="true"></div>
    <br>
    <!-- BUTTONS -->
    <div class="actions view edit -search">
      <span about="@" data-template="v-ui:StandardButtonsTemplate" data-embedded="true" data-buttons="edit save cancel delete"></span>
    </div> 
  </div>
</div>
<script>
  if(!individual.isNew() && veda.appointment.id != 'cfg:AdministratorAppointment')
    $('.notEditForUsers').addClass('hide'); 
  
  function autoID() {
    var org1 = individual["v-s:parentOrganization"][0].id;
    var org = org1.slice(6);
    var number = individual["v-s:subjectCode"];
    individual.id = "d:"+ org +"_pos_"+ number;
    individual.trigger("idChanged");
  }
  $("#recalculate", template).click(autoID);
 


  //# sourceURL=v-s:PositionTemplate_post
</script>
  """ ;
.

v-s:PositionMinimalTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Шаблон для класса v-s:Position "@ru ;
  rdfs:label "Template for v-s:Position"@en ;
  v-ui:template """
<script>
  template.on("validate", function () {
    var result = {};
    if (!individual.hasValue('v-s:subjectCode')) {
      result["v-s:subjectCode"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    }
    if (!individual.hasValue('rdfs:label')) {
      result["rdfs:label"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    } 
    if (!individual.hasValue('v-s:parentOrganization')) {
      result["v-s:parentOrganization"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    }
    if (!individual.hasValue('v-s:parentUnit')) {
      result["v-s:parentUnit"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    }
    /*if( individual.hasValue('rdfs:label') && individual.hasValue('v-s:parentOrganization') && individual.isNew())  {
      var queryString = "'rdf:type'==='v-s:Position' && 'v-s:parentUnit'=='" + individual['v-s:parentUnit'][0].id + "' && 'rdfs:label'=='" + individual['rdfs:label'][0] + "'";
      veda.Backend.query(veda.ticket, queryString).then(function (queryResult) {
        var tmp = queryResult.result;
        if (tmp.length == 0) {
          $('#warningOccupationName').addClass('hide');
        } else {
          $('#warningOccupationName').removeClass('hide');
        }
      });
    }
    if( individual.hasValue('v-s:subjectCode') && individual.hasValue('v-s:parentOrganization') && individual.isNew())  {
      var queryString = "'rdf:type'==='v-s:Position' && 'v-s:parentOrganization'=='" + individual['v-s:parentOrganization'][0].id + "' && 'v-s:subjectCode'=='" + individual['v-s:subjectCode'][0] + "'";
      veda.Backend.query(veda.ticket, queryString).then(function (queryResult) {
        var tmp = queryResult.result;
        if (tmp.length == 0) {
          $('#warningOccupationSubCode').addClass('hide');
        } else {
          $('#warningOccupationSubCode').removeClass('hide');
        }
      });
    }*/
    template.trigger("validated", result);
  });
</script>
<div>
  <div class="container sheet">
    <h2>
      <span about="v-s:Position" property="rdfs:label"></span>
      <small about="@" property="rdfs:label"></small>
    </h2>
    <div class="alert alert-warning">
      <span>Внимание! Если несколько сотрудников занимают данную должность, то они все будут переведены в другой отдел.</span>
    </div>
    <hr>
    <div class="row row-attribute">
      <div class="col-sm-3 col-xs-5">
        <label about="v-s:Organization" property="rdfs:label"></label>
      </div>
      <div class="col-sm-9 col-xs-7">
        <div about="@" rel="v-s:parentOrganization" class="view edit search" data-template="v-ui:LabelLinkTemplate"></div>
        <!--<veda-control rel="v-s:parentOrganization" data-query-prefix = "'rdf:type'=='v-s:Organization'" data-type="link" class="-view edit search fulltext dropdown notEditForUsers"></veda-control>-->
      </div>
    </div>
    <div class="row row-attribute">
      <div class="col-sm-3 col-xs-5">
        <label about="v-s:Department" property="rdfs:label"></label>
      </div>
      <div class="col-sm-9 col-xs-7">
        <div about="@" rel="v-s:parentUnit" class="view edit search" data-template="v-ui:LabelLinkTemplate"></div>
        <veda-control rel="v-s:parentUnit" data-query-prefix = "('rdf:type'=='v-s:Department' && 'v-s:parentOrganization'=='{individual['v-s:parentOrganization'][0].id}') || '@'=='{individual['v-s:parentOrganization'][0].id}'" data-type="link" class="-view edit search fulltext dropdown notEditForUsers"></veda-control>
      </div>
    </div>
    <div class="row row-attribute">
      <div class="col-sm-3 col-xs-5">
        <label about="v-s:title" property="rdfs:label"></label>
      </div>
      <div class="col-sm-9 col-xs-7">
        <div property="rdfs:label" class="view -edit -search"></div>
        <veda-control data-type="multilingualText" property="rdfs:label" class="-view edit search"></veda-control>
      </div>
    </div>
    <div class="row row-attribute">
      <div class="col-sm-3 col-xs-5">
        <label about="v-s:PositionCode" property="rdfs:label"></label>
      </div>
      <div class="col-sm-9 col-xs-7">
        <div property="v-s:subjectCode" class="view -edit -search"></div>
        <!--<veda-control data-type="string" property="v-s:subjectCode" class="-view edit search"></veda-control>-->
      </div>
    </div>
    <hr>
    <br>
    <!--Системные свойства-->
    <div about="@" data-template="v-ui:SystemPropertiesTemplate" data-embedded="true"></div>
    <br>
    <!-- BUTTONS -->
    <div class="actions view edit -search">
      <span about="@" data-template="v-ui:StandardButtonsTemplate" data-embedded="true" data-buttons="edit save cancel delete"></span>
    </div> 
  </div>
</div>
<script>

  //# sourceURL=v-s:PositionMinimalTemplate_post
</script>
  """ ;
.

#-------шаблон создания Должности для админа
v-s:PositionEmbeddedTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Шаблон для класса v-s:Position при создании v-s:Appoinment"@ru ;
  rdfs:label "Template for v-s:Position to create v-s:Appointment class"@en ;
  v-ui:template """
<script>
  template.on("validate", function () {
    var result = {};
    if (!individual.hasValue('v-s:subjectCode')) {
      result["v-s:subjectCode"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    }
    if (!individual.hasValue('rdfs:label')) {
      result["rdfs:label"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    } 
    if (!individual.hasValue('v-s:parentOrganization')) {
      result["v-s:parentOrganization"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    }
    if (!individual.hasValue('v-s:parentUnit')) {
      result["v-s:parentUnit"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    }
    if( individual.hasValue('rdfs:label') && individual.hasValue('v-s:parentUnit') && individual.isNew())  {
      var queryString = "'rdf:type'==='v-s:Position' && 'v-s:parentUnit'=='" + individual['v-s:parentUnit'][0].id + "' && 'rdfs:label'=='" + individual['rdfs:label'][0] + "'";
      veda.Backend.query(veda.ticket, queryString).then(function (queryResult) {
        var tmp = queryResult.result;
        if (tmp.length == 0) {
          $('#warningOccupationName').addClass('hide');
        } else {
          $('#warningOccupationName').removeClass('hide');
        }
      });
    }
    if ( individual.hasValue('v-s:description')) {
      var queryString = "'@'=='" + individual['v-s:description'][0] + "'";
      veda.Backend.query(veda.ticket, queryString).then(function (queryResult) {
        var tmp = queryResult.result;
        if (tmp.length == 0) {
          $('#warningID').addClass('hide'); 
        } else {
          $('#warningID').removeClass('hide');
        }
      });
    }
    if ( individual.hasValue('v-s:subjectCode')) {
      var queryString = "'rdf:type'==='v-s:Position' && 'v-s:parentOrganization'=='" + individual['v-s:parentOrganization'][0].id + "' && 'v-s:subjectCode'=='" + individual['v-s:subjectCode'][0] + "'";
      veda.Backend.query(veda.ticket, queryString).then(function (queryResult) {
        var tmp = queryResult.result;
        if (tmp.length == 0) {
          $('#warningOccupationSubCode').addClass('hide'); 
        } else {
          $('#warningOccupationSubCode').removeClass('hide');
        }
      });
    }
    template.trigger("validated", result);
  });
</script>
<div>
  <div class="container sheet">
    <div id="warningOccupationName" class="alert alert-warning hide">
      <span>Внимание. Должность с похожим названием уже существует в данной организации. Возможно Вам следует использовать ее.</span>
    </div>
    <div id="warningOccupationSubCode" class="alert alert-danger hide">
      <span>Внимание. Должность с таким кодом уже существует в данной организации. </span>
    </div>
    <div id="warningID" class="alert alert-danger hide">
      <span>Внимание. Должность с таким ID уже существует в данной организации. </span>
    </div>
    <div class="row row-attribute">
      <div class="col-sm-3 col-xs-5">
        <label about="v-s:title" property="rdfs:label"></label>
      </div>
      <div class="col-sm-9 col-xs-7">
        <div property="rdfs:label" class="view -edit -search"></div>
        <veda-control data-type="multilingualText" property="rdfs:label" class="-view edit search"></veda-control>
      </div>
    </div>
    <div class="row row-attribute">
      <div class="col-sm-3 col-xs-5">
        <label about="v-s:PositionCode" property="rdfs:label"></label>
      </div>
      <div class="col-sm-3 col-xs-3">
        <div property="v-s:subjectCode" class="view -edit -search"></div>
        <veda-control data-type="string" property="v-s:subjectCode" class="-view edit search"></veda-control>
      </div>
    </div>
    <div class="row row-attribute">
      <div class="col-sm-3 col-xs-5">
        <label about="v-s:description" property="rdfs:label"></label>
      </div>
      <div class="col-sm-9 col-xs-7">
        <div property="v-s:description" class="view -edit search"></div>
        <veda-control property="v-s:description" data-type="string" class="-view edit search"></veda-control>
      </div>
    </div>
  </div>
</div>
<script>
  function autoID() {
    var org1 = individual["v-s:parentOrganization"][0].id;
    var org = org1.slice(6);
    var number = individual["v-s:subjectCode"];
    individual["v-s:description"] = ["d:"+ org +"_pos_"+ number];
  }
  individual.on("v-s:subjectCode", autoID);
  individual.on("v-s:parentOrganization", autoID);
  template.one("remove", function () {
    individual.off("v-s:subjectCode", autoID);
    individual.off("v-s:parentOrganization", autoID);
  });


  //# sourceURL=v-s:PositionEmbeddedTemplate
</script>
  """ ;
.


v-s:TS_Account 
  rdf:type v-ui:TemplateSpecification;
  v-s:loadPriority "15"^^xsd:integer;
  v-ui:defaultTemplate v-s:AccountTemplate;
  v-ui:forClass v-s:Account
.
v-s:AccountTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Шаблон для класса v-s:Account при создании v-s:Person"@ru ;
  rdfs:label "Template for v-s:Accountn to create v-s:Person class"@en ;
  v-ui:template """
<script>
  template.on("validate", function () {
    var result = {};
    if (!individual.hasValue('v-s:login')) {
      result["v-s:login"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    }
    if (!individual.hasValue('v-s:mailbox')) {
      result["v-s:mailbox"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    }
    if (!individual.hasValue('v-s:origin')) {
      result["v-s:origin"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    } 
    if (!individual.hasValue('v-s:authOrigin')) {
      result["v-s:authOrigin"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    }

    if( individual.hasValue('v-s:login'))  {
      var queryString = "'rdf:type'==='v-s:Account'" + " && 'v-s:login'=='" + individual['v-s:login'][0] + "'";
      veda.Backend.query(veda.ticket, queryString).then(function (queryResult) {
        var tmp = queryResult.result;
        if (tmp.length == 0) {
          $('#warningAccount').addClass('hide');
        } else {
          $('#warningAccount').removeClass('hide');
        }
      });
    }
    template.trigger("validated", result);
  });
</script>
<div>
  <div class="container sheet">
    <div id="warningAccount" class="alert alert-warning hide">
      <span>Внимание. Аккаунтс таким логином уже существует!!!</span>
    </div>
    <h2>
      <span about="v-s:Account" property="rdfs:label"></span>
      <small about="@" property="rdfs:label"></small>
    </h2>
    <hr>
    <div class="row row-attribute">
      <div class="col-sm-3 col-xs-5">
        <label about="rdfs:label" property="rdfs:label"></label>
      </div>
      <div class="col-sm-9 col-xs-7">
        <div property="rdfs:label" class="view -edit -search"></div>
        <veda-control data-type="multilingualString" property="rdfs:label" class="-view edit search"></veda-control>
      </div>
    </div>
    <div class="row row-attribute">
      <div class="col-sm-3 col-xs-5">
        <label about="v-s:login" property="rdfs:label"></label>
      </div>
      <div class="col-sm-9 col-xs-7">
        <div property="v-s:login" class="view -edit -search"></div>
        <veda-control data-type="string" property="v-s:login" class="-view edit search"></veda-control>
      </div>
    </div>
    <div class="row row-attribute">
      <div class="col-sm-3 col-xs-5">
        <label about="v-s:mailbox" property="rdfs:label"></label>
      </div>
      <div class="col-sm-9 col-xs-7">
        <div property="v-s:mailbox" class="view -edit -search"></div>
        <veda-control data-type="string" property="v-s:mailbox" class="-view edit search"></veda-control>
      </div>
    </div>
    <div class="row row-attribute">
      <div class="col-sm-3 col-xs-5">
        <label about="v-s:origin" property="rdfs:label"></label>
      </div>
      <div class="col-sm-9 col-xs-7">
        <div property="v-s:origin" class="view -edit -search"></div>
        <veda-control data-type="string" property="v-s:origin" class="-view edit search"></veda-control>
      </div>
    </div>
    <div class="row row-attribute">
      <div class="col-sm-3 col-xs-5">
        <label about="v-s:authOrigin" property="rdfs:label"></label>
      </div>
      <div class="col-sm-9 col-xs-7">
        <div property="v-s:authOrigin" class="view -edit -search"></div>
        <veda-control data-type="string" property="v-s:authOrigin" class="-view edit search"></veda-control>
      </div>
    </div>
    <hr>
    <!--Системные свойства-->
    <div about="@" data-template="v-ui:SystemPropertiesTemplate" data-embedded="true"></div>
    <br>
    <!-- BUTTONS -->
    <div class="actions view edit -search">
      <span about="@" data-template="v-ui:StandardButtonsTemplate" data-embedded="true" data-buttons="edit save cancel delete"></span>
    </div> 
  </div>
</div>
<script>

  if(mode === "edit" && individual.isNew()){
    individual["v-s:authOrigin"]=["veda"];
  }

  //# sourceURL=v-s:AccountTemplate_post
</script>
  """ ;
.

v-s:AccountEmbeddedTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Шаблон для класса v-s:Account при создании v-s:Person"@ru ;
  rdfs:label "Template for v-s:Accountn to create v-s:Person class"@en ;
  v-ui:template """
<script>
  template.on("validate", function () {
    var result = {};
    if (!individual.hasValue('v-s:login')) {
      result["v-s:login"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    }
    if (!individual.hasValue('v-s:mailbox')) {
      result["v-s:mailbox"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    }
    if (!individual.hasValue('v-s:origin')) {
      result["v-s:origin"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    } 
    if (!individual.hasValue('v-s:authOrigin')) {
      result["v-s:authOrigin"] = {
        state: false,
        cause: ["v-ui:minCardinality"]
      };
    }
    
   if ( individual.hasValue('v-s:login')) {
      var queryString = "'rdf:type'=='v-s:Account' && 'v-s:login'=='" + individual["v-s:login"][0] + "'";
      veda.Backend.query(veda.ticket, queryString).then(function (queryResult) {
        var tmp = queryResult.result;
        if (tmp.length == 0) {
          $('#warningAccount').addClass('hide'); 
        } else {
          $('#warningAccount').removeClass('hide');
        }
      });
    }
    template.trigger("validated", result);
  });
   //# sourceURL=v-s:AccountEmbeddedTemplate_pre
</script>
<div>
  <div class="container sheet">
    <div id="warningAccount" class="alert alert-danger hide">
      <span>Внимание. Аккаунт с таким логином уже существует!!!</span>
    </div>
    <div class="row row-attribute">
      <div class="col-sm-3 col-xs-5">
        <label about="rdfs:label" property="rdfs:label"></label>
      </div>
      <div class="col-sm-9 col-xs-7">
        <div property="rdfs:label" class="view -edit -search"></div>
        <veda-control data-type="multilingualString" property="rdfs:label" class="-view edit search"></veda-control>
      </div>
    </div>
    <div class="row row-attribute">
      <div class="col-sm-3 col-xs-5">
        <label about="v-s:login" property="rdfs:label"></label>
      </div>
      <div class="col-sm-9 col-xs-7">
        <div property="v-s:login" class="view -edit -search"></div>
        <veda-control data-type="string" property="v-s:login" class="-view edit search"></veda-control>
      </div>
    </div>
    <div class="row row-attribute">
      <div class="col-sm-3 col-xs-5">
        <label about="v-s:mailbox" property="rdfs:label"></label>
      </div>
      <div class="col-sm-9 col-xs-7">
        <div property="v-s:mailbox" class="view -edit -search"></div>
        <veda-control data-type="string" property="v-s:mailbox" class="-view edit search"></veda-control>
      </div>
    </div>
    <div class="row row-attribute">
      <div class="col-sm-3 col-xs-5">
        <label about="v-s:authOrigin" property="rdfs:label"></label>
      </div>
      <div class="col-sm-9 col-xs-7">
        <div property="v-s:authOrigin" class="view -edit -search"></div>
        <veda-control data-type="string" property="v-s:authOrigin" class="-view edit search"></veda-control>
      </div>
    </div>
  </div>
</div>
<script>

  if(mode === "edit" && individual.isNew()){
    individual["v-s:authOrigin"]=["veda"];
  }

 

  //# sourceURL=v-s:AccountEmbeddedTemplate_post
</script>
  """ ;
.
v-s:AppointmentEmbeddedTableTemplate
  rdf:type v-ui:ClassTemplate ;
  v-ui:forClass v-s:Appointment ;
  rdfs:label "Шаблон для класса v-s:CommunicationMean"@ru ;
  rdfs:label "Template for v-s:CommunicationMean class"@en ;
  v-ui:template """
<script>
  var canUpdateAppointment = individual.canUpdate();
  Promise.all([canUpdateAppointment]).then(function(results) {
    if ( !results[0]) {
      $("#deleteAppointment", template).remove();
      $("#moveToAnotherDepartment", template).remove();
    }
  })
</script>
<tr>
  <td about="@" data-template="v-ui:IconModalTemplate" class="view -edit -search"></td>
  <td>
    <div about="@" property="rdfs:label" class="view edit -search"></div>
  </td>
  <td>
    <div about="@" property="v-s:dateFrom" class="view -edit -search"></div>
    <veda-control property="v-s:dateFrom" data-type="date" class="-view edit search"></veda-control>
  </td>
  <td>
    <div about="@" property="v-s:dateTo" class="view -edit -search"></div>
    <veda-control property="v-s:dateTo" data-type="date" class="-view edit search"></veda-control>
  </td>
  <td class="view -edit -search">
    <button class="btn btn-xs btn-success" id="moveToAnotherDepartment">
      <span  about="v-s:AnotherDepartmentBundle" property="rdfs:label"> </span>
    </button>
  </td>
  <td class="view -edit -search">
    <button class="btn btn-xs btn-danger" id="deleteAppointment">
      <span  about="v-s:DeleteAppointmentBundle" property="rdfs:label"> </span>
    </button>
  </td>
 </tr>
<script>
  //нельзя удалить назначение по умолчанию
  individual.getPropertyChain("v-s:employee","v-s:defaultAppointment").then(function (defaultAppointment) {
    if(individual == defaultAppointment[0] ) $("#deleteAppointment", template).attr('disabled', 'disabled');
  });

  $("#deleteAppointment", template).click(function() {
    individual["v-s:deleted"] = [true];
    individual.save();
    });


  $("#moveToAnotherDepartment", template).click(function() {
    var current_occupation = individual['v-s:occupation'][0].id;    
    var Occupation = new veda.IndividualModel(current_occupation);
    var tmpl = new veda.IndividualModel('v-s:PositionMinimalTemplate');
    var modal = veda.Util.showModal(Occupation, tmpl, "edit");
    Occupation.one("afterSave", function () {
      individual.save();
      modal.modal("hide").remove();
    });
  });
  

</script>
  """ ;
.
